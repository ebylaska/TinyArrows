Kekule.AbstractConfigs=Class.create(ObjectEx,{CLASS_NAME:"Kekule.AbstractConfigs",CONFIG_PROP_FLAG:"__$config_prop__",initialize:function($super,a){$super();if(typeof(a)=="undefined"){a=true}if(a){this.initPropDefValues()}},addConfigProp:function(e,c,b,f){var d={dataType:c};if(f){d=Object.extend(d,f)}if(typeof(b)!="undefined"){d.defaultValue=b}var a=this.defineProp(e,d);a[this.CONFIG_PROP_FLAG]=true;return a},addHashConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.HASH,a,c)},addStrConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.STRING,a,c)},addNumConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.NUM,a,c)},addIntConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.INT,a,c)},addFloatConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.FLOAT,a,c)},addBoolConfigProp:function(b,a,c){return this.addConfigProp(b,DataType.BOOL,a,c)},initPropDefValues:function(){this.beginUpdate();try{var c=this.getAllPropList();for(var b=0,a=c.getLength();b<a;++b){var f=c.getPropInfoAt(b);var e=f.name;var d=f.defaultValue;if(typeof(d)!="undefined"){this.setPropValue(e,d)}}}finally{this.endUpdate()}},assign:function(a){a.copyPropsTo(this)},toHash:function(){var b={};var a=this.CONFIG_PROP_FLAG;this.saveObj(b,"json",{saveDefaultValues:true,propFilter:function(d,c){return d[a]}});return b}});Kekule.ConfigPresetMap=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ConfigPresetMap",initialize:function($super){$super();this.map=new Kekule.MapEx(true)},doFinalize:function($super){this.map=null;$super()},set:function(a,b){this.map.set(a,b)},get:function(a){return this.map.get(a)},getHash:function(a){var b=this.get(a);if(b){if(b.toHash){return b.toHash()}else{return b}}else{return null}},remove:function(a){this.map.remove(a)},has:function(a){return this.map.has(a)},clear:function(){this.map.clear()}});Kekule.ElementSeries={NONMETAL:"Nonmetals",METAL:"Metals",ALKALI_METAL:"Alkali Metals",ALKALI_EARTH_METAL:"Alkali Earth Metals",TRANSITION_METAL:"Transition Metals",METALLOID:"Metalloids",HALOGEN:"Halogens",NOBLE_GAS:"Noble Gases",LANTHANIDE:"Lanthanides",ACTINIDE:"Actinides"};Kekule.Element=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Element",initialize:function($super,a){$super();if(a!=Kekule.Element.UNSET_ELEMENT){var b=this.getElementInfo(a);if(b){this.setPropStoreFieldValue("symbol",b.symbol);this.setPropStoreFieldValue("atomicNumber",b.atomicNumber);this.setPropStoreFieldValue("group",b.group);this.setPropStoreFieldValue("period",b.period);this.setPropStoreFieldValue("series",b.chemicalSerie);this.setPropStoreFieldValue("naturalMass",b.naturalMass);if(b.name){this.setPropStoreFieldValue("name",b.name)}}else{Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.INVALID_CHEMELEMENT")+": "+a:"Invalid chemical element: "+a)}}else{this.setPropStoreFieldValue("symbol",Kekule.Element.UNSET_ELEMENT);this.setPropStoreFieldValue("atomicNumber",Kekule.Element.UNSET_ELEMENT)}},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING,serializable:false,setter:null});this.defineProp("atomicNumber",{dataType:DataType.INT,serializable:false,setter:null});this.defineProp("symbol",{dataType:DataType.STRING,serializable:false,setter:null});this.defineProp("group",{dataType:DataType.INT,serializable:false,setter:null});this.defineProp("period",{dataType:DataType.INT,serializable:false,setter:null});this.defineProp("series",{dataType:DataType.STRING,serializable:false,setter:null});this.defineProp("naturalMass",{dataType:DataType.FLOAT,serializable:false,setter:null})},getElementInfo:function(a){if(a==Kekule.Element.UNSET_ELEMENT){return{symbol:Kekule.Element.UNSET_ELEMENT,atomicNumber:Kekule.Element.UNSET_ELEMENT}}if(Kekule.Element.isDummyElement(a)){return{symbol:Kekule.Element.DUMMY_ELEMENT,atomicNumber:Kekule.Element.DUMMY_ELEMENT_ATOMICNUM}}else{if(Kekule.Element.isRGroup(a)){return{symbol:Kekule.Element.RGROUP_ELEMENT,atomicNumber:Kekule.Element.RGROUP_ELEMENT_ATMOICNUM}}else{return Kekule.ChemicalElementsDataUtil.getElementInfo(a)}}},getTheoreticValence:function(){if(this.getGroup()){return Kekule.Element.getTheoreticValenceOfGroup(this.getGroup())}else{return null}},isDummyElement:function(){return this.getAtomicNumber()==Kekule.Element.DUMMY_ELEMENT_ATOMICNUM},isRGroupElement:function(){return this.getAtomicNumber()==Kekule.Element.RGROUP_ELEMENT_ATMOICNUM},isNormalElement:function(){return Kekule.Element.isNormalElement(this.getAtomicNumber())},isSameElement:function(a){if(a==Kekule.Element.UNSET_ELEMENT){return this.getAtomicNumber()==Kekule.Element.UNSET_ELEMENT}else{if(typeof(a)=="number"){return this.getAtomicNumber()==a}else{return this.getSymbol()==a}}},isHetero:function(){return((this.getSeries()===Kekule.ElementSeries.NONMETAL)||(this.getSeries()===Kekule.ElementSeries.HALOGEN))&&(this.getAtomicNumber()!==6)&&(this.getAtomicNumber()!==1)},getLabel:function(){return this.getSymbol()}});Object.extend(Kekule.Element,Kekule.ChemicalElementsDataUtil);Kekule.Element.UNSET_ELEMENT=undefined;Kekule.Element.DUMMY_ELEMENT="DU";Kekule.Element.DUMMY_ELEMENT_ATOMICNUM=-1;Kekule.Element.RGROUP_ELEMENT="R";Kekule.Element.RGROUP_ELEMENT_ATOMICNUM=-2;Kekule.Element.DEUTERIUM="D";Kekule.Element.isNormalElement=function(a){return(a!=Kekule.Element.UNSET_ELEMENT)&&(!Kekule.Element.isPseudoElement(a))};Kekule.Element.isPseudoElement=function(a){if(typeof(a)=="string"){return(a==Kekule.Element.DUMMY_ELEMENT)||(a==Kekule.Element.RGROUP_ELEMENT)}else{return(a==Kekule.Element.DUMMY_ELEMENT_ATOMICNUM)||(a==Kekule.Element.RGROUP_ELEMENT_ATMOICNUM)}};Kekule.Element.isDummyElement=function(a){return(a===Kekule.Element.DUMMY_ELEMENT)||(a===Kekule.Element.DUMMY_ELEMENT_ATOMICNUM)};Kekule.Element.isRGroup=function(a){return(a===Kekule.Element.RGROUP_ELEMENT)||(a===Kekule.Element.RGROUP_ELEMENT_ATOMICNUM)};Kekule.Element.getTheoreticValenceOfGroup=function(a){if(a<=2){return a}else{if(a<=12){return null}else{if(a<=17){return a-10}else{return 0}}}};Kekule.Element.getTheoreticValence=function(a){var b=Kekule.ChemicalElementsDataUtil.getElementInfo(a);return b.group?Kekule.Element.getTheoreticValenceOfGroup(b.group):null};Object.extend(Kekule.Element,{isAtomicNumberAvailable:function(a){return Kekule.ChemicalElementsDataUtil.isAtomicNumberAvailable(a)},isElementSymbolAvailable:function(a){return Kekule.ChemicalElementsDataUtil.isElementSymbolAvailable(a)}});Kekule.Isotope=Class.create(Kekule.Element,{CLASS_NAME:"Kekule.Isotope",initialize:function($super,a,b){var f=a;var e=b;var d=Kekule.IsotopesDataUtil.getIsotopeInfo(a,b);if(d){if(d.atomicNumber){f=d.atomicNumber}e=d.massNumber}$super(f);this.setPropStoreFieldValue("massNumber",e);if(d&&d.isotopeAlias){this.setPropStoreFieldValue("isotopeAlias",d.isotopeAlias)}if(Kekule.Element.isNormalElement(f)&&(e!==Kekule.Isotope.UNSET_MASSNUMBER)){var c=Kekule.IsotopesDataUtil.getIsotopeInfo(this.getAtomicNumber(),e);if(c){this.setPropStoreFieldValue("exactMass",c.exactMass);this.setPropStoreFieldValue("naturalAbundance",c.naturalAbundance)}else{Kekule.chemError((Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.INVALID_ISOTOPE"):"Invalid isotope")+": "+this.getSymbol()+"/"+b)}}},initProperties:function(){this.defineProp("massNumber",{dataType:DataType.INTEGER,serializable:false,setter:null});this.defineProp("exactMass",{dataType:DataType.FLOAT,serializable:false,setter:null});this.defineProp("naturalAbundance",{dataType:DataType.FLOAT,serializable:false,setter:null});this.defineProp("isotopeAlias",{dataType:DataType.STRING,serializable:false,setter:null})},isSame:function(a){if(a instanceof Kekule.Isotope){return(a===this)||((a.getAtomicNumber()==this.getAtomicNumber())&&(a.getMassNumber()==this.getMassNumber()))}return false},getIsotopeId:function(){return Kekule.IsotopesDataUtil.getIsotopeId(this.getAtomicNumber(),this.getMassNumber())},getLabel:function(){return""+(this.getMassNumber()||"")+this.getSymbol()}});Object.extend(Kekule.Isotope,Kekule.IsotopesDataUtil);Kekule.Isotope.UNSET_MASSNUMBER=undefined;Kekule.Isotope.getIsotopeId=function(a,b){return Kekule.IsotopesDataUtil.getIsotopeId(a,b)};Object.extend(Kekule.Isotope,{isMassNumberAvailable:function(a,b){return Kekule.IsotopesDataUtil.isMassNumberAvailable(a,b)}});Kekule.IsotopeFactory={GENERIC_ELEMENT_ID:"__GENERIC__",_isotopes:{},getIsotopeId:function(a,b){if(!a){return Kekule.IsotopeFactory.GENERIC_ELEMENT_ID}else{return Kekule.IsotopesDataUtil.getIsotopeId(a,b)}},getIsotope:function(a,b){var d=Kekule.IsotopeFactory.getIsotopeId(a,b);if(!Kekule.IsotopeFactory._isotopes[d]){var c=new Kekule.Isotope(a,b);Kekule.IsotopeFactory._isotopes[d]=c}return Kekule.IsotopeFactory._isotopes[d]},getIsotopeById:function(b){if(Kekule.IsotopeFactory._isotopes[b]){return Kekule.IsotopeFactory._isotopes[b]}else{var a=Kekule.IsotopesDataUtil.getIsotopeIdDetail(b);if(a){return Kekule.IsotopeFactory.getIsotope(a.symbol,a.massNumber)}else{return null}}}};Kekule.AtomType={UNSET_ATOMTYPE:undefined};Kekule.ElectronSet=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ElectronSet",initialize:function($super,a){$super();this.setElectronCount(a||Kekule.ElectronSet.UNSET_ELECTRONCOUNT)},initProperties:function(){this.defineProp("electronCount",{dataType:DataType.FLOAT})}});Kekule.ElectronSet.UNSET_ELECTRONCOUNT=null;Kekule.UnbondedElectronSet=Class.create(Kekule.ElectronSet,{CLASS_NAME:"Kekule.UnBondedElectronSet",initialize:function($super,a){$super(a)},initProperties:function(){}});Kekule.BondType={COVALENT:"covalent",IONIC:"ionic",COORDINATE:"coordinate",METALLIC:"metallic",HYDROGEN:"hydrogen",UNKNOWN:null,DEFAULT:"covalent"};Kekule.BondOrder={SINGLE:1,DOUBLE:2,TRIPLE:3,QUAD:4,EXPLICIT_AROMATIC:10,OTHER:20,UNSET:null,DEFAULT:1,getBondValence:function(a){if(a===Kekule.BondOrder.UNSET){return 0}else{if(a==Kekule.BondOrder.EXPLICIT_AROMATIC){return 1.5}else{return a}}}};Kekule.BondForm=Class.create(Kekule.ElectronSet,{CLASS_NAME:"Kekule.BondForm",initialize:function($super,b,c,a){$super(c);this.setBondOrder(b||Kekule.BondOrder.DEFAULT);if(Kekule.ObjUtils.notUnset(a)){this.setBondType(a)}if(Kekule.ObjUtils.notUnset(c)){this.setElectronCount(c)}},initProperties:function(){this.defineProp("bondType",{dataType:DataType.STRING,enumSource:Kekule.BondType,getter:function(){var a=this.getPropStoreFieldValue("bondType");return(a?a:Kekule.BondType.DEFAULT)}});this.defineProp("bondOrder",{dataType:DataType.FLOAT,enumSource:Kekule.BondOrder,setter:function(a){if(this.getPropStoreFieldValue("bondOrder")!=a){this.setPropStoreFieldValue("bondOrder",a);if(a){if(this.getBondType()==Kekule.BondType.COVALENT){this.setElectronCount(this.getBondValence()*2)}}else{if(a===Kekule.BondOrder.UNSET){this.setElectronCount(Kekule.ElectronSet.UNSET_ELECTRONCOUNT)}}}}});this.defineProp("electronCount",{dataType:DataType.FLOAT});this.defineProp("bondValence",{dataType:DataType.FLOAT,serializable:false,getter:function(){return Kekule.BondOrder.getBondValence(this.getBondOrder())},setter:null})}});Kekule.BondFormFactory={_bondForms:{},getBondFormId:function(c,d,b){var a="";if(b){a+=b+"_"}if(c){a+=Number(c).toString()}if(d){a+="_"+Number(d).toString()}return a},getBondForm:function(b,d,a){if((!b)&&(!d)&&(!a)){return undefined}if(!a){a=Kekule.BondType.DEFAULT}if((!d)&&(b)&&(a===Kekule.BondType.COVALENT)){var c=Kekule.BondOrder.getBondValence(b);d=c*2}var e=Kekule.BondFormFactory.getBondFormId(b,d,a);if(!Kekule.BondFormFactory._bondForms[e]){Kekule.BondFormFactory._bondForms[e]=new Kekule.BondForm(b,d,a)}return Kekule.BondFormFactory._bondForms[e]}};Kekule.RadicalOrder={NONE:0,SINGLET:1,DOUBLET:2,TRIPLET:3,DEFAULT:0,getRadicalElectronCount:function(a){var b=Kekule.RadicalOrder;if(Kekule.ObjUtils.isUnset(a)||(a===b.NONE)){return 0}else{if(a===b.DOUBLET){return 1}else{return 2}}}};Kekule.HybridizationType={UNKNOWN:null,SP:1,SP2:2,SP3:3,NONE:0};Kekule.ValenceUtils={getImplicitMdlValence:function(a,b,e){var c=b;var d=e;switch(a){case 1:case 3:case 11:case 19:case 37:case 55:case 87:if(c==0&&d<=1){return 1}break;case 4:case 12:case 20:case 38:case 56:case 88:switch(c){case 0:if(d<=2){return 2}break;case 1:if(d<=1){return 1}break}break;case 5:switch(c){case -4:if(d<=1){return 1}break;case -3:if(d<=2){return 2}break;case -2:if(d<=3){return 3}if(d<=5){return 5}break;case -1:if(d<=4){return 4}break;case 0:if(d<=3){return 3}break;case 1:if(d<=2){return 2}break;case 2:if(d<=1){return 1}break}break;case 6:switch(c){case -3:if(d<=1){return 1}break;case -2:if(d<=2){return 2}break;case -1:if(d<=3){return 3}if(d<=5){return 5}break;case 0:if(d<=4){return 4}break;case 1:if(d<=3){return 3}break;case 2:if(d<=2){return 2}break;case 3:if(d<=1){return 1}break}break;case 7:switch(c){case -2:if(d<=1){return 1}break;case -1:if(d<=2){return 2}break;case 0:if(d<=3){return 3}if(d<=5){return 5}break;case 1:if(d<=4){return 4}break;case 2:if(d<=3){return 3}break;case 3:if(d<=2){return 2}break;case 4:if(d<=1){return 1}break}break;case 8:switch(c){case -1:if(d<=1){return 1}break;case 0:if(d<=2){return 2}break;case 1:if(d<=3){return 3}if(d<=5){return 5}break;case 2:if(d<=4){return 4}break;case 3:if(d<=3){return 3}break;case 4:if(d<=2){return 2}break;case 5:if(d<=1){return 1}break}break;case 9:switch(c){case 0:if(d<=1){return 1}break;case 1:if(d<=2){return 2}break;case 2:if(d<=3){return 3}if(d<=5){return 5}break;case 3:if(d<=4){return 4}break;case 4:if(d<=3){return 3}break;case 5:if(d<=2){return 2}break;case 6:if(d<=1){return 1}break}break;case 13:switch(c){case -4:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -3:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -2:if(d<=3){return 3}if(d<=5){return 5}break;case -1:if(d<=4){return 4}break;case 0:if(d<=3){return 3}break;case 1:if(d<=2){return 2}break;case 2:if(d<=1){return 1}break}break;case 14:switch(c){case -3:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -2:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -1:if(d<=3){return 3}if(d<=5){return 5}break;case 0:if(d<=4){return 4}break;case 1:if(d<=3){return 3}break;case 2:if(d<=2){return 2}break;case 3:if(d<=1){return 1}break}break;case 15:switch(c){case -2:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 0:if(d<=3){return 3}if(d<=5){return 5}break;case 1:if(d<=4){return 4}break;case 2:if(d<=3){return 3}break;case 3:if(d<=2){return 2}break;case 4:if(d<=1){return 1}break}break;case 16:switch(c){case -1:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 0:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 1:if(d<=3){return 3}if(d<=5){return 5}break;case 2:if(d<=4){return 4}break;case 3:if(d<=3){return 3}break;case 4:if(d<=2){return 2}break;case 5:if(d<=1){return 1}break}break;case 17:switch(c){case 0:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 2:if(d<=3){return 3}if(d<=5){return 5}break;case 3:if(d<=4){return 4}break;case 4:if(d<=3){return 3}break;case 5:if(d<=2){return 2}break;case 6:if(d<=1){return 1}break}break;case 31:switch(c){case -4:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -3:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -2:if(d<=3){return 3}if(d<=5){return 5}break;case -1:if(d<=4){return 4}break;case 0:if(d<=3){return 3}break;case 2:if(d<=1){return 1}break}break;case 32:switch(c){case -3:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -2:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -1:if(d<=3){return 3}if(d<=5){return 5}break;case 0:if(d<=4){return 4}break;case 1:if(d<=3){return 3}break;case 3:if(d<=1){return 1}break}break;case 33:switch(c){case -2:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 0:if(d<=3){return 3}if(d<=5){return 5}break;case 1:if(d<=4){return 4}break;case 2:if(d<=3){return 3}break;case 4:if(d<=1){return 1}break}break;case 34:switch(c){case -1:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 0:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 1:if(d<=3){return 3}if(d<=5){return 5}break;case 2:if(d<=4){return 4}break;case 3:if(d<=3){return 3}break;case 5:if(d<=1){return 1}break}break;case 35:switch(c){case 0:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 2:if(d<=3){return 3}if(d<=5){return 5}break;case 3:if(d<=4){return 4}break;case 4:if(d<=3){return 3}break;case 6:if(d<=1){return 1}break}break;case 49:switch(c){case -4:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -3:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -2:if(d<=3){return 3}if(d<=5){return 5}break;case -1:if(d<=2){return 2}if(d<=4){return 4}break;case 0:if(d<=3){return 3}break;case 2:if(d<=1){return 1}break}break;case 50:case 82:switch(c){case -3:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -2:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -1:if(d<=3){return 3}if(d<=5){return 5}break;case 0:if(d<=2){return 2}if(d<=4){return 4}break;case 1:if(d<=3){return 3}break;case 3:if(d<=1){return 1}break}break;case 51:case 83:switch(c){case -2:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 0:if(d<=3){return 3}if(d<=5){return 5}break;case 1:if(d<=2){return 2}if(d<=4){return 4}break;case 2:if(d<=3){return 3}break;case 4:if(d<=1){return 1}break}break;case 52:case 84:switch(c){case -1:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 0:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 1:if(d<=3){return 3}if(d<=5){return 5}break;case 2:if(d<=2){return 2}if(d<=4){return 4}break;case 3:if(d<=3){return 3}break;case 5:if(d<=1){return 1}break}break;case 53:case 85:switch(c){case 0:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case 1:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case 2:if(d<=3){return 3}if(d<=5){return 5}break;case 3:if(d<=2){return 2}if(d<=4){return 4}break;case 4:if(d<=3){return 3}break;case 6:if(d<=1){return 1}break}break;case 81:switch(c){case -4:if(d<=1){return 1}if(d<=3){return 3}if(d<=5){return 5}if(d<=7){return 7}break;case -3:if(d<=2){return 2}if(d<=4){return 4}if(d<=6){return 6}break;case -2:if(d<=3){return 3}if(d<=5){return 5}break;case -1:if(d<=2){return 2}if(d<=4){return 4}break;case 0:if(d<=1){return 1}if(d<=3){return 3}break}break}return d},getImplicitHydValence:function(a,c,g){var d=a;var e=c;var f=g;var b=0;if(d==6){b=4-abs(e)}else{if(d==7||d==15){b=3+e}else{if(d==8||d==16){b=2+e}}}if(b<0){b=0}if(f>b){b=f}return b}};Kekule.ValenceUtils.getImplicitValence=Kekule.ValenceUtils.getImplicitMdlValence;(function(){Kekule.StructureComparationLevel={SKELETAL:1,CONSTITUTION:2,CONFIGURATION:3,EXACT:4,DEFAULT:4};Kekule.globalOptions.add("algorithm.structureComparation",{structureComparationLevel:Kekule.StructureComparationLevel.DEFAULT});Kekule.ObjComparer.compareStructure=function(d,c,a){var b=Object.create(a||{});b.method=Kekule.ComparisonMethod.CHEM_STRUCTURE;return Kekule.ObjComparer.compare(d,c,b)};Kekule.ObjComparer.equalStructure=function(c,b,a){return Kekule.ObjComparer.compareStructure(c,b,a)===0};Kekule.ObjComparer.getStructureComparisonDetailOptions=function(e){var m=Object.extend({},e);if(e){var d=Kekule.StructureComparationLevel;var b=e.structureLevel||e.level||Kekule.globalOptions.algorithm.structureComparation.structureComparationLevel;var g=["atom","mass","linkedConnectorCount","charge","radical","stereo","hydrogenCount","connectedObjCount","bondType","bondOrder"];var j;if(b===d.SKELETAL){j={atom:false,mass:false,linkedConnectorCount:true,charge:false,radical:false,stereo:false,hydrogenCount:false,connectedObjCount:true,bondType:false,bondOrder:false}}else{if(b===d.CONSTITUTION){j={atom:true,mass:false,linkedConnectorCount:true,charge:false,radical:false,stereo:false,hydrogenCount:true,connectedObjCount:true,bondType:true,bondOrder:true}}else{if(b===d.CONFIGURATION){j={atom:true,mass:false,linkedConnectorCount:true,charge:false,radical:false,stereo:true,hydrogenCount:true,connectedObjCount:true,bondType:true,bondOrder:true}}else{if(b===d.EXACT){j={atom:true,mass:true,linkedConnectorCount:true,charge:true,radical:true,stereo:true,hydrogenCount:true,connectedObjCount:true,bondType:true,bondOrder:true}}}}}for(var f=0,c=g.length;f<c;++f){var k=g[f];var h="compare"+k.capitalizeFirst();var a=m[k];if(Kekule.ObjUtils.isUnset(a)){a=m[h]}if(Kekule.ObjUtils.isUnset(a)){m[k]=j[k];m[h]=j[k]}else{m[k]=a;m[h]=a}}}return m};Kekule.ChemStructureObject=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ChemStructureObject",initProperties:function(){this.defineProp("linkedConnectors",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){if(!this.getPropStoreFieldValue("linkedConnectors")){this.setPropStoreFieldValue("linkedConnectors",[])}return this.getPropStoreFieldValue("linkedConnectors")}});this.defineProp("linkedObjs",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){var a=[];for(var f=0,c=this.getLinkedConnectorCount();f<c;++f){var b=this.getLinkedConnectorAt(f);var g=b.getConnectedObjs();for(var e=0,d=g.length;e<d;++e){if(g[e]!==this){Kekule.ArrayUtils.pushUnique(a,g[e])}}}return a}});this.defineProp("linkedSiblings",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){var m=[];var h=this.getParent();for(var f=0,a=this.getLinkedConnectorCount();f<a;++f){var b=this.getLinkedConnectorAt(f);var g=b.getConnectedObjs();for(var d=0,c=g.length;d<c;++d){var e=g[d];if(e!==this){if(m.indexOf(e)<0){if(e.getParent()!==h){e=h.getDirectChildOfNestedNode(e)}if(e){m.push(e)}}}}}return m}})},initPropValues:function($super){$super();this.setPropStoreFieldValue("linkedConnectors",[]);this.setSuppressChildChangeEventInUpdating(true)},getAutoIdPrefix:function(){return"o"},doGetActualCompareOptions:function($super,a){if(a&&a.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){return Kekule.ObjComparer.getStructureComparisonDetailOptions(a)}else{return $super(a)}},_getComparisonOptionFlagValue:function(b,d){var c="compare"+d.capitalizeFirst();var a=b[c];if(Kekule.ObjUtils.isUnset(a)){a=b[d]}return a},doGetComparisonPropNames:function($super,a){if(a.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){return[]}else{return $super(a)}},doCompare:function($super,d,b){var a=$super(d,b);if(!a&&b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(b,"linkedConnectorCount")){var e=this.getLinkedNonHydrogenConnectors();var c=d.getLinkedNonHydrogenConnectors&&d.getLinkedNonHydrogenConnectors();a=this.doCompareOnValue(e.length,c&&c.length,b)}}return a},compareStructure:function(b,a){var c=Object.create(a||{});c.method=Kekule.ComparisonMethod.CHEM_STRUCTURE;return this.compare(b,c)},equalStructure:function(b,a){return this.compareStructure(b,a)===0},getParentFragment:function(){var a=this.getParent();return(a instanceof Kekule.StructureFragment)?a:null},getRootFragment:function(){var a=this.getParentFragment();if(a){return a.getRootFragment()||a}else{return a}},notifyLinkedConnectorsChanged:function(){this.notifyPropSet("linkedConnectors",this.getPropStoreFieldValue("linkedConnectors"))},getCurrConnectableObj:function(){return this},getLinkedConnectorCount:function(){return this.getLinkedConnectors().length},getLinkedConnectorAt:function(a){return this.getLinkedConnectors()[a]},indexOfLinkedConnector:function(a){return this.getLinkedConnectors().indexOf(a)},appendLinkedConnector:function(b){var a=this._doAppendLinkedConnector(b);if(b){b._doAppendConnectedObj(this)}return a},_doAppendLinkedConnector:function(a){if(!a){return -1}var c=this.getPropStoreFieldValue("linkedConnectors");var b=Kekule.ArrayUtils.pushUniqueEx(c,a);if(b.isPushed){this.notifyLinkedConnectorsChanged()}return b.index},removeLinkedConnectorAt:function(b){var a=this.getLinkedConnectorAt(b);if(a){a._doRemoveConnectedObjAt(a.indexOfConnectedObj(this))}return this._doRemoveLinkedConnectorAt(b)},_doRemoveLinkedConnectorAt:function(a){var b=Kekule.ArrayUtils.removeAt(this.getLinkedConnectors(),a);if(b){this.notifyLinkedConnectorsChanged()}return b},removeLinkedConnector:function(a){var b=this.getLinkedConnectors().indexOf(a);if(b>=0){this.removeLinkedConnectorAt(b)}},getConnectorTo:function(d){for(var b=0,a=this.getLinkedConnectorCount();b<a;++b){var e=this.getLinkedConnectorAt(b);if(e.hasConnectedObj(d)){return e}}return null},removeThisFromLinkedConnector:function(){for(var a=this.getLinkedConnectorCount()-1;a>=0;--a){var b=this.getLinkedConnectorAt(a);b.removeConnectedObj(this)}},getLinkedObjsOnConnector:function(b){var a=[];var e=b.getConnectedObjs();for(var d=0,c=e.length;d<c;++d){if(e[d]!==this){Kekule.ArrayUtils.pushUnique(a,e[d])}}return a},getLinkedNonHydrogenConnectors:function(){var a=[];for(var d=0,c=this.getLinkedConnectorCount();d<c;++d){var b=this.getLinkedConnectorAt(d);if(!b.isNormalConnectorToHydrogen||!b.isNormalConnectorToHydrogen()){Kekule.ArrayUtils.pushUnique(a,b)}}return a},getLinkedNonHydrogenObjs:function(){var a=[];for(var f=0,c=this.getLinkedConnectorCount();f<c;++f){var b=this.getLinkedConnectorAt(f);var g=b.getConnectedObjs();for(var e=0,d=g.length;e<d;++e){if(g[e]!==this&&(!g[e].isHydrogenAtom||!g[e].isHydrogenAtom())){Kekule.ArrayUtils.pushUnique(a,g[e])}}}return a},getLinkedHydrogenAtoms:function(){var a=[];for(var f=0,c=this.getLinkedConnectorCount();f<c;++f){var b=this.getLinkedConnectorAt(f);var g=b.getConnectedObjs();for(var e=0,d=g.length;e<d;++e){if(g[e]!==this&&(g[e].isHydrogenAtom&&g[e].isHydrogenAtom())){Kekule.ArrayUtils.pushUnique(a,g[e])}}}return a},getStructureRelatedPropNames:function(){return["linkedConnectors"]},structureChange:function(a){this.clearStructureFlags();this.invokeEvent("structureChange",{origin:a||this})},clearStructureFlags:function(){},relayEvent:function($super,a,b){if(a==="structureChange"){this.structureChange(b.origin)}else{$super(a,b)}},doObjectChange:function($super,a){if(Kekule.ArrayUtils.intersect(a||[],this.getStructureRelatedPropNames()).length){this.structureChange()}}});Kekule.BaseStructureNode=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.BaseStructureNode",initialize:function($super,c,a,b){$super(c);if(a){this.setCoord2D(a)}if(b){this.setCoord3D(b)}},initProperties:function(){this.defineProp("zIndex2D",{dataType:DataType.INT,scope:Class.PropertyScope.PUBLISHED})},getStructureRelatedPropNames:function($super){return $super().concat(["coord2D","coord3D"])},getAutoIdPrefix:function(){return"n"},getContainerBox:function(b,a){var c=this.getAbsCoordOfMode(b,a);return Kekule.BoxUtils.createBox(c,c)},getContainerBox2D:function(a){return this.getContainerBox(Kekule.CoordMode.COORD2D,a)},getContainerBox3D:function(a){return this.getContainerBox(Kekule.CoordMode.COORD3D,a)}});Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.BaseStructureNode);Kekule.StereoParity={NONE:null,ODD:1,EVEN:2,UNKNOWN:0};Kekule.ChemStructureNode=Class.create(Kekule.BaseStructureNode,{CLASS_NAME:"Kekule.ChemStructureNode",initialize:function($super,c,a,b){$super(c);if(a){this.setCoord2D(a)}if(b){this.setCoord3D(b)}},initProperties:function(){this.defineProp("charge",{dataType:DataType.FLOAT,getter:function(){return this.getPropStoreFieldValue("charge")||0}});this.defineProp("radical",{dataType:DataType.INT});this.defineProp("parity",{dataType:DataType.INT});this.defineProp("isAnchor",{dataType:DataType.BOOL,serializable:false,getter:function(){var a=this.getParent();if(a&&a.indexOfAnchorNode){return a.indexOfAnchorNode(this)>=0}else{return false}},setter:function(a){if(a!==this.getIsAnchor()){var b=this.getParent();if(b){if(a&&b.appendAnchorNode()){b.appendAnchorNode(this)}else{if(!a&&b.removeAnchorNode){b.removeAnchorNode(this)}}}}}})},getStructureRelatedPropNames:function($super){return $super().concat(["charge","radical"])},getLabel:function(){return null},doGetComparisonPropNames:function($super,b){var a=$super(b);if(b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(b,"charge")){a.push("charge")}if(this._getComparisonOptionFlagValue(b,"radical")){a.push("radical")}}return a},doCompare:function($super,d,b){var a=$super(d,b);if(!a&&b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(b,"stereo")){var e=this.getParity()||Kekule.StereoParity.UNKNOWN;var c=(d.getParity&&d.getParity())||Kekule.StereoParity.UNKNOWN;a=this.doCompareOnValue(e,c,b)}}return a},getPrimaryIsotope:function(){return null},getLinkedChemNodes:function(e){var c=this.getLinkedObjs();var a=[];for(var d=0,b=c.length;d<b;++d){var f=c[d];if(f instanceof Kekule.ChemStructureNode&&(!e||!f.isHydrogenAtom||!f.isHydrogenAtom())){a.push(f)}}return a},getLinkedBonds:function(b){var a=[];for(var e=0,d=this.getLinkedConnectorCount();e<d;++e){var f=this.getLinkedConnectorAt(e);if((f instanceof Kekule.Bond)&&(!b||f.getBondType()===b)){a.push(f)}}return a},getLinkedMultipleBonds:function(){var f=Kekule.BondOrder;var b=[];for(var e=0,d=this.getLinkedConnectorCount();e<d;++e){var g=this.getLinkedConnectorAt(e);if((g instanceof Kekule.Bond)&&(g.getBondType()===Kekule.BondType.COVALENT)){var a=g.getBondOrder();if((a===f.DOUBLE)||(a===f.TRIPLE)||(a===f.QUAD)||(a===f.EXPLICIT_AROMATIC)){b.push(g)}}}return b},getLinkedDoubleBonds:function(){var f=Kekule.BondOrder;var b=[];for(var e=0,d=this.getLinkedConnectorCount();e<d;++e){var g=this.getLinkedConnectorAt(e);if((g instanceof Kekule.Bond)&&(g.getBondType()===Kekule.BondType.COVALENT)){var a=g.getBondOrder();if(a===f.DOUBLE){b.push(g)}}}return b},clearStructureFlags:function(){this.setPropStoreFieldValue("parity",Kekule.StereoParity.NONE)},isHydrogenAtom:function(){return false}});Kekule.RadicalType={NONE:0,SINGLET:1,DOUBLET:2,TRIPLET:3};Kekule.AbstractAtom=Class.create(Kekule.ChemStructureNode,{CLASS_NAME:"Kekule.AbstractAtom",initialize:function($super,c,a,b){$super(c,a,b)},initProperties:function(){this.defineProp("explicitHydrogenCount",{dataType:DataType.INT})},getAutoIdPrefix:function(){return"a"},getStructureRelatedPropNames:function($super){return $super().concat(["explicitHydrogenCount"])},doCompare:function($super,d,b){var a=$super(d,b);if(!a&&b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(b,"hydrogenCount")){var e=this.getHydrogenCount(true);var c=d.getHydrogenCount&&d.getHydrogenCount(true);a=this.doCompareOnValue(e,c,b)}}return a},getHydrogenCount:function(c){var a=this.getExplicitHydrogenCount()||0;if(c){var b=this.getLinkedHydrogenAtoms();a+=b.length||0}return a},setHydrogenCount:function(a){return this.setExplicitHydrogenCount(a)},isSaturated:function(){return !this.getLinkedMultipleBonds().length},mayContainElement:function(a){var b;if(typeof(a)==="string"){b=Kekule.ChemicalElementsDataUtil.getAtomicNumber(a)}else{b=a}return this.doMayContainElement(b)},doMayContainElement:function(a){return false}});Kekule.Atom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.Atom",initialize:function($super,e,a,b,c,d){$super(e,c,d);if(a||b){this.changeIsotope(a,b)}},initProperties:function(){this.defineProp("isotope",{dataType:"Kekule.Isotope",serializable:false});this.defineProp("isotopeId",{dataType:DataType.STRING,serializable:true,getter:function(){var a=this.getIsotope();return a?a.getIsotopeId():Kekule.Element.UNSET_ELEMENT},setter:function(b){var a=Kekule.IsotopeFactory.getIsotopeById(b);if(a){this.setIsotope(a)}}});this.defineProp("symbol",{dataType:DataType.STRING,serializable:false,getter:function(){var b=this.getIsotope();var a=b?b.getSymbol():Kekule.Element.UNSET_ELEMENT;return a},setter:function(a){this.changeElement(a)}});this.defineProp("atomicNumber",{dataType:DataType.INTEGER,serializable:false,getter:function(){var a=this.getIsotope();return a?a.getAtomicNumber():0},setter:function(a){this.changeElement(a)}});this.defineProp("massNumber",{dataType:DataType.INTEGER,getter:function(){var a=this.getIsotope();return a?a.getMassNumber():Kekule.Isotope.UNSET_MASSNUMBER},setter:function(a){this.changeMassNumber(a)}});this.defineProp("isotopeAlias",{dataType:DataType.STRING,getter:function(){var a=this.getIsotope();return a?a.getIsotopeAlias():undefined},setter:function(a){this.changeElement(a)}});this.defineProp("atomType",{dataType:DataType.OBJECT,serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("atomTypeId",{dataType:DataType.STRING,getter:function(){var a=this.getPropStoreFieldValue("atomType");return a?a.id:Kekule.AtomType.UNSET_ATOMTYPE},setter:function(b){if(this.isNormalAtom()){var a=Kekule.AtomTypeDataUtil.getAtomTypeFromId(this.getAtomicNumber(),b);this.setAtomType(a)}}});this.defineProp("hybridizationType",{dataType:DataType.INT,enumSource:Kekule.HybridizationType})},getAutoIdPrefix:function(){return"a"},getStructureRelatedPropNames:function($super){return $super().concat(["isotope","atomType"])},doGetComparisonPropNames:function($super,b){var a=$super(b);if(b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(b,"atom")){a.push("atomicNumber")}if(this._getComparisonOptionFlagValue(b,"mass")){a.push("massNumber")}}return a},getPrimaryIsotope:function(){return this.getIsotope()},getLabel:function(){return""+(this.getMassNumber()||"")+this.getSymbol()},doMayContainElement:function(a){return this.getAtomicNumber()===a},changeIsotope:function(a,b){if(a===Kekule.Element.UNSET_ELEMENT){b=Kekule.Isotope.UNSET_MASSNUMBER}else{if(!a){a=this.getAtomicNumber()}}if(!b){b=Kekule.Isotope.UNSET_MASSNUMBER}if(this.getAtomicNumber()!==a){this.setAtomType(Kekule.AtomType.UNSET_ATOMTYPE)}var c=Kekule.IsotopeFactory.getIsotope(a,b);this.setIsotope(c)},changeElement:function(a){return this.changeIsotope(a,Kekule.Isotope.UNSET_MASSNUMBER)},changeMassNumber:function(a){return this.changeIsotope(null,a)},isElement:function(a){return(this.getSymbol()===a)||(this.getAtomicNumber()===a)},isNormalAtom:function(){var a=this.getIsotope();return a?a.isNormalElement():false},isHydrogenAtom:function(){return this.isElement(1)&&(!this.getMassNumber()||this.getMassNumber()<=1)},_getCurrCovalentBondsInfo:function(){var f=0;var e=0;for(var d=0,b=this.getLinkedConnectorCount();d<b;++d){var a=this.getLinkedConnectorAt(d);if((a instanceof Kekule.Bond)&&(a.getBondType()==Kekule.BondType.COVALENT)){var c=a.getBondValence();f+=c;if(c>e){e=c}}}return{valenceSum:f,maxValence:e}},_getCurrIonicBondsInfo:function(){var f=0;var e=0;for(var d=0,b=this.getLinkedConnectorCount();d<b;++d){var a=this.getLinkedConnectorAt(d);if((a instanceof Kekule.Bond)&&(a.getBondType()==Kekule.BondType.IONIC)){var c=a.getBondValence();f+=c;if(c>e){e=c}}}return{valenceSum:f,maxValence:e}},guessAtomType:function(){if(this.isNormalAtom()){var c=null,g=null;var f=this._getCurrCovalentBondsInfo();var e=Kekule.AtomTypeDataUtil.getAllAtomTypes(this.getAtomicNumber());if(e){for(var d=0,a=e.length;d<a;++d){var b=e[d];g=b;if(b.bondOrderSum>=f.valenceSum){c=b;if(b.maxBondOrder>=f.maxValence){return b}}}return c?c:g}}return null},getProximalAtomType:function(){return this.getAtomType()||this.guessAtomType()},getImplicitValence:function(){if(this.isNormalAtom()){var c=this._getCurrCovalentBondsInfo();var d=c.valenceSum;var b=Math.round(this.getCharge()||0);var a=Kekule.ValenceUtils.getImplicitValence(this.getAtomicNumber(),b,d);return a}else{return 0}},getImplicitHydrogenCount:function(){if(this.isNormalAtom()){var c=this._getCurrCovalentBondsInfo();var b=this._getCurrIonicBondsInfo();var d=this.getImplicitValence();var a=Kekule.RadicalOrder.getRadicalElectronCount(this.getRadical());d-=a;return Math.max(d-c.valenceSum-b.valenceSum,0)}else{return 0}},getHydrogenCount:function(b){var a;if(Kekule.ObjUtils.isUnset(this.getExplicitHydrogenCount())){a=this.getImplicitHydrogenCount()||0}else{a=this.getExplicitHydrogenCount()||0}if(b){a+=this.getLinkedHydrogenAtoms().length||0}return a},getAtomicMass:function(){var a=null;var b=this.getIsotope();if(b){a=b.getExactMass()||b.getNaturalMass()}return a}});Kekule.PseudoatomType={DUMMY:"dummy",ANY:"any",HETERO:"hetero",CUSTOM:"custom"};Kekule.Pseudoatom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.Pseudoatom",initialize:function($super,e,a,d,b,c){$super(e,b,c);if(a){this.setAtomType(a)}if(d&&(a==Kekule.PseudoatomType.CUSTOM)){this.setSymbol(d)}},initProperties:function(){this.defineProp("atomType",{dataType:DataType.STRING,enumSource:Kekule.PseudoatomType});this.defineProp("symbol",{dataType:DataType.STRING,getter:function(){var b=this.getAtomType();var c=Kekule.PseudoatomType;var a=Kekule.ChemStructureNodeLabels;return(b===c.DUMMY)?a.DUMMY_ATOM:(b===c.ANY)?a.ANY_ATOM:(b===c.HETERO)?a.HETERO_ATOM:this.getPropStoreFieldValue("symbol")||a.CUSTOM_ATOM},setter:function(c){var d=Kekule.PseudoatomType;var a=Kekule.ChemStructureNodeLabels;if(c){var b=(c===a.DUMMY_ATOM)?d.DUMMY:(c===a.ANY_ATOM)?d.ANY:(c===a.HETERO_ATOM)?d.HETERO:d.CUSTOM;this.setAtomType(b)}this.setPropStoreFieldValue("symbol",c)}})},getStructureRelatedPropNames:function($super){return $super().concat(["atomType","symbol"])},getPrimaryIsotope:function(){return null},getLabel:function(){return this.getSymbol()},doGetComparisonPropNames:function($super,b){var a=$super(b);if(b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(b,"atom")){a.push("atomType")}}return a},doCompare:function($super,c,b){var a=$super(c,b);if(!a&&b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(b,"atom")){if(this.getAtomType()===Kekule.PseudoatomType.CUSTOM){var e=this.getSymbol();var d=c.getSymbol&&c.getSymbol();a=this.doCompareOnValue(e,d,b)}}}return a},doMayContainElement:function(d){var c=Kekule.PseudoatomType;var b=this.getAtomType();if(b===c.ANY){return true}else{if(b===c.HETERO){if([1,6].indexOf(d)>=0){return false}else{var a=Kekule.ChemicalElementsDataUtil.getElementInfo(d);return(eleminfo.chemicalSerie==="Nonmetals")}}else{return false}}}});Kekule.VariableAtom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.VariableAtom",initProperties:function(){this.defineProp("allowedIsotopeIds",{dataType:DataType.ARRAY,getter:function(b){var a=this.getPropStoreFieldValue("allowedIsotopeIds");if((!a)&&b){a=[];this.setPropStoreFieldValue("allowedIsotopeIds",a)}return a}});this.defineProp("disallowedIsotopeIds",{dataType:DataType.ARRAY,getter:function(b){var a=this.getPropStoreFieldValue("disallowedIsotopeIds");if((!a)&&b){a=[];this.setPropStoreFieldValue("disallowedIsotopeIds",a)}return a}});this.defineProp("allowedIsotopes",{dataType:DataType.ARRAY,setter:null,getter:function(){return this._getIsotopesFromIds(this.getAllowedIsotopeIds())}});this.defineProp("disallowedIsotopes",{dataType:DataType.ARRAY,setter:null,getter:function(){return this._getIsotopesFromIds(this.getDisallowedIsotopeIds())}})},getStructureRelatedPropNames:function($super){return $super().concat(["allowedIsotopeIds","disallowedIsotopeIds"])},getPrimaryIsotope:function(){if(this.isDisallowedList()){return null}else{var a=this.getAllowedIsotopeIds();var b=a?a[0]:null;return b?Kekule.IsotopeFactory.getIsotopeById(b):null}},getLabel:function(){return Kekule.ChemStructureNodeLabels.VARIABLE_ATOM},doCompare:function($super,e,g){var h=$super(e,g);if(!h&&g.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(g,"atom")){var f=Kekule.ArrayUtils;var b=this.getAllowedIsotopeIds();var a=e.getAllowedIsotopeIds&&e.getAllowedIsotopeIds();if(b){b=f.clone(b).sort();if(a&&a.length){a=f.clone(a).sort()}h=this.doCompareOnValue(b,a,g)}else{if(a){h=1}else{var d=this.getDisallowedIsotopeIds();var c=e.getDisallowedIsotopeIds&&e.getDisallowedIsotopeIds();if(d&&d.length){d=f.clone(d).sort()}if(c&&c.length){c=f.clone(c).sort()}h=this.doCompareOnValue(d,c,g)}}}}return h},doMayContainElement:function(c){var b=function(n,h){if(!h){return false}for(var g=0,e=h.length;g<e;++g){var m=h[g];var k=Kekule.IsotopesDataUtil.getIsotopeIdDetail(m);var j=k.symbol;var f=Kekule.ChemicalElementsDataUtil.getAtomicNumber(j);if(f===n){return true}}return false};var a=this.getAllowedIsotopeIds();if(a){return b(c,a)}else{a=this.getDisallowedIsotopeIds();if(a){return !b(c,a)}}},isDisallowedList:function(){return this.getDisallowedIsotopeIds()&&(!this.getAllowedIsotopeIds())},isListEmpty:function(){var b=this.getAllowedIsotopeIds();var a=!b||!b.length;if(a){b=this.getDisallowedIsotopeIds();a=!b||!b.length}return a},fetchAllowedIsotopeIds:function(){return this.doGetAllowedIsotopeIds(true)},fetchDisallowedIsotopeIds:function(){return this.doGetDisallowedIsotopeIds(true)},_getIsotopesFromIds:function(e){if(!e){return null}var a=[];for(var d=0,b=e.length;d<b;++d){var f=e[d];var c=Kekule.IsotopeFactory.getIsotopeById(f);if(c){a.push(c)}}return a}});Kekule.MolecularFormula=Class.create(ObjectEx,{CLASS_NAME:"Kekule.MolecularFormula",initialize:function($super,a){$super();this.setPropStoreFieldValue("sections",[]);if(a){this.setPropStoreFieldValue("parent",a)}this.setBubbleEvent(true)},initProperties:function(){this.defineProp("parent",{dataType:"Kekule.StructureFragment",serializable:false,setter:null,scope:Class.PropertyScope.PUBLIC});this.defineProp("sections",{dataType:DataType.ARRAY,setter:null});this.defineProp("charge",{dataType:DataType.FLOAT,getter:function(){return this.getPropStoreFieldValue("charge")||0}});this.defineProp("radical",{dataType:DataType.INT,getter:function(){return this.getPropStoreFieldValue("radical")||0}})},getHigherLevelObj:function(){return this.getParent()},isEmpty:function(){return this.getSectionCount()<=0},notifySectionsChanged:function(){this.notifyPropSet("sections",this.getPropStoreFieldValue("sections"))},createSectionItem:function(b,d,c){var a={obj:b,count:d||1};if(c){b.setCharge(c)}if(b.setParent){b.setParent(this.getParent())}return a},getTotalCharge:function(){var a=0;var d=this.getSections();for(var c=0,b=d.length;c<b;++c){if(d[c].obj.getCharge){a+=d[c].obj.getCharge()*(section.count||1)}}if(this.getCharge()){a+=this.getCharge()}return a},indexOfObj:function(b){var d=this.getSections();for(var c=0,a=d.length;c<a;++c){if(d[c].obj==b){return c}}return -1},getSectionCount:function(){return this.getSections().length},getSectionAt:function(a){return this.getSections()[a]},getSectionCharge:function(b){var a=0;var c;if(typeof(b)!="object"){c=this.getSectionAt(b)}else{c=b}if(c.obj.getCharge){a+=(c.obj.getCharge()||0)}return a},appendSection:function(b,d,c){var a=this.createSectionItem(b,d,c);this.getSections().push(a);this.notifySectionsChanged();return a},insertSection:function(c,b,e,d){var a=this.createSectionItem(b,e,d);this.getSections().splice(c,0,a);this.notifySectionsChanged();return a},removeSectionAt:function(a){var b=this.getSections().splice(a,1);if(b){this.notifySectionsChanged()}return b},clear:function(){this.beginUpdate();try{this.setCharge(null);this.setRadical(null);this.setPropStoreFieldValue("sections",[]);this.notifySectionsChanged()}finally{this.endUpdate()}},removeObj:function(a){var b=this.indexOfObj(a);if(b>=0){var c=this.removeSectionAt(b);this.notifySectionsChanged()}else{return null}},getMaxNestedLevel:function(){var a=0;for(var d=0,b=this.getSectionCount();d<b;++d){var e=this.getSectionAt(d);if(e.obj instanceof Kekule.MolecularFormula){var c=e.obj.getMaxNestedLevel()+1;if(c>a){a=c}}}return a},getSimpleIsotopeMaps:function(){}});Kekule.StructureConnectionTable=Class.create(ObjectEx,{CLASS_NAME:"Kekule.StructureConnectionTable",initialize:function($super,a,b){$super();if(a){this.setOwner(a)}if(b){this.setPropStoreFieldValue("parent",b)}},initProperties:function(){this.defineProp("owner",{dataType:"Kekule.ChemSpace",serializable:false,scope:Class.PropertyScope.PUBLIC,setter:function(a){if(a!=this.getPropStoreFieldValue("owner")){this.setPropStoreFieldValue("owner",a);this.ownerChanged(a)}}});this.defineProp("parent",{dataType:"Kekule.StructureFragment",serializable:false,scope:Class.PropertyScope.PUBLIC,setter:function(a){if(a!=this.getPropStoreFieldValue("parent")){this.setPropStoreFieldValue("parent",a);this.parentChanged(a)}}});this.defineProp("nodes",{dataType:DataType.ARRAY});this.defineProp("anchorNodes",{dataType:DataType.ARRAY,setter:null});this.defineProp("connectors",{dataType:DataType.ARRAY});this.defineProp("nonHydrogenNodes",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:false,setter:null,getter:function(){var a=[];for(var c=0,b=this.getNodeCount();c<b;++c){var d=this.getNodeAt(c);if(!d.isHydrogenAtom||!d.isHydrogenAtom()){a.push(d)}}return a}});this.defineProp("nonHydrogenConnectors",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:false,setter:null,getter:function(){var a=[];for(var c=0,b=this.getConnectorCount();c<b;++c){var d=this.getConnectorAt(c);if(!d.isNormalConnectorToHydrogen||!d.isNormalConnectorToHydrogen()){a.push(d)}}return a}})},initPropValues:function($super){$super();this.setPropStoreFieldValue("nodes",[]);this.setPropStoreFieldValue("anchorNodes",[]);this.setPropStoreFieldValue("connectors",[])},getHigherLevelObj:function(){return this.getParent()||this.getOwner()},doSaveProp:function(n,c,g,v){var o=c.name;switch(o){case"anchorNodes":var d=[];for(var u=0,q=n.getAnchorNodeCount();u<q;++u){var p=n.getAnchorNodeAt(u);var e=n.indexOfNode(p);d.push(e)}var f=v.createChildStorageNode(g,v.propNameToStorageName(o),true);v.save(d,f);return true;break;case"connectors":var f=v.createChildStorageNode(g,v.propNameToStorageName(o),true);for(var u=0,q=n.getConnectorCount();u<q;++u){var w=n.getConnectorAt(u);var a=v.getNameForArrayItemStorageNode(w);var m=v.appendArrayItemStorageNode(f,v.propNameToStorageName(a),v.isArray(w));v.setStorageNodeExplicitType(m,v.getValueExplicitType(w));v.save(w,m);var h=[];for(var s=0,r=w.getConnectedObjCount();s<r;++s){var t=w.getConnectedObjAt(s);var e=n.indexOfChild(t);if(e>=0){h.push(e)}else{var b=n.indexStackOfChild(t);if((b!==null)&&(typeof(b)!=="undefined")){h.push(b)}}}if(h.length){var x=v.createChildStorageNode(m,v.propNameToStorageName("connectedObjs"),true);v.save(h,x)}}return true;break;default:return false}},doLoadProp:function(m,b,h,s){var n=b.name;switch(n){case"anchorNodes":var d=[];var e=s.getChildStorageNode(h,s.propNameToStorageName(n));s.load(d,e);m.__load_anchorNodes_indexes=d;return true;break;case"connectors":var e=s.getChildStorageNode(h,s.propNameToStorageName(n));var c=s.getAllArrayItemStorageNodes(e);var a;for(var q=0,p=c.length;q<p;++q){var k=c[q];var t=s.getStorageNodeExplicitType(k)||s.getStorageNodeName(k);if(t){a=DataType.createInstance(t);s.load(a,k);var u=s.getChildStorageNode(k,s.propNameToStorageName("connectedObjs"));if(u){var j=[];s.load(j,u);a.__load_connectedObj_indexes=j}var o=s.getChildStorageNode(k,s.propNameToStorageName("connectedNodes"));if(o){var f=[];s.load(f,o);a.__load_connectedNode_indexes=f}var g=s.getChildStorageNode(k,s.propNameToStorageName("connectedConnectors"));if(g){var r=[];s.load(r,g);a.__load_connectedConnector_indexes=r}m.appendConnector(a)}}return true;break;default:return false}},loaded:function($super){if(this.__load_anchorNodes_indexes){for(var f=0,b=this.__load_anchorNodes_indexes.length;f<b;++f){var e=this.__load_anchorNodes_indexes[f];this.appendAnchorNode(this.getNodeAt(e))}delete this.__load_anchorNodes_indexes}for(var f=0,b=this.getConnectorCount();f<b;++f){var a=this.getConnectorAt(f);if(a.__load_connectedObj_indexes){for(var d=0,c=a.__load_connectedObj_indexes.length;d<c;++d){var e=a.__load_connectedObj_indexes[d];var g;if(typeof(e)=="object"){g=this.getChildAtIndexStack(e)}else{g=this.getChildAt(e)}if(g){a.appendConnectedObj(g)}}delete a.__load_connectedObj_indexes}if(a.__load_connectedNode_indexes){for(var d=0,c=a.__load_connectedNode_indexes.length;d<c;++d){var e=a.__load_connectedNode_indexes[d];if(typeof(e)=="object"){a.appendConnectedObj(this.getNodeAtIndexStack(e))}else{a.appendConnectedObj(this.getNodeAt(e))}}delete a.__load_connectedNode_indexes}if(a.__load_connectedConnector_indexes){for(var d=0,c=a.__load_connectedConnector_indexes.length;d<c;++d){var e=a.__load_connectedConnector_indexes[d];a.appendConnectedObj(this.getConnectorAt(e))}delete a.__load_connectedConnector_indexes}}this.ownerChanged(this.getOwner());this.parentChanged(this.getParent());$super()},notifyNodesChanged:function(){this.notifyPropSet("nodes",this.getPropStoreFieldValue("nodes"))},notifyAnchorNodesChanged:function(){this.notifyPropSet("anchorNodes",this.getPropStoreFieldValue("anchorNodes"))},notifyConnectorsChanged:function(){this.notifyPropSet("connectors",this.getPropStoreFieldValue("connectors"))},ownerChanged:function(b){for(var c=0,a=this.getNodeCount();c<a;++c){this.getNodeAt(c).setOwner(b)}for(var c=0,a=this.getConnectorCount();c<a;++c){this.getConnectorAt(c).setOwner(b)}},parentChanged:function(c){for(var b=0,a=this.getNodeCount();b<a;++b){this.getNodeAt(b).setParent(c)}for(var b=0,a=this.getConnectorCount();b<a;++b){this.getConnectorAt(b).setParent(c)}},isEmpty:function(){return(this.getNodeCount()<=0)&&(this.getConnectorCount()<=0)},getNodeById:function(d){var b=this.getNodes();for(var c=0,a=b.length;c<a;++c){if(b[c].getId()==d){return b[c]}}return null},getConnectorById:function(d){var b=this.getConnectors();for(var c=0,a=b.length;c<a;++c){if(b[c].getId()==d){return b[c]}}return null},getObjectById:function(b){var a=this.getNodeById(b);return a?a:this.getConnectorById(b)},getNodeCount:function(){return this.getNodes().length},getNodeAt:function(a){return this.getNodes()[a]},indexOfNode:function(a){return this.getNodes().indexOf(a)},hasNode:function(d,b){var e=this.indexOfNode(d)>=0;if((!e)&&b){for(var c=0,a=this.getNodeCount();c<a;++c){var f=this.getNodeAt(c);if(f.hasNode){e=f.hasNode(d,true)}if(e){break}}}return e},indexStackOfNode:function(e){var c=this.indexOfNode(e);if(c>=0){return c}else{var a=null;for(var d=0,b=this.getNodeCount();d<b;++d){var f=this.getNodeAt(d);if(f.indexStackOfNode){a=f.indexStackOfNode(e);if(!Kekule.ObjUtils.isUnset(a)){if(typeof(a)!="object"){a=[a]}a.unshift(d);return a}}}return a}},getNodeAtIndexStack:function(c){c=Kekule.ArrayUtils.toArray(c);if(c.length<=0){return null}else{var d=this.getNodeAt(c[0]);for(var b=1,a=c.length;b<a;++b){if(d&&d.getNodeAt){d=d.getNodeAt(c[b])}else{return null}}return d}},appendNode:function(b){var a=Kekule.ArrayUtils.pushUniqueEx(this.getNodes(),b);if(a.isPushed){if(b.setOwner){b.setOwner(this.getOwner())}if(b.setParent){b.setParent(this.getParent())}this.notifyNodesChanged()}return a.index},insertNodeAt:function(d,b){var c=this.indexOfNode(d);var a=this.getNodes();if(Kekule.ObjUtils.isUnset(b)||(b<0)){b=a.length}if(c>=0){a.splice(c,1);a.splice(b,0,d)}else{a.splice(b,0,d);if(d.setOwner){d.setOwner(this.getOwner())}if(d.setParent){d.setParent(this.getParent())}}this.notifyNodesChanged()},setNodeIndex:function(d,b){var a=this.getNodes();var c=this.indexOfNode(d);if(c>=0){a.splice(c,1);a.splice(b,0,d)}},removeNodeAt:function(b,a){var c=this.getNodes()[b];if(c){if(!a){c.removeThisFromLinkedConnector()}this.getNodes().splice(b,1);if(c.setOwner){c.setOwner(null)}if(c.setParent){c.setParent(null)}this.notifyNodesChanged()}},removeNode:function(c,a){var b=this.getNodes().indexOf(c);if(b>=0){this.removeNodeAt(b,a)}},replaceNode:function(c,p){if(!this.hasNode(c)){return this}else{this.insertBefore(p,c);var a=this.getAnchorNodes();var o=a.indexOf(c);if(o>=0){a.splice(o,1,[p])}var b=Kekule.ArrayUtils.clone(c.getLinkedConnectors());for(var n=0,d=b.length;n<d;++n){var e=b[n];e.replaceConnectedObj(c,p)}if(c.getNodes&&c.getCrossConnectors){var h=Kekule.ArrayUtils.clone(c.getCrossConnectors());for(var n=0,d=h.length;n<d;++n){var e=h[n];if(this.indexOfConnector(e)>=0){for(var g=0,f=e.getConnectedObjCount();g<f;++g){var m=e.getConnectedObjAt(g);if(c.indexOfChild(m)>=0){e.replaceConnectedObj(m,p)}}}e.replaceConnectedObj(c,p)}}this.removeNode(c)}},clearNodes:function(){this.clearAnchorNodes();this.setPropStoreFieldValue("nodes",[]);this.notifyAnchorNodesChanged();this.notifyNodesChanged()},sortNodes:function(a){if(a){this.getNodes().sort(a);this.notifyNodesChanged()}else{Kekule.error(Kekule.$L("ErrorMsg.SORT_FUNC_UNSET"))}},nodesHasCoord2D:function(c){var b=this.getNodes();for(var d=0,a=b.length;d<a;++d){if(b[d].hasCoord2D(c)){return true}}return false},nodesHasCoord3D:function(c){var b=this.getNodes();for(var d=0,a=b.length;d<a;++d){if(b[d].hasCoord3D(c)){return true}}return false},_createAtom:function(a,b,c,e){var d=new Kekule.Atom(null,a,b,c,e);return d},appendAtom:function(a,b,c,e){var d=this._createAtom(a,b,c,e);if(d){this.appendNode(d)}return d},getAnchorNodeCount:function(){return this.getAnchorNodes().length},indexOfAnchorNode:function(a){return this.getAnchorNodes().indexOf(a)},getAnchorNodeAt:function(a){return this.getAnchorNodes()[a]},appendAnchorNode:function(b){if(!b){return -1}if(this.getNodes().indexOf(b)>=0){var a=Kekule.ArrayUtils.pushUniqueEx(this.getAnchorNodes(),b);if(a.isPushed){this.notifyAnchorNodesChanged()}return a.index}else{return -1}},removeAnchorNodeAt:function(a){var b=this.getAnchorNodes()[a];if(b){this.getAnchorNodes().splice(a,1);this.notifyAnchorNodesChanged()}},removeAnchorNode:function(b){var a=this.getAnchorNodes().indexOf(b);if(a>=0){this.removeAnchorNodeAt(a)}},clearAnchorNodes:function(){this.setPropStoreFieldValue("anchorNodes",[]);notifyAnchorNodesChanged()},getConnectorCount:function(){return this.getConnectors().length},indexOfConnector:function(a){return this.getConnectors().indexOf(a)},getConnectorAt:function(a){return this.getConnectors()[a]},indexStackOfConnector:function(c){var d=this.indexOfConnector(c);if(d>=0){return d}else{var a=null;for(var e=0,b=this.getNodeCount();e<b;++e){var f=this.getNodeAt(e);if(f.indexStackOfConnector){a=f.indexStackOfConnector(c);if(!Kekule.ObjUtils.isUnset(a)){if(typeof(a)!="object"){a=[a]}a.unshift(e);return a}}}return a}},getConnectorAtIndexStack:function(c){c=Kekule.ArrayUtils.toArray(c);if(c.length<=0){return null}else{if(c.length===1){return this.getConnectorAt(c[0])}else{var a=c.length-1;var d=this.getNodeAt(c[0]);for(var b=1;b<a;++b){if(d&&d.getNodeAt){d=d.getNodeAt(c[b])}else{return null}}if(d){return d.getConnectorAt(c[a])}else{return null}}}},appendConnector:function(a){var b=Kekule.ArrayUtils.pushUniqueEx(this.getConnectors(),a);if(b.isPushed){if(a.setOwner){a.setOwner(this.getOwner())}if(a.setParent){a.setParent(this.getParent())}this.notifyConnectorsChanged()}return b.index},insertConnectorAt:function(b,c){var d=this.indexOfConnector(b);var a=this.getConnectors();if(Kekule.ObjUtils.isUnset(c)||(c<0)){c=a.length}if(d>=0){a.splice(d,1);a.splice(c,0,b)}else{a.splice(c,0,b);if(b.setOwner){b.setOwner(this.getOwner())}if(b.setParent){b.setParent(this.getParent())}}this.notifyConnectorsChanged()},setConnectorIndex:function(b,c){var a=this.getConnectors();var d=this.indexOfConnector(b);if(d>=0){a.splice(d,1);a.splice(c,0,b)}},removeConnectorAt:function(c,a){var b=this.getConnectors()[c];if(b){if(!a){b.removeThisFromConnectedObjs()}this.getConnectors().splice(c,1);if(b.setOwner){b.setOwner(null)}if(b.setParent){b.setParent(null)}this.notifyConnectorsChanged()}},removeConnector:function(b,a){var c=this.getConnectors().indexOf(b);if(c>=0){this.removeConnectorAt(c,a)}},clearConnectors:function(){this.setPropStoreFieldValue("connectors",[]);this.notifyConnectorsChanged()},hasConnector:function(b,c){var e=this.indexOfConnector(b)>=0;if((!e)&&c){for(var d=0,a=this.getNodeCount();d<a;++d){var f=this.getNodeAt(d);if(f.hasConnector){e=f.hasConnector(b,true)}if(e){break}}}return e},sortConnectors:function(a){if(a){this.getConnectors().sort(a);this.notifyConnectorsChanged()}else{Kekule.error(Kekule.$L("ErrorMsg.SORT_FUNC_UNSET"))}},_createBond:function(e,d,c){var j=[];for(var h=0,g=e.length;h<g;++h){var f=e[h];if(DataType.isSimpleValue(f)){f=this.getNodeAt(f)}j.push(f)}var b=new Kekule.Bond(null,j,d,null,c);return b},appendBond:function(c,b,a){var d=this._createBond(c,b,a);if(d){this.appendConnector(d)}return d},_getObjsNeedToBeCascadeRemoved:function(k,j){var n=[];var m=k.getLinkedConnectors?k.getLinkedConnectors():[];for(var f=0,b=m.length;f<b;++f){var c=m[f];if((!j)||(j.indexOf(c)<0)){if(c.getConnectedObjs().length<=2){Kekule.ArrayUtils.pushUnique(n,c)}}}if(k instanceof Kekule.ChemStructureNode){}else{if(k instanceof Kekule.ChemStructureConnector){var g=k.getConnectedObjs();for(var f=0,b=g.length;f<b;++f){var e=g[f];if((!j)||(j.indexOf(e)<0)){if(e instanceof Kekule.ChemStructureNode){if(e.getLinkedConnectors().length<=1){Kekule.ArrayUtils.pushUnique(n,e)}}}}}else{}}var d=[].concat(n);d.push(k);var h=[];for(var f=0,b=n.length;f<b;++f){var e=n[f];if(e!==k){var a=this._getObjsNeedToBeCascadeRemoved(e,d)}Kekule.ArrayUtils.pushUnique(h,a)}Kekule.ArrayUtils.pushUnique(n,h);return n},removeChildObj:function(g,d,b){var f;if(d){f=this._getObjsNeedToBeCascadeRemoved(g);Kekule.ArrayUtils.pushUnique(f,g)}else{f=[g]}for(var c=0,a=f.length;c<a;++c){var e=f[c];if(e instanceof Kekule.BaseStructureConnector){this.removeConnector(e)}else{if(e instanceof Kekule.BaseStructureNode){this.removeNode(e)}}}if(b){for(var c=f.length-1;c>=0;--c){var e=f[c];if(e.finalize){e.finalize()}}}},removeChild:function(a){return this.removeChildObj(a)},deleteChildObj:function(b,a){return this.removeChildObj(b,a,true)},hasChildObj:function(a){return this.hasNode(a)||this.hasConnector(a)},getNextSiblingOfChild:function(b){if(b instanceof Kekule.ChemStructureNode){var a=this.indexOfNode(b);if(a>=0){return this.getNodeAt(a+1)}}else{if(b instanceof Kekule.ChemStructureConnector){var a=this.indexOfConnector(b);if(a>=0){return this.getConnectorAt(a+1)}}}return null},insertBefore:function(c,a){if(c instanceof Kekule.BaseStructureNode){var b=this.indexOfNode(a);return this.insertNodeAt(c,b)}else{if(c instanceof Kekule.BaseStructureConnector){var b=this.indexOfConnector(a);return this.insertConnectorAt(c,b)}}},clear:function(){this.clearNodes();this.clearConnectors()},getChildCount:function(){return this.getNodeCount()+this.getConnectorCount()},getChildAt:function(b){var a=this.getNodeCount();if(b<a){return this.getNodeAt(b)}else{return this.getConnectorAt(b-a)}},indexOfChild:function(c){var a;if(c instanceof Kekule.BaseStructureNode){a=this.indexOfNode(c)}else{if(c instanceof Kekule.BaseStructureConnector){a=this.indexOfConnector(c);if(a>=0){var b=this.getNodeCount();a+=b}}else{a=-1}}return a},indexStackOfChild:function(c){var a;if(c instanceof Kekule.BaseStructureNode){a=this.indexStackOfNode(c)}else{if(c instanceof Kekule.BaseStructureConnector){var b=this.getNodeCount();a=this.indexStackOfConnector(c);if(a.length){a[a.length-1]+=b}else{a+=b}}else{a=-1}}return a},getChildAtIndexStack:function(c){c=Kekule.ArrayUtils.toArray(c);if(c.length<=0){return null}else{var d=this.getChildAt(c[0]);for(var b=1,a=c.length;b<a;++b){if(d&&d.getChildAt){d=d.getChildAt(c[b])}else{return null}}return d}},isSubFragment:function(a){return(a.getNodeCount&&(a.getNodeCount()>0))},getSubFragments:function(){var a=[];for(var c=0,b=this.getNodeCount();c<b;++c){var d=this.getNodeAt(c);if(this.isSubFragment(d)){a.push(d)}}return a},hasSubFragments:function(){var a=this.getSubFragments();return a&&a.length},getLeafNodes:function(){var a=[];for(var d=0,c=this.getNodeCount();d<c;++d){var e=this.getNodeAt(d);if(!this.isSubFragment(e)){a.push(e)}else{if(e.getLeafNodes){var b=e.getLeafNodes();a=a.concat(b)}}}return a},findDirectChildOfObj:function(a){var b=a;while(b&&this.indexOfChild(b)<0){b=b.getParent?b.getParent():null}return b},getAllChildConnectors:function(){var a=[].concat(this.getConnectors());var d=this.getSubFragments();for(var c=0,b=d.length;c<b;++c){if(d[c].getAllChildConnectors){a=a.concat(d[c].getAllChildConnectors())}}return a},getAllContainingConnectors:function(){return this.getAllChildConnectors()},getIsotopeMaps:function(){var a=this.getNodes();if(a.length<=0){return[]}else{var g=function(q,m,p,n){var r=false;for(var l=0,i=q.length;l<i;++l){if(m.isSame(q[l].isotope)){r=true;q[l].count+=p;q[l].charge+=n||0}}if(!r){var o={isotope:m,count:p,charge:c.getCharge()||0};q.push(o)}return q};var k=[];for(var e=0,d=a.length;e<d;++e){var c=a[e];if(c instanceof Kekule.StructureFragment){var h=c.getIsotopeMaps();for(var e=0,d=h.length;e<d;++e){k=g(k,h[e].isotope,h[e].count,h[e].charge||0)}}else{if(c instanceof Kekule.Atom){var j=c.getIsotope();k=g(k,c.getIsotope(),1,c.getCharge()||0);var f=c.getHydrogenCount();if(f>0){var b=Kekule.IsotopeFactory.getIsotope(1);k=g(k,b,f,0)}}}}}return k},calcFormula:function(){var e=this.getIsotopeMaps();if(e.length<=0){return null}var a=new Kekule.MolecularFormula();for(var d=0,b=e.length;d<b;++d){var c=new Kekule.Atom();c.setIsotope(e[d].isotope);a.appendSection(c,e[d].count,e[d].charge)}return a},getNodesContainBox:function(a,e,c){var h=(e===Kekule.CoordMode.COORD3D);var j={};for(var f=0,d=a.length;f<d;++f){var b=a[f];var g=b.getAbsCoordOfMode(e,c);if(f==0){j.x1=j.x2=g.x;j.y1=j.y2=g.y;if(h){j.z1=j.z2=g.z}}else{(g.x<j.x1)?j.x1=g.x:((g.x>j.x2)?j.x2=g.x:null);(g.y<j.y1)?j.y1=g.y:((g.y>j.y2)?j.y2=g.y:null);if(h){(g.z<j.z1)?j.z1=g.z:((g.z>j.z2)?j.z2=g.z:null)}}}return j},getContainerBox:function(b,a){return this.getNodesContainBox(this.getNodes(),b,a)},getContainerBox2D:function(b){var a=this.getContainerBox(Kekule.CoordMode.COORD2D,b);a.width=a.x2-a.x1;a.height=a.y2-a.y1;return a},getContainerBox3D:function(b){var a=this.getContainerBox(Kekule.CoordMode.COORD3D,b);a.deltaX=a.x2-a.x1;a.deltaY=a.y2-a.y1;a.deltaZ=a.z2-a.z1;return a}});Kekule.StructureFragment=Class.create(Kekule.ChemStructureNode,{CLASS_NAME:"Kekule.StructureFragment",initialize:function($super,c,a,b){$super(c,a,b)},doFinalize:function($super){if(this.hasFormula()){this.getFormula().finalize()}if(this.hasCtab()){this.getCtab().finalize()}$super()},initProperties:function(){this.defineProp("formula",{dataType:"Kekule.MolecularFormula",getter:function(a){if(!this.getPropStoreFieldValue("formula")){if(a){this.createFormula()}}return this.getPropStoreFieldValue("formula")},setter:function(b){var a=this.getPropStoreFieldValue("formula");if(a){a.finalize();a=null}if(b){b.setPropValue("parent",this,true);b.addEventListener("change",function(c){this.notifyPropSet("formula",this.getFormula())},this)}this.setPropStoreFieldValue("formula",b)}});this.defineProp("ctab",{dataType:"Kekule.StructureConnectionTable",getter:function(a){if(!this.getPropStoreFieldValue("ctab")){if(a){this.createCtab()}}return this.getPropStoreFieldValue("ctab")},setter:function(b){var a=this.getPropStoreFieldValue("ctab");if(a){a.finalize();a=null}if(b){b.setPropValue("parent",this,true);b.setOwner(this.getOwner());b.addEventListener("propValueSet",function(c){if((c.propName=="nodes")||(c.propName=="anchorNodes")||(c.propName=="connectors")){this.notifyPropSet(c.propName,c.propValue)}},this);b.setEnablePropValueSetEvent(true)}this.setPropStoreFieldValue("ctab",b)}});this.defineProp("nodes",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNodes():[]}});this.defineProp("anchorNodes",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getAnchorNodes():[]}});this.defineProp("connectors",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getConnectors():[]}});this.defineProp("crossConnectors",{dataType:DataType.ARRAY,serializable:false,setter:null,scope:Class.PropertyScope.PUBLIC,getter:function(){var a=[].concat(this.getPropStoreFieldValue("linkedConnectors"));for(var f=0,c=this.getNodeCount();f<c;++f){var g=this.getNodeAt(f);var b=g.getLinkedConnectors()||[];for(var e=0,d=b.length;e<d;++e){if(this.indexOfConnector(b[e])<0){Kekule.ArrayUtils.pushUnique(a,b[e])}}}return a}});this.defineProp("nonHydrogenNodes",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:false,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNonHydrogenNodes():[]}});this.defineProp("nonHydrogenConnectors",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:false,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNonHydrogenConnectors():[]}});this.defineProp("canonicalizationInfo",{dataType:DataType.OBJECT,serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("aromaticRings",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,getter:function(){var a=this.getPropStoreFieldValue("aromaticRings");if(!a){a=[];this.setPropStoreFieldValue("aromaticRings",a)}return a}});this.defineProp("flattenedShadow",{dataType:"Kekule.StructureFragmentShadow",serializable:false,scope:Class.PropertyScope.PRIVATE,getter:function(d){var a=null;if(Kekule.ObjUtils.isUnset(d)){d=true}var b=this.getFlattenedShadowOnSelf();if(b){return null}else{a=this.getPropStoreFieldValue("flattenedShadow");if(!a&&d){a=new Kekule.StructureFragmentShadow(this);var c=a.getShadowFragment();c.unmarshalAllSubFragments(true);this._copyAdditionalInfoToShadowFragment(c,a.getSourceToShadowMap(),a.getShadowToSourceMap());this.setPropStoreFieldValue("flattenedShadow",a)}}return a}});this.defineProp("flattenedShadowOnSelf",{dataType:DataType.BOOL,serializable:false,scope:Class.PropertyScope.PROVATE,setter:null,getter:function(){var a=this.setPropStoreFieldValue("flattenedShadowOnSelf");if(Kekule.ObjUtils.isUnset(a)){a=!this.hasSubFragments();this.setPropStoreFieldValue("flattenedShadowOnSelf",a)}return a}})},getAutoIdPrefix:function(){return"f"},getStructureRelatedPropNames:function($super){return $super().concat(["ctab","formula","nodes","anchorNodes","connectors"])},doCompare:function($super,j,n){var o=$super(j,n);if(!o&&n.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){var b=this.hasCtab();var a=j.hasCtab&&j.hasCtab();o=b?(a?0:1):(a?-1:0);if(!o){var h=this.hasFormula();var g=j.hasFormula&&j.hasFormula();o=h?(g?0:1):(g?-1:0)}if(!o&&this.hasCtab()){if((o===0)&&(this.getNonHydrogenNodes&&j.getNonHydrogenNodes)){var m=this.getNonHydrogenNodes();var k=j.getNonHydrogenNodes();o=m.length-k.length;if(o===0){for(var f=0,e=m.length;f<e;++f){o=this.doCompareOnValue(m[f],k[f],n);if(o!==0){break}}}}if((o===0)&&(this.getConnectors&&j.getConnectors)){var d=this.getNonHydrogenConnectors();var c=j.getNonHydrogenConnectors();o=d.length-c.length;if(o===0){for(var f=0,e=d.length;f<e;++f){o=this.doCompareOnValue(d[f],c[f],n);if(o!==0){break}}}}}}return o},structureChange:function($super,a){this.setPropStoreFieldValue("flattenedShadowOnSelf",null);var b=this.getFlattenedShadow(false);if(b){b.finalize();this.setPropStoreFieldValue("flattenedShadow",null)}$super(a)},clearStructureFlags:function($super){$super();this.setPropStoreFieldValue("canonicalizationInfo",null);this.setPropStoreFieldValue("aromaticRings",[]);for(var b=0,a=this.getChildCount();b<a;++b){var d=this.getChildAt(b);if(d.clearStructureFlags){d.clearStructureFlags()}}},ownerChanged:function($super,a){if(this.hasCtab()){this.getCtab().setOwner(a)}$super(a)},_removeChildObj:function(b){if(this.hasFormula()){var c=this.getFormula();if(c===b){this.removeFormula()}}else{if(this.hasCtab()){var a=this.getCtab();if(a===b){this.removeCtab()}else{if(a.hasChildObj(b)){a.removeChildObj(b)}}}}},isEmpty:function(){var a;a=!this.hasFormula();if(a){a=!this.hasCtab();if(!a){a=this.getCtab().isEmpty()}}return a},isCtabEmpty:function(){return !this.hasCtab()||this.getCtab().isEmpty()},doGetLinkedConnectors:function(){return this.getCrossConnectors()},appendLinkedConnector:function($super,a){var b=this.getCurrConnectableObj();if(b&&b!==this){return b.appendLinkedConnector(a)}else{return $super(a)}},getCurrConnectableObj:function(){var j=(this.getAnchorNodeCount()>0)?this.getAnchorNodes():this.getNodes();if(j.length<=0){return this}else{var a=this.getCrossConnectors();var c=null;var g=null;for(var h=0,e=j.length;h<e;++h){var d=j[h];var b=d.getLinkedConnectors();var f=Kekule.ArrayUtils.intersect(b,a);var k=f.length;if(c===null||c>k){c=k;g=d}}return g}},createCtab:function(){var a=new Kekule.StructureConnectionTable(this.getOwner(),this);this.setCtab(a)},createFormula:function(){var a=new Kekule.MolecularFormula(this);this.setFormula(a)},hasCtab:function(){return(!!this.getPropStoreFieldValue("ctab"))},hasFormula:function(){return(!!this.getPropStoreFieldValue("formula"))},removeFormula:function(){var a=this.getPropStoreFieldValue("formula");if(a){a.finalize();a=null;this.setPropStoreFieldValue("formula",null)}return this},removeCtab:function(){var a=this.getPropStoreFieldValue("ctab");if(a){a.finalize();a=null;this.setPropStoreFieldValue("ctab",null)}return this},getContainerBox:function($super,b,a){if(this.hasCtab()){return this.getCtab().getContainerBox(b,a)}else{return $super(b)}},getNodeById:function(a){return this.hasCtab()?this.getCtab().getNodeById(a):null},getConnectorById:function(a){return this.hasCtab()?this.getCtab().getConnectorById(a):null},getObjectById:function(b){var a=this.getNodeById(b);return a?a:this.getConnectorById(b)},getNodeCount:function(){return this.hasCtab()?this.getCtab().getNodeCount():0},getNodeAt:function(a){return this.hasCtab()?this.getCtab().getNodeAt(a):null},indexOfNode:function(a){return this.hasCtab()?this.getCtab().indexOfNode(a):-1},hasNode:function(b,a){return this.hasCtab()?the.getCtab().hasNode(b,a):null},indexStackOfNode:function(a){return this.hasCtab()?this.getCtab().indexStackOfNode(a):-1},getNodeAtIndexStack:function(a){return this.hasCtab()?this.getCtab().getNodeAtIndexStack(a):null},getDirectChildOfNestedNode:function(a){var c=a.getParent();if(!c){return null}else{if(c===this){return c}else{var b=a;while(c&&(c.getParent)&&(c!==this)){b=c;c=c.getParent()}if(c===this){return b}else{return null}}}},appendNode:function(a){return this.doGetCtab(true).appendNode(a)},insertNodeAt:function(b,a){return this.doGetCtab(true).insertNodeAt(b,a)},removeNodeAt:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeNodeAt(b,a)},removeNode:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeNode(b,a)},replaceNode:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().replaceNode(b,a)},clearNodes:function(){if(this.hasCtab()){return this.getCtab().clearNodes()}},sortNodes:function(a){if(this.hasCtab()){return this.getCtab().sortNodes(a)}},nodesHasCoord2D:function(a){if(!this.hasCtab()){return false}return this.getCtab().nodesHasCoord2D(a)},nodesHasCoord3D:function(a){if(!this.hasCtab()){return false}return this.getCtab().nodesHasCoord3D(a)},isNodeInAromaticRing:function(d){var e=this.getAromaticRings();for(var c=0,a=e.length;c<a;++c){var b=e[c].nodes;if(b.indexOf(d)>=0){return true}}return false},appendAtom:function(a,b,c,d){return this.doGetCtab(true).appendAtom(a,b,c,d)},getAnchorNodeCount:function(){return this.hasCtab()?this.getCtab().getAnchorNodeCount():0},getAnchorNodeAt:function(a){return this.hasCtab()?this.getCtab().getAnchorNodeAt(a):null},indexOfAnchorNode:function(a){return this.hasCtab()?this.getCtab().indexOfAnchorNode(a):-1},appendAnchorNode:function(a){return this.doGetCtab(true).appendAnchorNode(a)},removeAnchorNodeAt:function(a){if(!this.hasCtab()){return null}return this.getCtab().removeAnchorNodeAt(a)},removeAnchorNode:function(a){if(!this.hasCtab()){return null}return this.getCtab().removeAnchorNode(a)},clearAnchorNodes:function(){if(this.hasCtab()){return this.getCtab().clearAnchorNodes()}},getConnectorCount:function(){return this.hasCtab()?this.getCtab().getConnectorCount():0},getConnectorAt:function(a){return this.hasCtab()?this.getCtab().getConnectorAt(a):null},indexOfConnector:function(a){return this.hasCtab()?this.getCtab().indexOfConnector(a):-1},hasConnector:function(a,b){return this.hasCtab()?this.getCtab().hasConnector(a,b):null},appendConnector:function(a){return this.doGetCtab(true).appendConnector(a)},insertConnectorAt:function(a,b){return this.doGetCtab(true).insertConnectorAt(a,b)},removeConnectorAt:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeConnectorAt(b,a)},removeConnector:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeConnector(b,a)},clearConnectors:function(){if(this.hasCtab()){return this.getCtab().clearConnectors()}},sortConnectors:function(a){if(this.hasCtab()){return this.getCtab().sortConnectors(a)}},isConnectorInAromaticRing:function(c){var e=this.getAromaticRings();for(var d=0,b=e.length;d<b;++d){var a=e[d].connectors;if(a.indexOf(c)>=0){return true}}return false},appendBond:function(c,b,a){return this.doGetCtab(true).appendBond(c,b,a)},insertBefore:function(b,a){if(this.hasCtab()){return this.getCtab().insertBefore(b,a)}},_getObjsNeedToBeCascadeRemoved:function(b,a){if(this.hasCtab()){return this.getCtab()._getObjsNeedToBeCascadeRemoved(b,a)}else{return[]}},removeChildObj:function(c,b,a){if(this.hasCtab()){this.getCtab().removeChildObj(c,b,a)}},removeChild:function(a){return this.removeChildObj(a)},hasChildObj:function(a){if(this.hasCtab()){return this.getCtab().hasChildObj(a)}else{return false}},getNextSiblingOfChild:function(a){if(this.hasCtab()){return this.getCtab().getNextSiblingOfChild(a)}else{return null}},getChildCount:function(){if(this.hasCtab()){return this.getCtab().getChildCount()}else{return 0}},getChildAt:function(a){if(this.hasCtab()){return this.getCtab().getChildAt(a)}else{return null}},indexOfChild:function(a){if(this.hasCtab()){return this.getCtab().indexOfChild(a)}else{return -1}},isSubFragment:function(a){return(a.getNodeCount&&(a.getNodeCount()>0))},getSubFragments:function(){return this.hasCtab()?this.getCtab().getSubFragments():[]},hasSubFragments:function(){return this.hasCtab()?this.getCtab().hasSubFragments():false},getLeafNodes:function(){return this.hasCtab()?this.getCtab().getLeafNodes():[]},findDirectChildOfObj:function(a){return this.hasCtab()?this.getCtab().findDirectChildOfObj(a):null},getAllChildConnectors:function(){return this.hasCtab()?this.getCtab().getAllChildConnectors():[]},getAllContainingConnectors:function(){return this.hasCtab()?this.getCtab().getAllContainingConnectors():[]},clear:function(){if(this.hasCtab()){this.setCtab(undefined)}if(this.hasFormula()){this.setFormula(undefined)}},calcFormula:function(){if(this.hasCtab()){return this.getCtab().calcFormula()}else{if(this.hasFormula()){return this.getFormula()}else{return null}}},marshalSubFragment:function(f,h){if(this.hasCtab()){this.beginUpdate();try{this.appendNode(h);var p=[];var g=[];var b=[];var d=[];for(var w=0,s=f.length;w<s;++w){var q=f[w];if(this.indexOfNode(q)<0){continue}var x=false;var t=q.getLinkedConnectors();for(var v=0,u=t.length;v<u;++v){var a=t[v];var y=false;var c=a.getConnectedObjs();for(var r=0,o=c.length;r<o;++r){var e=c[r];if(e!=q){if(f.indexOf(e)<0){x=true;y=true}}}if(y){Kekule.ArrayUtils.pushUnique(d,a)}else{Kekule.ArrayUtils.pushUnique(b,a)}}Kekule.ArrayUtils.pushUnique(p,q);if(x){Kekule.ArrayUtils.pushUnique(g,q)}}for(var w=b.length-1;w>=0;--w){this.removeConnector(b[w],true)}for(var w=p.length-1;w>=0;--w){this.removeNode(p[w],true)}h.beginUpdate();try{for(var w=0,s=p.length;w<s;++w){h.appendNode(p[w])}for(var w=0,s=g.length;w<s;++w){h.appendAnchorNode(g[w])}for(var w=0,s=b.length;w<s;++w){h.appendConnector(b[w])}}finally{h.endUpdate()}}finally{this.endUpdate()}return h}else{return null}},unmarshalSubFragment:function(c,a){if(this.hasCtab()){this.beginUpdate();try{c.beginUpdate();try{if(a&&c.unmarshalAllSubFragments){c.unmarshalAllSubFragments(a)}var b=this.getCtab();Kekule.StructureFragment.moveChildBetweenStructFragment(c,this,c.getNodes(),c.getConnectors(),true);c.clear();b.removeNode(c)}finally{c.endUpdate();c.finalize()}}finally{this.endUpdate()}}},unmarshalAllSubFragments:function(c){var b=this.getSubFragments();if(b){for(var d=0,a=b.length;d<a;++d){this.unmarshalSubFragment(b[d],c)}}},recalcCoords:function(){if(this.hasCtab()){this.beginUpdate();try{var j={};var e={};var g=this.getAnchorNodeCount();for(var f=0,d=g;f<d;++f){var b=this.getAnchorNodeAt(f);j=Kekule.CoordUtils.add(j,b.getCoord2D()||{});e=Kekule.CoordUtils.add(e,b.getCoord3D()||{})}var h=Kekule.ObjUtils.notUnset;var c=(h(j.x)||h(j.y));var m=(h(e.x)||h(e.y)||h(e.z));if(c){var a=Kekule.CoordUtils.substract({},j);this.setCoord2D(Kekule.CoordUtils.substract(this.fetchCoord2D(),a))}if(m){var k=Kekule.CoordUtils.substract({},e);this.setCoord3D(Kekule.CoordUtils.substract(this.fetchCoord3D(),k))}for(var f=0,d=this.getNodeCount();f<d;++f){var b=this.getNodeAt(f);if(c){b.setCoord2D(Kekule.CoordUtils.add(b.fetchCoord2D(),a))}if(m){b.setCoord3D(Kekule.CoordUtils.add(b.fetchCoord3D(),k))}}}finally{this.endUpdate()}}},_copyAdditionalInfoToShadowFragment:function(r,o,q){var h=this;var f=h.getAromaticRings();if(f&&f.length){var p=[];for(var m=0,d=f.length;m<d;++m){var n=f[m];var c=[],b=[];for(var g=0,e=n.nodes.length;g<e;++g){var a=o.get(n.nodes[g]);if(a){c.push(a)}}for(var g=0,e=n.connectors.length;g<e;++g){var a=o.get(n.connectors[g]);if(a){b.push(a)}}p.push({nodes:c,connectors:b})}r.setAromaticRings(p)}},getFlattenedShadowFragment:function(a){if(this.getFlattenedShadowOnSelf()){return this}else{var b=this.getFlattenedShadow(a);return b?b.getShadowFragment():null}},getFlatternedShadowShadowObj:function(a,b){if(this.getFlattenedShadowOnSelf()){return a}else{var c=this.getFlattenedShadow(b);return c?c.getShadowObj(a):null}},getFlatternedShadowSourceObj:function(b,a){if(this.getFlattenedShadowOnSelf()){return b}else{var c=this.getFlattenedShadow(a);return c?c.getSourceObj(b):null}},getFlatternedShadowShadowObjs:function(b,e){if(this.getFlattenedShadowOnSelf()){return b}else{var f=this.getFlattenedShadow(e);var a=[];if(f){for(var d=0,c=b.length;d<c;++d){a.push(f.getShadowObj(b[d]))}}return a}},getFlatternedShadowSourceObjs:function(b,e){if(this.getFlattenedShadowOnSelf()){return b}else{var f=this.getFlattenedShadow(e);var a=[];if(f){for(var d=0,c=b.length;d<c;++d){a.push(f.getSourceObj(b[d]))}}return a}}});Kekule.StructureFragment.moveChildBetweenStructFragment=function(w,k,z,e,c){var x=Kekule.CoordUtils;w.beginUpdate();k.beginUpdate();var a=w.getAnchorNodes();try{var j=w.getAbsCoord2D();var s=w.getAbsCoord3D();var y=k.getAbsCoord2D();var h=k.getAbsCoord3D();var n=x.substract(j,y);var v=x.substract(s,h);var o=Kekule.ArrayUtils.clone(z);var r=Kekule.ArrayUtils.clone(e);for(var t=0,q=o.length;t<q;++t){var p=o[t];var g=w.indexOfNode(p);if(g>=0){w.removeNodeAt(g,true);var u=p.getCoord2D();if(u){var d=x.add(u,n);p.setCoord2D(d)}var f=p.getCoord3D();if(f){var m=x.add(f,v);p.setCoord2D(m)}k.appendNode(p);if(a.indexOf(p)>=0){w.removeAnchorNode(p);if(!c){k.appendAnchorNode(p)}}}}for(var t=0,q=r.length;t<q;++t){var b=r[t];var g=w.indexOfConnector(b);if(g>=0){w.removeConnectorAt(g,true);k.appendConnector(b)}}}finally{k.endUpdate();w.endUpdate()}};Kekule.StructureFragmentShadow=Class.create(ObjectEx,{CLASS_NAME:"Kekule.StructureFragmentShadow",initialize:function($super,b){if(!b){Kekule.error(Kekule.$L("ErrorMsg.SOURCE_FRAGMENT_NOT_SET"));return}$super();this.setPropStoreFieldValue("shadowToSourceMap",new Kekule.MapEx());this.setPropStoreFieldValue("sourceToShadowMap",new Kekule.MapEx());var a=this._createShadowFragment(b,this.getSourceToShadowMap(),this.getShadowToSourceMap());this.setPropStoreFieldValue("shadowFragment",a)},doFinalize:function($super){this.getShadowToSourceMap().finalize();this.getSourceToShadowMap().finalize();this.getShadowFragment().finalize();this.setPropStoreFieldValue("shadowToSourceMap",null);this.setPropStoreFieldValue("sourceToShadowMap",null);this.setPropStoreFieldValue("shadowFragment",null);$super()},initProperties:function(){this.defineProp("shadowFragment",{dataType:"Kekule.StructureFragment",setter:null});this.defineProp("sourceToShadowMap",{dataType:"Kekule.MapEx",setter:null});this.defineProp("shadowToSourceMap",{dataType:"Kekule.MapEx",setter:null})},_createShadowFragment:function(c,b,d){var a=c.clone();this._mapFragmentChildren(c,a,b,d);return a},_mapFragmentChildren:function(g,h,b,f){for(var d=0,a=g.getChildCount();d<a;++d){var c=g.getChildAt(d);var e=h.getChildAt(d);b.set(c,e);f.set(e,c);if(c.getChildCount&&e.getChildCount){this._mapFragmentChildren(c,e,b,f)}}},getShadowObj:function(a){return this.getSourceToShadowMap().get(a)},getSourceObj:function(a){return this.getShadowToSourceMap().get(a)}});Kekule.SubGroup=Class.create(Kekule.StructureFragment,{CLASS_NAME:"Kekule.SubGroup",initialize:function($super,e,b,a,c,d){$super(e,c,d);this.setPropStoreFieldValue("abbr",b);this.setPropStoreFieldValue("name",a)},initProperties:function(){this.defineProp("abbr",{dataType:DataType.STRING});this.defineProp("formulaText",{dataType:DataType.STRING});this.defineProp("name",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"g"},doPropChanged:function($super,a,b){if(a=="anchorNodes"){this.recalcCoords()}return $super(a,b)},getLabel:function(){return Kekule.ChemStructureNodeLabels.SUBGROUP}});Kekule.RGroup=Kekule.SubGroup;Kekule.Molecule=Class.create(Kekule.StructureFragment,{CLASS_NAME:"Kekule.Molecule",initialize:function($super,c,a,b){$super(c);this.setPropStoreFieldValue("name",a);if(b){this.setCtab(new Kekule.StructureConnectionTable())}},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"m"}});Kekule.BaseStructureConnector=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.BaseStructureConnector",initialize:function($super,b,a){$super(b);this.setConnectedObjs(a||[])},initProperties:function(){this.defineProp("connectedObjs",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLISHED,setter:function(d){var f=this.getPropStoreFieldValue("connectedObjs");if(!f){this.setPropStoreFieldValue("connectedObjs",[]);f=this.getPropStoreFieldValue("connectedObjs")}for(var c=0,a=f.length;c<a;++c){f[c].removeLinkedConnector(this)}if(d){for(var c=0,a=d.length;c<a;++c){this.assertConnectedObjLegal(d[c])}for(var c=0,a=d.length;c<a;++c){var e=d[c];var b=e.getCurrConnectableObj?e.getCurrConnectableObj():e;Kekule.ArrayUtils.pushUnique(f,b)}}else{this.setPropStoreFieldValue("connectedObjs",[])}f=this.getPropStoreFieldValue("connectedObjs");for(var c=0,a=f.length;c<a;++c){f[c].appendLinkedConnector(this)}this.notifyConnectedObjsChanged()}})},getAutoIdPrefix:function(){return"c"},getStructureRelatedPropNames:function($super){return $super().concat(["connectedObjs"])},doCompare:function($super,d,b){var a=$super(d,b);if(!a&&b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(b,"connectedObjCount")){var e=this.getConnectedObjCount();var c=d.getConnectedObjCount&&d.getConnectedObjCount();a=this.doCompareOnValue(e,c,b)}}return a},notifyConnectedObjsChanged:function(){this.notifyPropSet("connectedObjs",this.getPropStoreFieldValue("connectedObjs"))},assertConnectedObjLegal:function(a){if((!a)||(!a.getOwner)){Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.UNABLE_ADD_MISTYPED_NODE"):"Unable to link mistyped node to connector")}else{if(a.getOwner()&&a.getOwner()!=this.getOwner()){Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.UNABLE_ADD_DIFF_OWNER_OBJ"):"Object with different owner can not be linked to connector");return false}else{return true}}},connectedObjAdded:function(a){this.notifyConnectedObjsChanged()},getConnectedObjCount:function(){return this.getConnectedObjs().length},indexOfConnectedObj:function(a){return this.getConnectedObjs().indexOf(a)},getConnectedObjAt:function(a){return this.getConnectedObjs()[a]},setConnectedObjAt:function(a,c){this.assertConnectedObjLegal(c);var b=this.getConnectedObjs()[a];if(b){b.removeLinkedConnector(this)}this.insertConnectedObjAt(c,a);this.connectedObjAdded(c)},appendConnectedObj:function(c){this.assertConnectedObjLegal(c);var b=c.getCurrConnectableObj?c.getCurrConnectableObj():c;var a=this._doAppendConnectedObj(b);if(b){b.appendLinkedConnector(this)}return a},_doAppendConnectedObj:function(b){var a=Kekule.ArrayUtils.pushUniqueEx(this.getConnectedObjs(),b);if(a.isPushed){this.connectedObjAdded(b)}return a.index},insertConnectedObjAt:function(d,b){this.assertConnectedObjLegal(d);var a=d.getCurrConnectableObj?d.getCurrConnectableObj():d;var c=this.indexOfConnectedObj(a);var e=this.getConnectedObjs();if(c>=0){e.splice(c,1);e.splice(b,0,a);this.notifyConnectedObjsChanged()}else{e.splice(b,0,a);if(a){a.appendLinkedConnector(this)}this.connectedObjAdded(a)}},removeConnectedObjAt:function(a){var b=this.getConnectedObjs()[a];if(b){this._doRemoveConnectedObjAt(a);b._doRemoveLinkedConnectorAt(b.indexOfLinkedConnector(this));this.notifyConnectedObjsChanged()}},_doRemoveConnectedObjAt:function(a){this.getConnectedObjs().splice(a,1)},removeConnectedObj:function(b){var a=this.getConnectedObjs().indexOf(b);if(a>=0){this.removeConnectedObjAt(a)}},replaceConnectedObj:function(a,b){var c=this.indexOfConnectedObj(a);if(c>=0){this.setConnectedObjAt(c,b)}},clearConnectedObjs:function(){this.setConnectedObjs([])},hasConnectedObj:function(a){return(this.getConnectedObjs().indexOf(a)>=0)},isConnectingWithObj:function(a){return this.hasConnectedObj(a)},sortConnectedObjs:function(a){this.getConnectedObjs().sort(a)},reverseConnectedObjOrder:function(){this.setPropStoreFieldValue("connectedObjs",Kekule.ArrayUtils.reverse(this.getConnectedObjs()));this.notifyConnectedObjsChanged()},removeThisFromConnectedObjs:function(){for(var a=this.getConnectedObjCount()-1;a>=0;--a){var b=this.getConnectedObjAt(a);b.removeLinkedConnector(this)}},getConnectedSiblings:function(){var h=this.getConnectedObjs();var a=[];var e=this.getParent();var d=function(j){if(j.getParent){var i=j.getParent();if(i===e){return i}else{return d(i)}}else{return j}};for(var c=0,b=h.length;c<b;++c){var f=h[c];if(!f.getParent||(f.getParent()===e)){a.push(f)}else{var g=d(f);if(g){a.push(g)}}}return a},isConnectingConnector:function(){for(var b=0,a=this.getConnectedObjCount();b<a;++b){var c=this.getConnectedObjAt(b);if(c instanceof Kekule.ChemStructureConnector){return true}}return false}});Kekule.ChemStructureConnector=Class.create(Kekule.BaseStructureConnector,{CLASS_NAME:"Kekule.ChemStructureConnector",initProperties:function(){this.defineProp("parity",{dataType:DataType.INT});this.defineProp("connectedChemNodes",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){var a=[];for(var c=0,b=this.getConnectedObjCount();c<b;++c){var d=this.getConnectedObjAt(c);if(d instanceof Kekule.ChemStructureNode){a.push(d)}}return a}})},doCompare:function($super,d,b){var a=$super(d,b);if(!a&&b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(b,"stereo")){var e=this.getParity()||Kekule.StereoParity.UNKNOWN;var c=(d.getParity&&d.getParity())||Kekule.StereoParity.UNKNOWN;a=this.doCompareOnValue(e,c,b)}}return a},clearStructureFlags:function(){this.setParity(Kekule.StereoParity.NONE)},getConnectedChemNodeCount:function(){return this.getConnectedChemNodes().length},getConnectedNonHydrogenObjs:function(){var a=[];var e=this.getConnectedObjs();for(var c=0,b=e.length;c<b;++c){var d=e[c];if(!d.isHydrogenAtom||!d.isHydrogenAtom()){a.push(d)}}return a},isNormalConnectorToHydrogen:function(){return this.getConnectedNonHydrogenObjs().length<=1}});Kekule.BondStereo={NONE:0,UP:1,UP_INVERTED:2,DOWN:3,DOWN_INVERTED:4,UP_OR_DOWN:8,UP_OR_DOWN_INVERTED:9,CLOSER:10,E_OR_Z:20,E:21,Z:22,E_Z_BY_COORDINATES:23,CIS_OR_TRANS:30,CIS:31,TRANS:32,getInvertedDirection:function(b){var a=Kekule.BondStereo;switch(b){case a.UP:return a.UP_INVERTED;case a.UP_INVERTED:return a.UP;case a.DOWN:return a.DOWN_INVERTED;case a.DOWN_INVERTED:return a.DOWN;case a.UP_OR_DOWN:return a.UP_OR_DOWN_INVERTED;default:return b}}};Kekule.Bond=Class.create(Kekule.ChemStructureConnector,{CLASS_NAME:"Kekule.Bond",initialize:function($super,e,c,b,d,a){$super(e,c||[]);if(b||d||a){this.setBondForm(Kekule.BondFormFactory.getBondForm(b,d,a))}},initProperties:function(){this.defineProp("bondForm",{dataType:"Kekule.BondForm",serializable:false,scope:Class.PropertyScope.PUBLIC});this.defineProp("bondType",{dataType:DataType.STRING,enumSource:Kekule.BondType,getter:function(){var a=this.getBondForm();return a?a.getBondType():Kekule.BondType.DEFAULT},setter:function(a){this.changeBondForm(this.getBondOrder(),Kekule.ElectronSet.UNSET_ELECTRONCOUNT,a)}});this.defineProp("bondOrder",{dataType:DataType.INT,enumSource:Kekule.BondOrder,getter:function(){var a=this.getBondForm();return a?a.getBondOrder():Kekule.BondOrder.UNSET},setter:function(a){this.changeBondForm(a,Kekule.ElectronSet.UNSET_ELECTRONCOUNT,this.getBondType())}});this.defineProp("bondValence",{dataType:DataType.INT,serializable:false,getter:function(){var a=this.getBondForm();return a?a.getBondValence():0},setter:null});this.defineProp("electronCount",{dataType:DataType.FLOAT,getter:function(){if(this.isAromatic()){return 3}var a=this.getBondForm();return a?a.getElectronCount():Kekule.ElectronSet.UNSET_ELECTRONCOUNT},setter:function(b){var a=this.getBondOrder();this.changeBondForm(a,b,this.getBondType())}});this.defineProp("stereo",{dataType:DataType.INT,enumSource:Kekule.BondStereo,defaultValue:Kekule.BondStereo.NONE});this.defineProp("isInAromaticRing",{dataType:DataType.BOOL,setter:null,getter:function(){var a=false;var b=this.getParent();if(b&&b.isConnectorInAromaticRing){return b.isConnectorInAromaticRing(this)}else{return false}}})},initPropValues:function($super){$super();this.setPropStoreFieldValue("stereo",Kekule.BondStereo.NONE)},getAutoIdPrefix:function(){return"b"},getStructureRelatedPropNames:function($super){return $super().concat(["bondForm","stereo"])},clearStructureFlags:function(){this.setPropStoreFieldValue("isInAromaticRing",null)},doGetParity:function($super){if(this.isDoubleBond()){return $super()}else{return null}},doGetComparisonPropNames:function($super,b){var a=$super(b);if(b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(b,"bondType")){a.push("bondType")}}return a},doCompare:function($super,f,d){var b=$super(f,d);if(!b&&d.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(d,"connectedObjCount")){var g=this.getConnectedObjCount();var e=f.getConnectedObjCount&&f.getConnectedObjCount();b=this.doCompareOnValue(g,e,d)}if(!b&&this._getComparisonOptionFlagValue(d,"bondOrder")){var c=Math.round(this.getElectronCount());var a=Math.round(f.getElectronCount());b=this.doCompareOnValue(c,a,d)}}return b},changeBondForm:function(b,c,a){this.setBondForm(Kekule.BondFormFactory.getBondForm(b,c,a))},canInvertBondDirection:function(){var a=Kekule.BondType;var b=this.getBondType();return[a.COVALENT,a.IONIC,a.METALLIC,a.HYDROGEN,a.UNKNOWN].indexOf(b)>=0},invertBondDirection:function(){this.setStereo(Kekule.BondStereo.getInvertedDirection(this.getStereo()))},reverseConnectedObjOrder:function($super){if(this.canInvertBondDirection()){$super();this.invertBondDirection()}else{}},normalizeDirection:function(){var b=Kekule.BondStereo;var a=[b.UP_INVERTED,b.DOWN_INVERTED,b.UP_OR_DOWN_INVERTED];var c=this.getBondStereo();if(a.indexOf(c)>=0){this.reverseConnectedObjOrder()}},isSingleBond:function(){return(this.getBondType()===Kekule.BondType.COVALENT)&&(this.getBondOrder()===Kekule.BondOrder.SINGLE)&&(!this.getIsInAromaticRing())},isDoubleBond:function(){return(this.getBondType()===Kekule.BondType.COVALENT)&&(this.getBondOrder()===Kekule.BondOrder.DOUBLE)&&(!this.getIsInAromaticRing())},isTripleBond:function(){return(this.getBondType()===Kekule.BondType.COVALENT)&&(this.getBondOrder()===Kekule.BondOrder.TRIPLE)},isAromatic:function(){return(!!this.getIsInAromaticRing()||(this.getBondOrder()===Kekule.BondOrder.EXPLICIT_AROMATIC))&&(this.getBondType()===Kekule.BondType.COVALENT)},isBondBetween:function(e,d){var h=this.getConnectedObjs();if(h.length!==2){return false}var c,b;for(var f=0,a=h.length;f<a;++f){var g=h[f];if(g instanceof Kekule.Atom){if(g.isElement(e)){c=true}else{if(g.isElement(d)){b=true}}if(c&&b){return true}}}return false}});Kekule.ChemStructureObjectGroup=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.ChemStructureObjectGroup",ITEM_BASE_CLASSES:["Kekule.ChemStructureObject","Kekule.ChemStructureObjectGroup"],initialize:function($super,a){$super(a);this.setPropStoreFieldValue("items",[]);this.setPropStoreFieldValue("raiseExceptionOnTypeMismatch",[])},initProperties:function(){this.defineProp("items",{dataType:DataType.ARRAY});this.defineProp("raiseExceptionOnTypeMismatch",{dataType:DataType.BOOL,defaultValue:true,scope:Class.PropertyScope.PUBLIC})},getAutoIdPrefix:function(){return"sg"},getStructureRelatedPropNames:function($super){return $super().concat(["items"])},doGetComparisonPropNames:function($super,b){var a=$super(b);if(b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){a.push("items")}return a},ownerChanged:function($super,b){var c=this.getItems();for(var d=0,a=c.length;d<a;++d){var e=c[d].obj;if(e&&e.setOwner){e.setOwner(b)}}$super(b)},_removeChildObj:function(b){var a=this.indexOfObj(b);if(a<0){a=this.indexOfItem(b)}if(a>=0){this.removeObjAt(a)}},getObjectBaseClasses:function(){return this.getPrototype().ITEM_BASE_CLASSES},ensureItemClass:function(d){var c=this.getObjectBaseClasses();if(c.length>0){for(var b=0,a=c.length;b<a;++b){if(d instanceof ClassEx.findClass(c[b])){return true}}if(this.getRaiseExceptionOnTypeMismatch()){var e=Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.CHEMSTRUCTUREOBJECTGROUP_ITEMCLASS_MISMATCH"):"Mismatched group item class";Kekule.raise(e)}return false}else{return true}},notifyItemsChanged:function(){this.notifyPropSet("items",this.getPropStoreFieldValue("items"))},indexOfItem:function(a){return this.getItems().indexOf(a)},indexOfObj:function(d){var b=this.getItems();for(var c=0,a=b.length;c<a;++c){if(b[c].obj==d){return c}}return -1},hasObj:function(a){return this.indexOfObj(a)>=0},setAttributesAt:function(c,b){var f=this.getItems()[c];if(f){var e=Kekule.ObjUtils.getOwnedFieldNames(b);for(var d=0,a=e.length;d<a;++d){f[e[d]]=b[e[d]]}}},getItemCount:function(){return this.getItems().length},getItemAt:function(a){return this.getItems()[a]},appendItem:function(a){this.getItems().push(a);return this},insertItem:function(b,a){return Kekule.ArrayUtils.insertUniqueEx(this.getItems(),b,a).index},removeItemAt:function(a){var b=this.getItems()[a];if(b){this.getItems().splice(a,1);this.notifyItemsChanged()}},removeItem:function(b){var a=this.getItems().indexOf(b);if(a>=0){this.removeItemAt(a)}},getObjAt:function(a){var b=this.getItemAt(a);return b?b.obj:null},insertObj:function(e,c,b){if(!e){return}if(this.indexOfObj(e)>=0){}else{if(this.ensureItemClass(e)){var d={obj:e};this.beginUpdate();try{var a=this.insertItem(d,c);if(b){this.setAttributesAt(a,b)}this.notifyItemsChanged()}finally{this.endUpdate()}return a}}},appendObj:function(b,a){return this.insertObj(b,null,a)},removeObjAt:function(a){var b=this.getItems()[a];if(b){this.getItems().splice(a,1);this.notifyItemsChanged()}},removeObj:function(b){var a=this.indexOfObj(b);if(a>=0){this.removeObjAt(a)}},getAllObjs:function(){var a=[];for(var c=0,b=this.getItemCount();c<b;++c){a.push(this.getObjAt(c))}return a},getChildCount:function(){return this.getItemCount()},getChildAt:function(a){return this.getObjAt(a)},indexOfChild:function(b){var a=this.indexOfObj(b);if(a<0){a=this.indexOfItem(b)}return a},getNextSiblingOfChild:function(b){var a=this.indexOfItem(b);if(a<0){a=this.indexOfObj(b)}return(a>=0)?this.getChildAt(index+1):null},appendChild:function(a){if(a instanceof Kekule.ChemObject){return this.appendObj(a)}else{return this.appendItem(a)}},insertChild:function(b,a){if(b instanceof Kekule.ChemObject){return this.insertObj(b,a)}else{return this.insertItem(b)}},insertBefore:function(b,a){var c=this.indexOfItem(a);if(c<0){c=this.indexOfObj(a)}return this.insertChild(b,a)},removeChildAt:function(a){return this.removeItemAt(a)},removeChild:function(b){var a=this.indexOfItem(b);if(a<=0){a=this.indexOfObj(b)}if(a>=0){this.removeItemAt(a)}}});Kekule.StructureFragmentGroup=Class.create(Kekule.ChemStructureObjectGroup,{CLASS_NAME:"Kekule.ChemStructureObjectGroup",ITEM_BASE_CLASSES:["Kekule.StructureFragment","Kekule.StructureFragmentGroup"]});Kekule.MoleculeGroup=Class.create(Kekule.ChemStructureObjectGroup,{CLASS_NAME:"Kekule.MoleculeGroup",ITEM_BASE_CLASSES:["Kekule.Molecule","Kekule.MoleculeGroup"]});Kekule.CompositeMolecule=Class.create(Kekule.Molecule,{CLASS_NAME:"Kekule.CompositeMolecule",initialize:function($super,b,a){$super(b,a)},initProperties:function(){this.defineProp("subMolecules",{dataType:"Kekule.MoleculeGroup",getter:function(){if(!this.getPropStoreFieldValue("subMolecules")){this.setPropStoreFieldValue("subMolecules",new Kekule.MoleculeGroup())}return this.getPropStoreFieldValue("subMolecules")}})},doGetComparisonPropNames:function($super,b){var a=$super(b);if(b.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){a.push("subMolecules")}return a},ownerChanged:function($super,a){var b=this.getPropStoreFieldValue("subMolecules");if(b){b.setOwner(a)}$super(a)},getSubMoleculeCount:function(){var a=this.getPropStoreFieldValue("subMolecules");return a?a.length:0},hasCtab:function(){return false},hasFormula:function(){return false},getAllContainingConnectors:function(){var g=this.getSubMolecules();var c=[];for(var f=0,e=g.getItemCount();f<e;++f){var b=g.getObjAt(f);if(b.getAllContainingConnectors){var d=b.getAllContainingConnectors();if(d&&d.length){c=c.concat(d)}}}return c},getContainerBox:function(f){var a=null;var d=this.getPropStoreFieldValue("subMolecules");if(d){for(var c=0,b=d.getItemCount();c<b;++c){var g=d.getObjAt(c);var e=g.getContainerBox(f);if(e){if(!a){a=Object.extend({},e)}else{a=Kekule.BoxUtils.getContainerBox(a,e)}}}}return a},doGetCtab:function(){return null},doSetCtab:function(){},doGetFormula:function(){return null},doSetFormula:function(){},getChildCount:function(){return this.getSubMolecules().getChildCount()},getChildAt:function(a){return this.getSubMolecules().getChildAt(a)},indexOfChild:function(a){return this.getSubMolecules().indexOfChild(a)},getNextSiblingOfChild:function(a){return this.getSubMolecules().getNextSiblingOfChild(a)},appendChild:function(a){return this.getSubMolecules().appendChild(a)},insertChild:function(b,a){return this.getSubMolecules().insertChild(b,a)},insertBefore:function(b,a){return this.getSubMolecules().insertBefore(b,a)},removeChildAt:function(a){return this.getSubMolecules().removeChildAt(a)},removeChild:function(a){return this.getSubMolecules().removeChild(a)}});Kekule.MoleculeList=Class.create(Kekule.ChemObjList,{CLASS_NAME:"Kekule.MoleculeList",initialize:function($super,a){$super(a,Kekule.Molecule)}});Kekule.ChemStructureNodeLabels={ENABLE_ISOTOPE_ALIAS:true,UNSET_ELEMENT:"?",DUMMY_ATOM:"Du",HETERO_ATOM:"Q",ANY_ATOM:"A",CUSTOM_ATOM:"@",VARIABLE_ATOM:"L",SUBGROUP:"R",ISO_LIST_LEADING_BRACKET:"[",ISO_LIST_TAILING_BRACKET:"]",ISO_LIST_DELIMITER:",",ISO_LIST_DISALLOW_PREFIX:"NOT"};Kekule.ChemStructureNodeFactory={CANDIDATE_CLASSES:[Kekule.SubGroup,Kekule.VariableAtom,Kekule.Pseudoatom],getClassByLabel:function(m,a){if(a===undefined){a=Kekule.Pseudoatom}var f=Kekule.ChemStructureNodeLabels;var g=[[f.SUBGROUP],[f.VARIABLE_ATOM],[f.DUMMY_ATOM,f.HETERO_ATOM,f.ANY_ATOM,f.CUSTOM_ATOM]];var b=Kekule.ChemStructureNodeFactory.CANDIDATE_CLASSES;var k;for(var e=0,d=b.length;e<d;++e){var j=b[e];var h=g[e];if(h.indexOf(m)>=0){k=j;break}}if(!k){if(Kekule.IsotopesDataUtil.isIsotopeIdAvailable(m)){k=Kekule.Atom}else{k=a}}return k},createByLabel:function(b){var c=Kekule.ChemStructureNodeFactory.getClassByLabel(b);var a=new c();if(a instanceof Kekule.Pseudoatom){a.setSymbol(b)}else{if(a instanceof Kekule.Atom){a.setIsotopeId(b)}}return a}}})();Kekule.ChemStructureBuilder=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ChemStructureBuilder",initialize:function($super,a){$super();if(a){this.setTarget(a)}},initProperties:function(){this.defineProp("target",{dataType:"Kekule.StructureFragment"})},setNodeCoord:function(){var c=Array.prototype.slice.call(arguments);var e=c.shift();var f=c;for(var d=0,b=f.length;(d<b)&&(d<2);++d){var g=f[d];if(g.z!==undefined){e.setCoordOfMode(g,Kekule.CoordMode.COORD3D)}else{e.setCoordOfMode(g,Kekule.CoordMode.COORD2D)}}},createNode:function(){var c=Array.prototype.slice.call(arguments);var d=c.shift();var f=c.shift();var e=c;var b=new d(f);this.setNodeCoord(b,e);this.appendNode(b);return b},createConnector:function(b,d,c){var a=new b(d);a.setConnectedObjs(c);return a},appendNode:function(a){if(a&&this.getTarget()){return this.getTarget().appendNode(a)}else{return null}},appendConnector:function(a){if(a&&this.getTarget()){return this.getTarget().appendConnector(a)}else{return null}},createAtom:function(){var e=Array.prototype.slice.call(arguments);var f=e.shift();var c=e.shift();var d=e.shift();var b=new Kekule.Atom(f,c,d);e.unshift(b);this.setNodeCoord.apply(this,e);this.appendNode(b);return b},createBond:function(f,e,c,d,b){var a=new Kekule.Bond(f,e,c);a.changeBondForm(c,null,b);if(d){a.setStereo(d)}this.appendConnector(a);return a},deleteNode:function(){},marshalSubGroup:function(a,d){var c=this.getTarget();if(c&&c.hasCtab()){var b=new Kekule.SubGroup(d);c.marshalSubFragment(a,b);return b}else{return null}}});Kekule.ReactionComponent={REACTANT:"reactant",PRODUCT:"product",SUBSTANCE:"substance",CONDITION:"condition"};Kekule.ReactionRole={REAGENT:"reagent",CATALYST:"catalyst",SOLVENT:"solvent",TEMPERATURE:"temperature",DURATION:"duration"};Kekule.ReactionDirection={FORWARD:1,BACKWARD:-1,BIDIRECTION:0};Kekule.Reaction=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Reaction",initialize:function($super,a){$super(a);this.setDirection(Kekule.ReactionDirection.FORWARD)},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING});this.defineProp("title",{dataType:DataType.STRING});this.defineProp("reactionType",{dataType:DataType.STRING});this.defineProp("yield",{dataType:DataType.FLOAT});this.defineProp("direction",{dataType:DataType.INT,defaultValue:Kekule.ReactionDirection.FORWARD,enumSource:Kekule.ReactionDirection});this.defineProp("reactants",{dataType:DataType.ARRAY,setter:null,getter:function(b){var a=this.getPropStoreFieldValue("reactants");if((!a)&&b){a=[];this.setPropStoreFieldValue("reactants",a)}return a}});this.defineProp("products",{dataType:DataType.ARRAY,setter:null,getter:function(b){var a=this.getPropStoreFieldValue("products");if((!a)&&b){a=[];this.setPropStoreFieldValue("products",a)}return a}});this.defineProp("substances",{dataType:DataType.ARRAY,setter:null,getter:function(b){var a=this.getPropStoreFieldValue("substances");if((!a)&&b){a=[];this.setPropStoreFieldValue("substances",a)}return a}});this.defineProp("conditions",{dataType:DataType.ARRAY,setter:null,getter:function(b){var a=this.getPropStoreFieldValue("conditions");if((!a)&&b){a=[];this.setPropStoreFieldValue("conditions",a)}return a}})},ownerChanged:function($super,f){var g=["reactants","products","substances","conditions"];for(var e=0,b=g.length;e<b;++e){var h=g[e];var m=this.getComponentArray(h);if(m){for(var d=0,c=m.length;d<c;++d){var n=m[d].item;if(n.setOwner){n.setOwner(f)}}}}$super(f)},assertAddingMolecule:function(a){if(!(a instanceof Kekule.Molecule)){Kekule.chemError(Kekule.$L("ErrorMsg.UNABLE_ADD_NONMOLECULE_MAP"))}},notifyReactantsChange:function(){this.notifyPropSet("reactants",this.getPropStoreFieldValue("reactants"))},notifyProductsChange:function(){this.notifyPropSet("products",this.getPropStoreFieldValue("products"))},notifySubstancesChange:function(){this.notifyPropSet("substances",this.getPropStoreFieldValue("substances"))},notifyConditionsChange:function(){this.notifyPropSet("conditions",this.getPropStoreFieldValue("conditions"))},notifyComponentChange:function(a){var b=this.componentToPropName(a);if(b){this.notifyPropSet(b,this.getPropStoreFieldValue(b))}},componentToPropName:function(a){return a+"s"},getComponentArray:function(a,c){var b=this.componentToPropName(a);if(b){switch(b){case"reactants":return this.doGetReactants(c);break;case"products":return this.doGetProducts(c);break;case"substances":return this.doGetSubstances(c);break;case"conditions":return this.doGetConditions(c);break;default:return null}}else{return null}},getComponentItemCount:function(c){var b=this.getComponentArray(c);return b?b.length:0},getMapAt:function(d,c){var b=this.getComponentArray(d);return b?b[c]:null},getMapItemAt:function(b,a){var c=this.getMapAt(b,a);return c?c.item:null},indexOfMap:function(c,d){var b=this.getComponentArray(c);return b?b.indexOf(d):-1},indexOfItem:function(d,f,g){var c=this.getComponentArray(d);if(c){for(var e=0,b=c.length;e<b;++e){if(c[e].item==f){if(typeof(g)==="undefined"){return e}else{if(g===c[e].role){return e}}}}}return -1},appendMap:function(a,c){if((a==Kekule.ReactionComponent.PRODUCT)||(a==Kekule.ReactionComponent.REACTANT)){this.assertAddingMolecule(c.item)}var b=Kekule.ArrayUtils.pushUniqueEx(this.getComponentArray(a,true),c);if(b.isPushed){this.notifyComponentChange(a)}return b.index},appendItem:function(b,e,g,c){var a=this.indexOfItem(b,e,g);if(a<0){if((b==Kekule.ReactionComponent.PRODUCT)||(b==Kekule.ReactionComponent.REACTANT)){this.assertAddingMolecule(e)}var f=Kekule.RoleMapUtils.createMap(e,g);if(c){Object.extend(f,c)}var d=Kekule.ArrayUtils.pushUniqueEx(this.getComponentArray(b,true),f);this.notifyComponentChange(b);return d.index}else{return a}},removeMapAt:function(d,c){var e=null;var b=this.getComponentArray(d);if(b){e=Kekule.ArrayUtils.removeAt(b,c);if(e){this.notifyComponentChange(d)}}return e},removeMap:function(c,e){var d=null;var b=this.getComponentArray(c);if(b){d=Kekule.ArrayUtils.remove(b,e);if(d){this.notifyComponentChange(c)}}return d},removeItem:function(b,c,d){var a=this.indexOfItem(b,c,d);if(a>=0){return this.removeMapAt(b,a)}else{return null}},clearComponent:function(c){var b=this.getComponentArray(c);b=[];this.notifyComponentChange(c)},getReactantCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.REACTANT)},getProductCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.PRODUCT)},getSubstancesCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.SUBSTANCE)},getConditionCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.CONDITION)},getReactantMapAt:function(a){return this.getMapAt(Kekule.ReactionComponent.REACTANT,a)},getProductMapAt:function(a){return this.getMapAt(Kekule.ReactionComponent.PRODUCT,a)},getSubstanceMapAt:function(a){return this.getMapAt(Kekule.ReactionComponent.SUBSTANCE,a)},getConditionMapAt:function(a){return this.getMapAt(Kekule.ReactionComponent.CONDITION,a)},getReactantItemAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.REACTANT,a)},getReactantAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.REACTANT,a)},getProductItemAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.PRODUCT,a)},getProductAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.PRODUCT,a)},getSubstanceItemAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.SUBSTANCE,a)},getSubstanceAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.SUBSTANCE,a)},getConditionItemAt:function(a){return this.getMapItemAt(Kekule.ReactionComponent.CONDITION,a)},indexOfReactantMap:function(a){return this.indexOfMap(Kekule.ReactionComponent.REACTANT,a)},indexOfProductMap:function(a){return this.indexOfMap(Kekule.ReactionComponent.PRODUCT,a)},indexOfSubstanceMap:function(a){return this.indexOfMap(Kekule.ReactionComponent.SUBSTANCE,a)},indexOfConditionMap:function(a){return this.indexOfMap(Kekule.ReactionComponent.CONDITION,a)},indexOfReactant:function(a,b){return this.indexOfItem(Kekule.ReactionComponent.REACTANT,a,b)},indexOfProduct:function(a,b){return this.indexOfItem(Kekule.ReactionComponent.PRODUCT,a,b)},indexOfSubstance:function(a,b){return this.indexOfItem(Kekule.ReactionComponent.SUBSTANCE,a,b)},indexOfCondition:function(a,b){return this.indexOfItem(Kekule.ReactionComponent.CONDITION,a,b)},appendReactantMap:function(a){return this.appendMap(Kekule.ReactionComponent.REACTANT,a)},appendProductMap:function(a){return this.appendMap(Kekule.ReactionComponent.PRODUCT,a)},appendSubstanceMap:function(a){return this.appendMap(Kekule.ReactionComponent.SUBSTANCE,a)},appendConditionMap:function(a){return this.appendMap(Kekule.ReactionComponent.CONDITION,a)},appendReactant:function(c,e,a,b){var d=b||{};if(a){d.amount=a}return this.appendItem(Kekule.ReactionComponent.REACTANT,c,e,d)},appendProduct:function(c,e,a,b){var d=b||{};if(a){d.amount=a}return this.appendItem(Kekule.ReactionComponent.PRODUCT,c,e,d)},appendSubstance:function(c,e,a,b){var d=b||{};if(a){d.amount=a}return this.appendItem(Kekule.ReactionComponent.SUBSTANCE,c,e,d)},appendCondition:function(b,c,a){return this.appendItem(Kekule.ReactionComponent.CONDITION,b,c,info)},removeReactantAt:function(a){return this.removeMapAt(Kekule.ReactionComponent.REACTANT,a)},removeProductAt:function(a){return this.removeMapAt(Kekule.ReactionComponent.PRODUCT,a)},removeSubstanceAt:function(a){return this.removeMapAt(Kekule.ReactionComponent.SUBSTANCE,a)},removeConditionAt:function(a){return this.removeMapAt(Kekule.ReactionComponent.CONDITION,a)},removeReactantMap:function(a){return this.removeMap(Kekule.ReactionComponent.REACTANT,a)},removeProductMap:function(a){return this.removeMap(Kekule.ReactionComponent.PRODUCT,a)},removeSubstanceMap:function(a){return this.removeMap(Kekule.ReactionComponent.SUBSTANCE,a)},removeConditionMap:function(a){return this.removeMap(Kekule.ReactionComponent.CONDITION,a)},removeReactant:function(a,b){return this.removeItem(Kekule.ReactionComponent.REACTANT,a,b)},removeProduct:function(a,b){return this.removeItem(Kekule.ReactionComponent.PRODUCT,a,b)},removeSubstance:function(a,b){return this.removeItem(Kekule.ReactionComponent.SUBSTANCE,a,b)},removeCondition:function(a,b){return this.removeItem(Kekule.ReactionComponent.CONDITION,a,b)},clearReactants:function(){return this.clearComponent(Kekule.ReactionComponent.REACTANT)},clearProducts:function(){return this.clearComponent(Kekule.ReactionComponent.PRODUCT)},clearSubstance:function(){return this.clearComponent(Kekule.ReactionComponent.SUBSTANCE)},clearConditions:function(){return this.clearComponent(Kekule.ReactionComponent.CONDITION)},clearAll:function(){this.clearProducts();this.clearProducts();this.clearSubstance();this.clearConditions()},getAllContainingConnectors:function(){var b=Kekule.ReactionComponent;var c=[b.REACTANT,b.PRODUCT,b.SUBSTANCE];var o=[];for(var g=0,d=c.length;g<d;++g){var h=c[g];for(var f=0,e=this.getComponentItemCount(h);f<e;++f){var n=this.getMapItemAt(h,f);if(n.getAllContainingConnectors){var m=mols[g].getAllContainingConnectors();if(m&&m.length){o=o.concat(m)}}}}return o}});Kekule.ReactionList=Class.create(Kekule.ChemObjList,{CLASS_NAME:"Kekule.ReactionList",initialize:function($super,a){$super(a,Kekule.Reaction)}});(function(){Kekule.ChemStructureUtils={getConnectorLengthMedian:function(d,j,e){var f=[];for(var k=0,g=d.length;k<g;++k){var h=d[k];if(h&&h.getLength){var c=h.getLength(j,e);if(c){f.push(c)}}}if(g===0){return 1}if(g<=1){return f[0]}else{f.sort();var m=f.length;var n=(m%2)?f[(m+1)>>1]:(f[m>>1]+f[(m>>1)-1])/2;return n}},getChildStructureObjs:function(k,g){var d;if(k instanceof Kekule.CompositeMolecule){d=k.getSubMolecules().getAllObjs()}else{if(k instanceof Kekule.ChemStructureObjectGroup){d=k.getAllObjs()}else{if(k instanceof Kekule.ChemObjList){d=k.getItems()}else{if(k instanceof Kekule.ChemSpaceElement){d=k.getChildren().getItems()}else{if(k instanceof Kekule.ChemSpace){d=k.getChildren()}else{return[k]}}}}}d=[].concat(d);if(g){var f=[];for(var h=0,e=d.length;h<e;++h){var j=d[h];var c=Kekule.ChemStructureUtils.getChildStructureObjs(j,g);if(c.length<=1){Kekule.ArrayUtils.pushUnique(f,j)}else{Kekule.ArrayUtils.pushUnique(f,c)}}d=f}return d},getAllStructFragments:function(h,e){if(h instanceof Kekule.StructureFragment){return[h]}var g=Kekule.ChemStructureUtils.getChildStructureObjs(h,e);var c=[];for(var f=0,d=g.length;f<d;++f){if(g[f] instanceof Kekule.StructureFragment){Kekule.ArrayUtils.pushUnique(c,g[f])}}return c},getTotalStructFragment:function(f,d){var c=Kekule.ChemStructureUtils.getAllStructFragments(f,true);var e=c.length;if(e<=0){return null}else{if(e===1){return c[0]}else{return Kekule.ChemStructureUtils.mergeStructFragments(c,d)}}},getCascadeDeleteObjs:function(h){var m=[];var j=h.getLinkedConnectors?h.getLinkedConnectors():[];for(var f=0,c=j.length;f<c;++f){var d=j[f];if(d.getConnectedObjs().length<=2){Kekule.ArrayUtils.pushUnique(m,d);var k=Kekule.ChemStructureUtils.getCascadeDeleteObjs(d);Kekule.ArrayUtils.pushUnique(m,k)}}if(h instanceof Kekule.ChemStructureNode){}else{if(h instanceof Kekule.ChemStructureConnector){var g=h.getConnectedObjs();for(var f=0,c=g.length;f<c;++f){var e=g[f];if(e instanceof Kekule.ChemStructureNode){if(e.getLinkedConnectors().length<=1){Kekule.ArrayUtils.pushUnique(m,e)}}}}else{}}return m},moveChildBetweenStructFragment:function(g,c,d,f,e){return Kekule.StructureFragment.moveChildBetweenStructFragment(g,c,d,f,e)},_getCascadeConnectedNodesAndConnectors:function(f,d){var e=[];var c=[];var m=f.getConnectedObjs();for(var i=0,g=m.length;i<g;++i){var l=m[i];if(l!==f){if(d){l=d.findDirectChildOfObj(l)}if(l instanceof Kekule.ChemStructureNode){Kekule.ArrayUtils.pushUnique(c,l)}else{if(l instanceof Kekule.ChemStructureConnector){Kekule.ArrayUtils.pushUnique(e,l);var h=Kekule.ChemStructureUtils._getCascadeConnectedNodesAndConnectors(l);Kekule.ArrayUtils.pushUnique(e,h.connectors);Kekule.ArrayUtils.pushUnique(c,h.nodes)}}}}return{connectors:e,nodes:c}},mergeStructFragments:function(d,g){if(d.length<=1){return d[0]}else{var h=g||Kekule.Molecule;var c=new h();for(var f=0,e=d.length;f<e;++f){var j=d[f].clone();Kekule.ChemStructureUtils.moveChildBetweenStructFragment(j,c,j.getNodes(),j.getConnectors())}return c}},splitStructFragment:function(s){if(!s.hasCtab()){return[s]}var e=s.getNodes();if(e.length<=0){return[s]}var n=s.getConnectors();var t=[];var r=[e[0]];var j=[];var d=0;do{var h=r[d];var g=h.getLinkedConnectors();if(h.getCrossConnectors){g.concat(h.getCrossConnectors()||[])}Kekule.ArrayUtils.pushUnique(j,g);for(var q=0,k=g.length;q<k;++q){var p=Kekule.ChemStructureUtils._getCascadeConnectedNodesAndConnectors(g[q],s);Kekule.ArrayUtils.pushUnique(j,p.connectors);Kekule.ArrayUtils.pushUnique(r,p.nodes)}++d}while(d<r.length);t.push(s);var f=Kekule.ArrayUtils.exclude(e,r);var m=Kekule.ArrayUtils.exclude(n,j);if(f.length>0){var c=s.getClass();var o=new c();Kekule.ChemStructureUtils.moveChildBetweenStructFragment(s,o,f,m);var u=Kekule.ChemStructureUtils.splitStructFragment(o);t=t.concat(u)}return t},getAbsCoordVectorBetweenObjs:function(h,g,e,c){var f=h.getAbsCoordOfMode(e,c);var d=g.getAbsCoordOfMode(e,c);return Kekule.CoordUtils.substract(d,f)}};Kekule.TokenAnalyzer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.TokenAnalyzer",initialize:function($super,c){$super();this.setSrcText(c)},initProperties:function(){this.defineProp("srcText",{dataType:DataType.STRING,setter:function(d){var c=d||"";this.setPropStoreFieldValue("srcText",c);this.setPropStoreFieldValue("srcLength",c.length);this.setCurrPos(0)}});this.defineProp("srcLength",{dataType:DataType.INT,setter:null,serializable:false});this.defineProp("currPos",{dataType:DataType.INT,serializable:false})},getCharType:function(d){return 0},isCharTypeMatched:function(d,c){return d===c},nextCharInfo:function(){var d=this.getCurrPos();if(d>=this.getSrcLength()){return null}else{var e=this.getSrcText().charAt(d);this.setCurrPos(d+1);return{"char":e,charType:this.getCharType(e)}}},nextTokenInfo:function(){var e=this.nextCharInfo();if(e){var d=e["char"];var f=e.charType;var c=this.nextCharInfo();while(c&&this.isCharTypeMatched(c.charType,e.charType)){d+=c["char"];e=c;c=this.nextCharInfo()}if(c){this.setCurrPos(this.getCurrPos()-1)}return{token:d,tokenType:f}}else{return null}},getAllTokenInfos:function(){var c=[];var d=this.nextTokenInfo();while(d){c.push(d);d=this.nextTokenInfo()}return c}});Kekule.ChemTextTypes={CT_ATOM_SYMBOL_LEADING:1,CT_ATOM_SYMBOL_FOLLOWING:2,CT_CHARGE_SYMBOL:3,CT_NUMBER:4,CT_BRACKET_LEADING:10,CT_BRACKET_TAILING:11,CT_SEPARATOR:20,CT_UNKNOWN:0};var a=Kekule.ChemTextTypes;Kekule.ChemTextAnalyzer=Class.create(Kekule.TokenAnalyzer,{CLASS_NAME:"Kekule.ChemTextAnalyzer",getCharType:function(d){if(d===" "){return a.CT_SEPARATOR}if(d>="0"&&d<="9"){return a.CT_NUMBER}else{if(["+","-"].indexOf(d)>=0){return a.CT_CHARGE_SYMBOL}else{if(["(","[","{"].indexOf(d)>=0){return a.CT_BRACKET_LEADING}else{if([")","]","}"].indexOf(d)>=0){return a.CT_BRACKET_TAILING}else{if(d>="A"&&d<="Z"){return a.CT_ATOM_SYMBOL_LEADING}else{if(d>="a"&&d<="z"){return a.CT_ATOM_SYMBOL_FOLLOWING}else{return a.CT_UNKNOWN}}}}}}},isCharTypeMatched:function(d,c){if(Kekule.ArrayUtils.intersect([a.CT_BRACKET_LEADING,a.CT_BRACKET_TAILING],[d,c]).length){return false}else{return(d===c&&c!==a.CT_ATOM_SYMBOL_LEADING)||(c===a.CT_ATOM_SYMBOL_LEADING&&d===a.CT_ATOM_SYMBOL_FOLLOWING)}}});Kekule.FormulaUtils={FORMULA_BRACKETS:[["(",")"],["[","]"],["{","}"]],FORMULA_BRACKET_TYPE_COUNT:3,textToFormula:function(q,l,d){var n=d||null;if(n){n.clear()}var y=new Kekule.ChemTextAnalyzer(q);try{var A=y.getAllTokenInfos();if(!n){n=new Kekule.MolecularFormula(l)}var r=A.length;if(r){var v,u,e=null,m;var f=n;u={};var B=function(){u={}};var z=function(){if(u&&u.obj){f.appendSection(u.obj,u.count,u.charge)}};for(var x=0;x<r;++x){var s=A[x];var C=s.tokenType;var g=s.token;var k=false;if(C===a.CT_BRACKET_LEADING){z();var j=new Kekule.MolecularFormula(l);j._parentFormula=f;f=j;B();k=true}else{if(C===a.CT_BRACKET_TAILING){z();B();u.obj=f;f=f._parentFormula;s.asSymbol=true;k=true}else{if([a.CT_ATOM_SYMBOL_LEADING,a.CT_ATOM_SYMBOL_FOLLOWING].indexOf(C)>=0){if(u.obj){z();B()}var c=u.massNum;if(!c){if(e&&!e.handled&&(e.tokenType===a.CT_NUMBER)){c=parseInt(e.token,10)||null}}var o=""+(c||"")+g;u.obj=Kekule.ChemStructureNodeFactory.createByLabel(o);s.asSymbol=true;k=true}else{if(C===a.CT_CHARGE_SYMBOL){m=(g==="+")?+1:-1;s.asCharge=true;if(e.tokenType===a.CT_NUMBER){var w;if(e.asCount){if(e.token.length>1){var p=e.token;w=p.substr(p.length-1);if(e.asCount){u.count=parseInt(p.substring(0,p.length-1),10)}}else{w=e.token;if(e.asCount){u.count=1}}}else{w=e.token;e.asChargeCount=true}m*=parseInt(w,10)}u.charge=m;k=true}else{if(C===a.CT_NUMBER){var h=parseInt(g,10);if(m&&e.tokenType===a.CT_CHARGE_SYMBOL&&e.asCharge){m*=h;u.charge=m;s.asChargeCount=true;k=true}else{if(u.obj&&e.asSymbol){u.count=h;s.asCount=true;k=true}else{if(!u.obj){u.massNum=h;k=true}else{}}}}}}}}s.handled=k;e=s}if(u&&u.obj){z()}}return n}finally{y.finalize()}},formulaToText:function(e,d,c){if(Kekule.ObjUtils.isUnset(d)){d=true}return b._convFormulaToText(e,false,d,c)},_convFormulaToText:function(m,s,o,f){var t="";var q=m.getSections();if(s){var d=m.getMaxNestedLevel()%b.FORMULA_BRACKET_TYPE_COUNT;var n=b.FORMULA_BRACKETS[d][0];var c=b.FORMULA_BRACKETS[d][1];t+=n}for(var h=0,e=q.length;h<e;++h){var g=q[h].obj;var k=m.getSectionCharge(q[h]);var p=null;if(g instanceof Kekule.MolecularFormula){p=b._convFormulaToText(g,true,false,false,f)}else{if(g.getLabel){var p=g.getLabel();if(g.getMassNumber&&g.getMassNumber()){p=(t?" ":"")+p}}}if(p){var j=false;if(q[h].count!=1){p+=q[h].count;j=true}if(o&&k){var r=b._convChargeToText(k,f);p+=(j?" ":"")+r}t+=p}}if(s){t+=c}if(o){var k=m.getCharge();if(k){var r=b._convChargeToText(k,f);t+=r}}return t},_convChargeToText:function(f,c){if(!f){return null}var g=(f>0)?"+":"-";var d=Math.abs(f);var e=g;if(d!=1){e=(c?Kekule.NumUtils.toDecimals(d,c):d.toString())+g}return e}};var b=Kekule.FormulaUtils;ClassEx.defineProp(Kekule.MolecularFormula,"text",{dataType:DataType.STRING,serializable:false,getter:function(){return b.formulaToText(this)},setter:function(c){b.textToFormula(c,this.getParent(),this)}})})();(function(){Kekule.Glyph={};Kekule.Glyph.Base=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Glyph.Base",initialize:function($super,c,a,b){$super(c);if(a){this.setCoord2D(a)}if(b){this.setCoord3D(b)}},initProperties:function(){},getAutoIdPrefix:function(){return"g"}});Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.Glyph.Base)})();(function(){Kekule.Glyph.PathGlyphNode=Class.create(Kekule.BaseStructureNode,{CLASS_NAME:"Kekule.Glyph.PathGlyphNode",initialize:function($super,d,a,b,c){$super(d);if(b){this.setCoord2D(b)}if(c){this.setCoord3D(c)}this.setNodeType(a||Kekule.Glyph.NodeType.LOCATION)},initProperties:function(){this.defineProp("nodeType",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLIC})}});Kekule.Glyph.NodeType={LOCATION:"location",HIDDEN:"hidden"};Kekule.Glyph.PathGlyphConnector=Class.create(Kekule.BaseStructureConnector,{CLASS_NAME:"Kekule.Glyph.PathGlyphConnector",initialize:function($super,c,a,b){$super(c,b);this.setPathType(a)},initProperties:function(){this.defineProp("pathType",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLISHED,enumSource:Kekule.Glyph.PathType});this.defineProp("pathParams",{dataType:DataType.HASH,scope:Class.PropertyScope.PUBLISHED,getter:function(){var a=this.getPropStoreFieldValue("pathParams");if(!a){a={};this.setPropStoreFieldValue("pathParams",a)}return a},setter:function(a){if(!a){this.setPropStoreFieldValue("pathParams",null)}else{this.setPropStoreFieldValue("pathParams",Object.extend({},a,true))}}})}});Kekule.Glyph.PathType={LINE:"L"};Kekule.Glyph.ArrowType={NONE:null,OPEN:"open",TRIANGLE:"triangle"};Kekule.Glyph.ArrowSide={BOTH:0,SINGLE:1,REVERSED:-1};Kekule.Glyph.PathGlyph=Class.create(Kekule.Glyph.Base,{CLASS_NAME:"Kekule.Glyph.PathGlyph",initialize:function($super,e,a,b,c,d){$super(e,c,d);this.createDefaultStructure(a||1,b||{})},doFinalize:function($super){if(this.hasCtab()){this.getCtab().finalize()}$super()},initProperties:function(){this.defineProp("ctab",{dataType:"Kekule.StructureConnectionTable",scope:Class.PropertyScope.PUBLIC,getter:function(a){if(!this.getPropStoreFieldValue("ctab")){if(a){this.createCtab()}}return this.getPropStoreFieldValue("ctab")},setter:function(b){var a=this.getPropStoreFieldValue("ctab");if(a){a.finalize();a=null}if(b){b.setPropValue("parent",this,true);b.setOwner(this.getOwner())}this.setPropStoreFieldValue("ctab",b)}});this.defineProp("nodes",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNodes():[]}});this.defineProp("connectors",{dataType:DataType.ARRAY,serializable:false,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getConnectors():[]}})},createDefaultStructure:function(a,b){if(!a){a=1}var e={};var c=["lineGap","startArrowLength","startArrowWidth","endArrowLength","endArrowWidth"];for(var d in b){if(c.indexOf(d)>=0){e[d]=b[d]*a}else{e[d]=b[d]}}return this.doCreateDefaultStructure(a,e)},doCreateDefaultStructure:function(a,b){},getAutoIdPrefix:function(){return"p"},ownerChanged:function($super,a){if(this.hasCtab()){this.getCtab().setOwner(a)}$super(a)},_removeChildObj:function(b){if(this.hasCtab()){var a=this.getCtab();if(a===b){this.removeCtab()}else{if(a.hasChildObj(b)){a.removeChildObj(b)}}}},isEmpty:function(){return this.getCtab().isEmpty()},createCtab:function(){var a=new Kekule.StructureConnectionTable(this.getOwner(),this);this.setPropStoreFieldValue("ctab",a);a.addEventListener("propValueSet",function(b){if(b.propName=="nodes"){this.notifyPropSet(b.propName,b.propValue)}},this);a.setEnablePropValueSetEvent(true)},hasCtab:function(){return(!!this.getPropStoreFieldValue("ctab"))},getContainerBox:function($super,b,a){if(this.hasCtab()){return this.getCtab().getContainerBox(b,a)}else{return $super(b)}},getNodeById:function(a){return this.hasCtab()?this.getCtab().getNodeById(a):null},getConnectorById:function(a){return this.hasCtab()?this.getCtab().getConnectorById(a):null},getObjectById:function(b){var a=this.getNodeById(b);return a?a:this.getConnectorById(b)},getNodeCount:function(){return this.hasCtab()?this.getCtab().getNodeCount():0},getNodeAt:function(a){return this.hasCtab()?this.getCtab().getNodeAt(a):null},indexOfNode:function(a){return this.hasCtab()?this.getCtab().indexOfNode(a):-1},hasNode:function(b,a){return this.hasCtab()?the.getCtab().hasNode(b,a):null},appendNode:function(a){return this.doGetCtab(true).appendNode(a)},insertNodeAt:function(b,a){return this.doGetCtab(true).insertNodeAt(b,a)},removeNodeAt:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeNodeAt(b,a)},removeNode:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeNode(b,a)},replaceNode:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().replaceNode(b,a)},clearNodes:function(){if(this.hasCtab()){return this.getCtab().clearNodes()}},nodesHasCoord2D:function(a){if(!this.hasCtab()){return false}return this.getCtab().nodesHasCoord2D(a)},nodesHasCoord3D:function(a){if(!this.hasCtab()){return false}return this.getCtab().nodesHasCoord3D(a)},getConnectorCount:function(){return this.hasCtab()?this.getCtab().getConnectorCount():0},getConnectorAt:function(a){return this.hasCtab()?this.getCtab().getConnectorAt(a):null},indexOfConnector:function(a){return this.hasCtab()?this.getCtab().indexOfConnector(a):-1},hasConnector:function(a,b){return this.hasCtab()?this.getCtab().hasConnector(a,b):null},appendConnector:function(a){return this.doGetCtab(true).appendConnector(a)},insertConnectorAt:function(a,b){return this.doGetCtab(true).insertConnectorAt(a,b)},removeConnectorAt:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeConnectorAt(b,a)},removeConnector:function(b,a){if(!this.hasCtab()){return null}return this.getCtab().removeConnector(b,a)},clearConnectors:function(){if(this.hasCtab()){return this.getCtab().clearConnectors()}},insertBefore:function(b,a){if(this.hasCtab()){return this.getCtab().insertBefore(b,a)}else{console.log("no ctab")}},_getObjsNeedToBeCascadeRemoved:function(b,a){if(this.hasCtab()){return this.getCtab()._getObjsNeedToBeCascadeRemoved(b,a)}else{return[]}},removeChildObj:function(c,b,a){if(this.hasCtab()){this.getCtab().removeChildObj(c,b,a)}},removeChild:function(a){return this.removeChildObj(a)},hasChildObj:function(a){if(this.hasCtab()){return this.getCtab().hasChildObj(a)}else{return false}},getNextSiblingOfChild:function(a){if(this.hasCtab()){return this.getCtab().getNextSiblingOfChild(a)}else{return null}},getChildCount:function(){if(this.hasCtab()){return this.getCtab().getChildCount()}else{return 0}},getChildAt:function(a){if(this.hasCtab()){return this.getCtab().getChildAt(a)}else{return null}},indexOfChild:function(a){if(this.hasCtab()){return this.getCtab().indexOfChild(a)}else{return -1}}})})();(function(){var a=Kekule.Glyph.NodeType;var b=Kekule.Glyph.PathType;Kekule.Glyph.StraightLine=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.StraightLine",initialize:function($super,g,c,d,e,f){$super(g,c,d,e,f)},doCreateDefaultStructure:function(i,c){var d=Kekule.CoordUtils;var g={x:0,y:0};var f={x:0,y:0,z:0};var h={x:i*(c.lineLength||1)};var k=new Kekule.Glyph.PathGlyphNode(null,null,g,f);var j=new Kekule.Glyph.PathGlyphNode(null,null,d.add(g,h),d.add(f,h));var e=new Kekule.Glyph.PathGlyphConnector(null,b.LINE,[k,j]);this._applyParamsToConnector(e,c);this.appendNode(k);this.appendNode(j);this.appendConnector(e)},_applyParamsToConnector:function(c,d){c.setPathParams(d)}});Kekule.Glyph.Polygon=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.Polygon",initialize:function($super,g,c,d,e,f){$super(g,c,d,e,f)},getRefLengthRatio:function(){return 1},doCreateDefaultStructure:function(h,w){var n=Kekule.CoordUtils;var e={x:0,y:0};var j={x:0,y:0,z:0};var p=w.nodeProps;var l=w.connectorProps;var o=h*(w.lineLength||1)*this.getRefLengthRatio();var u=w.edgeCount||3;var m=Math.PI*2/u;var k=(u%2)?0:-m/2;var f=k;var s,g;for(var t=0;t<u;++t){var v={x:o*Math.sin(f),y:o*Math.cos(f)};var q=new Kekule.Glyph.PathGlyphNode(null,null,n.add(e,v),n.add(j,v));if(p){q.setPropValues(p)}this.appendNode(q);if(t===0){s=q}if(g){var d=new Kekule.Glyph.PathGlyphConnector(null,b.LINE,[g,q]);if(l){d.setPropValues(l)}this._applyParamsToConnector(d,w);this.appendConnector(d)}g=q;f+=m}var d=new Kekule.Glyph.PathGlyphConnector(null,b.LINE,[q,s]);if(l){d.setPropValues(l)}this._applyParamsToConnector(d,w);this.appendConnector(d)},_applyParamsToConnector:function(c,d){c.setPathParams(d)}})})();(function(){var a=Kekule.Glyph.NodeType;var b=Kekule.Glyph.PathType;Kekule.Glyph.HeatSymbol=Class.create(Kekule.Glyph.Polygon,{CLASS_NAME:"Kekule.Glyph.HeatSymbol",initialize:function($super,g,c,d,e,f){$super(g,c,d,e,f);this.setRenderOption("strokeWidth",1.5)},getRefLengthRatio:function(){return 0.25},doCreateDefaultStructure:function($super,c,d){d.edgeCount=3;d.nodeProps=Object.extend(d.nodeProps||{},{interactMode:Kekule.ChemObjInteractMode.HIDDEN});d.connectorProps=Object.extend(d.connectorProps||{},{interactMode:Kekule.ChemObjInteractMode.HIDDEN});return $super(c,d)},_applyParamsToConnector:function($super,c,d){return $super(c,d)}});Kekule.Glyph.AddSymbol=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.AddSymbol",initialize:function($super,g,c,d,e,f){$super(g,c,d,e,f);this.setRenderOption("strokeWidth",1.5)},getRefLengthRatio:function(){return 0.5},doCreateDefaultStructure:function(s,c){var o={interactMode:Kekule.ChemObjInteractMode.HIDDEN};var k={interactMode:Kekule.ChemObjInteractMode.HIDDEN};var d=Kekule.CoordUtils;var q={x:0,y:0};var n={x:0,y:0,z:0};var e=s*this.getRefLengthRatio()*(c.lineLength||1)/2;var f=new Kekule.Glyph.PathGlyphNode(null,null,q,n);f.setPropValues(o);this.appendNode(f);var p=[{x:-e,y:0},{x:0,y:-e},{x:e,y:0},{x:0,y:e}];for(var m=0,j=p.length;m<j;++m){var r=p[m];var g=new Kekule.Glyph.PathGlyphNode(null,null,d.add(q,r),d.add(n,r));g.setPropValues(o);var h=new Kekule.Glyph.PathGlyphConnector(null,b.LINE,[f,g]);h.setPropValues(k);this._applyParamsToConnector(h,c);this.appendNode(g);this.appendConnector(h)}},_applyParamsToConnector:function(c,d){c.setPathParams(d)}})})();(function(){var a=Kekule.CoordMode;var b=Kekule.CoordUtils;Kekule.ContentBlock=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ContentBlock",initialize:function($super,e,c,d){$super(e);if(c){this.setCoord2D(c)}if(d){this.setCoord3D(d)}},initProperties:function(){},getAutoIdPrefix:function(){return"b"},getCornerCoord1:function(d,c){return this.getCoordOfMode(d,c)},getCornerCoord2:function(e,c){var f=this.getCornerCoord1(e,c);var d=this.getSizeOfMode(e,c);return Kekule.CoordUtils.add(f,d)},getContainerBox:function($super,g,d){var h=this.getAbsCoordOfMode(g,d)||{};var e=this.getSizeOfMode(g,d)||{};if(g===Kekule.CoordMode.COORD3D){var f=Kekule.CoordUtils.add(h,this.getSizeOfMode(g,d)||{})}else{f={x:h.x+e.x,y:h.y-e.y}}var c=Kekule.BoxUtils.createBox(h,f);return c}});Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.ContentBlock);Kekule.ClassDefineUtils.addStandardSizeSupport(Kekule.ContentBlock);Kekule.TextBlock=Class.create(Kekule.ContentBlock,{CLASS_NAME:"Kekule.TextBlock",initialize:function($super,f,e,c,d){$super(f,c,d);this.setText(e||"")},initProperties:function(){this.defineProp("text",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"t"}});Kekule.ImageBlock=Class.create(Kekule.ContentBlock,{CLASS_NAME:"Kekule.ImageBlock",initialize:function($super,f,e,c,d){$super(f,c,d);if(e){this.setSrc(e)}},initProperties:function(){this.defineProp("src",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLISHED,setter:function(c){if(c!==this.getSrc()){this.setPropStoreFieldValue("src",c);this._clearCacheImg()}}});this.defineProp("cacheImg",{dataType:DataType.OBJECT,scope:Class.PropertyScope.PUBLIC,serializable:false,setter:null,getter:function(){var c=this.getPropStoreFieldValue("cacheImg");if(!c&&Kekule.$document){c=this._createCacheImg(this.getSrc())}return c}})},getAutoIdPrefix:function(){return"g"},_createCacheImg:function(e){var c;var d=Kekule.$document;if(d&&d.body&&d.createElement){c=d.createElement("img");c.src=e}return c},_clearCacheImg:function(){var c=this.getPropStoreFieldValue("cacheImg");if(c){c.src="";try{delete c.width;delete c.height}catch(d){}}}})})();