(function(){var a=Kekule.ArrayUtils;Kekule.GraphElement=Class.create(ObjectEx,{CLASS_NAME:"Kekule.GraphElement",initialize:function($super){$super();this._data={}},initProperties:function(){this.defineProp("storedData",{dataType:DataType.HASH,getter:function(){return this._data},setter:function(b){this._data=b||{}}})},getData:function(b){return b?this._data[b]:this._data},setData:function(b,c){if(b){this._data[b]=c}return this},removeData:function(b){if(this._data[b]){delete this._data[b]}return this}});Kekule.GraphVertex=Class.create(Kekule.GraphElement,{CLASS_NAME:"Kekule.GraphVertex",initialize:function($super){$super();this.setPropStoreFieldValue("edges",[])},initProperties:function(){this.defineProp("edges",{dataType:DataType.ARRAY,serializable:false,setter:null})},getEdgeCount:function(){return this.getEdges().length},getNeighbors:function(){var b=[];var d=this.getEdges();for(var e=0,c=d.length;e<c;++e){var f=d[e].getVertexes();a.pushUnique(b,a.exclude(f,this))}return b},getNeighborOnEdge:function(d){var e=d.getVertexes();for(var c=0,b=e.length;c<b;++c){if(e[c]!==this){return e[c]}}},getEdgeTo:function(c){var d=this.getEdges();for(var e=0,b=d.length;e<b;++e){var f=d[e].getVertexes();if(f.indexOf(c)>=0){return d[e]}}return null},doAppendEdge:function(b){Kekule.ArrayUtils.pushUnique(this.getEdges(),b);return this},doRemoveEdge:function(b){Kekule.ArrayUtils.remove(this.getEdges(),b);return this},doClearEdges:function(){var b=this.getEdges();for(var c=b.length-1;c>=0;--c){this.removeEdge(b[c])}return this}});Kekule.GraphEdge=Class.create(Kekule.GraphElement,{CLASS_NAME:"Kekule.GraphEdge",initialize:function($super){$super();this.setPropStoreFieldValue("vertexes",[])},initProperties:function(){this.defineProp("vertexes",{dataType:DataType.ARRAY,serializable:false,setter:null})}});Kekule.GraphTraverseMode={DEPTH_FIRST:0,BREADTH_FIRST:1};Kekule.Graph=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Graph",VISITED_KEY:"__$visited__",initialize:function($super){$super();this.setPropStoreFieldValue("vertexes",[]);this.setPropStoreFieldValue("edges",[])},initProperties:function(){this.defineProp("vertexes",{dataType:DataType.ARRAY,serializable:false,setter:null});this.defineProp("edges",{dataType:DataType.ARRAY,serializable:false,setter:null})},addVertex:function(b){Kekule.ArrayUtils.pushUnique(this.getVertexes(),b);return this},newVertex:function(){var b=new Kekule.GraphVertex();this.addVertex(b);return b},removeVertex:function(e){if(Kekule.ArrayUtils.remove(this.getVertexes(),e)){var c=e.getEdges();for(var d=0,b=c.length;d<b;++d){this.removeEdge(c[d])}}},addEdge:function(d,c,b){if(Kekule.ArrayUtils.pushUnique(this.getEdges(),d)){d.setPropStoreFieldValue("vertexes",[c,b]);c.doAppendEdge(d);b.doAppendEdge(d)}return this},newEdge:function(d,c){var b=new Kekule.GraphEdge();this.addEdge(b,d,c);return b},removeEdge:function(e){var f=e.getVertexes();for(var d=0,b=f.length;d<b;++d){var c=f[d];c.doRemoveEdge(e)}Kekule.ArrayUtils.remove(this.getEdges(),e);return this},traverse:function(h,f,b){var m=[];var g=a.clone(this.getVertexes());for(var e=0,c=g.length;e<c;++e){g[e].setData(this.VISITED_KEY,false)}while(g.length){var j={vertexes:[],edges:[]};var d;if(b&&(g.indexOf(b)>=0)){d=b}else{d=g[0]}var k=this._doTravers(h,f,d);j.vertexes=j.vertexes.concat(k.vertexes);j.edges=j.edges.concat(k.edges);g=a.exclude(g,k.vertexes);m.push(j)}return m},_doTravers:function(p,h,c){var q={vertexes:[],edges:[]};var j=c;if(!j.getData(this.VISITED_KEY)){q.vertexes.push(j);j.setData(this.VISITED_KEY,true);if(p){p(j,false)}}var e=j.getEdges();var k=[];var m=h===Kekule.GraphTraverseMode.BREADTH_FIRST;for(var f=0,d=e.length;f<d;++f){var b=e[f];var o=j.getNeighborOnEdge(b);if(!o.getData(this.VISITED_KEY)){q.vertexes.push(o);q.edges.push(b);o.setData(this.VISITED_KEY,true);if(p){p(b,true);p(o,false)}if(m){k.push(o)}else{var g=this._doTravers(p,h,o);q.vertexes=q.vertexes.concat(g.vertexes);q.edges=q.edges.concat(g.edges)}}}if(m){for(var f=0,d=k.length;f<d;++f){var n=k[f];var g=this._doTravers(p,h,n);q.vertexes=q.vertexes.concat(g.vertexes);q.edges=q.edges.concat(g.edges)}}return q}});Kekule.globalOptions.add("algorithm.molToGraph",{expandSubStructures:true,ignoreBondedHydrogen:true});Kekule.GraphAdaptUtils={ctabToGraph:function(p,c,f){var q=Object.extend(Object.extend({},Kekule.globalOptions.algorithm.molToGraph),f||{});var I=p;var m=Kekule.ArrayUtils;var u=null;var y=q.expandSubStructures;if(I){var g=q.nodeFilter||function(i,e){if(q.nodeClasses){var k=i.getClass();if(!ClassEx.isOrIsDescendantOfClasses(k,q.nodeClasses)){return false}}if(q.ignoreBondedHydrogen){if(i.isHydrogenAtom&&i.isHydrogenAtom()){var j=i.getLinkedConnectors();if(e){j=m.intersect(j,e)}if(j.length<=1){return false}}}return true};var d=q.connectorFilter||function(e,i){if(q.connectorClasses){var j=e.getClass();if(!ClassEx.isOrIsDescendantOfClasses(j,q.connectorClasses)){return false}}if(e.getBondType&&q.bondTypes){if(q.bondTypes.indexOf(e.getBondType())<0){return false}}return true};var u=c||new Kekule.Graph();var C=y?I.getAllContainingConnectors():I.getConnectors();var z=y?I.getLeafNodes():I.getNodes();var n=[];var J=new Kekule.MapEx();for(var F=0,B=C.length;F<B;++F){var b=C[F];if(!d(b)){continue}var o=[];var r=y?b.getConnectedObjs():b.getConnectedSiblings();for(var E=0,D=r.length;E<D;++E){var G=r[E];if(z.indexOf(G)>=0){if(g(G,C)){o.push(G)}else{m.pushUnique(n,G)}if(o.length>=2){var t=m.exclude(o,n);for(var x=0,s=t.length;x<s;++x){var w=u.newVertex();w.setData("object",t[x]);J.set(t[x],w)}var H=u.newEdge(J.get(o[0]),J.get(o[1]));H.setData("object",b);m.pushUnique(n,o);break}}}}var h=m.exclude(z,n);for(var F=0,B=h.length;F<B;++F){var A=h[F];if(g(A,C)){var w=u.newVertex();w.setData("object",A)}}J.finalize()}return u},molToGraph:function(g,f,d){var c=Kekule.ArrayUtils;var b=null;if(!g||!g.hasCtab()){return null}var e=g.getCtab();if(e){return Kekule.GraphAdaptUtils.ctabToGraph(e,f,d)}return b},chemObjToGraph:function(h,g,e){var c=Kekule.ChemStructureUtils.getAllStructFragments(h,true);var b=g||new Kekule.Graph();for(var f=0,d=c.length;f<d;++f){Kekule.GraphAdaptUtils.molToGraph(c[f],b,e)}return b}};Kekule.GraphAlgorithmUtils={SEQ_KEY:"__$seq__",RESD_DEGREE_KEY:"__$resdDegree__",VISIT_EDGE_DEGREE_KEY:"__$visitedEdgeDegree__",TYPE_KEY:"__$type__",TYPE_CYCLE:"cycle",TYPE_BRIDGE:"bridge",VISITED_KEY:"__$visited",createSpanningTrees:function(c,b){return c.traverse(null,b)},findCycleBlocks:function(b){var v=[];var m=Kekule.GraphAlgorithmUtils;var c=m.SEQ_KEY;var e=m.RESD_DEGREE_KEY;var u=m.VISIT_EDGE_DEGREE_KEY;var h=m.TYPE_KEY;var p=m.TYPE_CYCLE;var n=m.TYPE_BRIDGE;var d=b.getEdges();for(var D=0,A=d.length;D<A;++D){d[D].removeData(c)}var r=b.getVertexes();for(var D=0,A=r.length;D<A;++D){r[D].removeData(h)}var E=1;var w=1;var K=[];var g=[];var z=[];var f=b.traverse(function(j,i){if(i){j.setData(c,E);g.push(j);++E}else{j.setData(c,w);++w;K.push(j)}});for(var D=0,A=K.length;D<A;++D){var x=K[D];var G=x.getEdges();x.setData(e,G.length);var I=0;for(var C=0,B=G.length;C<B;++C){var o=G[C];if(o.getData(c)){++I}}x.setData(u,I);if(I<G.length){z.push(x)}}var s=function(R,P){if(P&&R.getData(c)<=1){return null}var N=R.getEdges();var S=null;var Q=null;for(var O=0,j=N.length;O<j;++O){var k=N[O].getData(c);if(k){if(!Q){S=N[O];Q=k}else{if(k<Q){S=N[O];Q=k}}}}if(S){return S}else{return null}};var t=function(O){var k=O.getEdges();for(var N=0,j=k.length;N<j;++N){if(!k[N].getData(c)&&!k[N].getData(h)){return k[N]}}return null};var H=function(N){var j=[],V=[];var k=N.getData(u);var S=N.getData(e);var R=S-k;if(R>0){N.setData(h,p);a.pushUnique(j,N);for(var P=0;P<R;++P){N.setData(e,S+1);var l=t(N);if(l){l.setData(h,p);a.pushUnique(V,l);var U=N.getNeighborOnEdge(l);U.setData(e,U.getData(e)+1);U.setData(h,p);a.pushUnique(j,U);do{var k=U.getData(u);var S=U.getData(e);if(k<S){var O=H(U);a.pushUnique(j,O.vertexes);a.pushUnique(V,O.edges)}var T=s(U,false);if(!T){break}T.setData(h,p);a.pushUnique(V,T);var Q=U.getNeighborOnEdge(T);if(!Q.getData(h)){Q.setData(h,p);a.pushUnique(j,Q);U=Q}else{break}}while(true)}}}return{vertexes:j,edges:V}};var y=K.shift();while(y){if(y.getData(h)){}else{var M=y.getData(u);var L=y.getData(e);var J=L-M;if(J>0){var F=H(y);v.push(F)}else{y.setData(h,n);var q=s(y,true);if(q){q.setData(h,n)}}}y=K.shift()}return v},findEndChains:function(o){var m=Kekule.ArrayUtils;var h="__$currConnectivity__";var q={vertexes:[],edges:[]};var j=m.clone(o.getVertexes());var b=[];for(var g=0,d=j.length;g<d;++g){var n=j[g];var c=n.getEdgeCount();n.setData(h,c);if(c<=1){b.push(n)}}if(b.length){var f=b.pop();m.remove(j,f);q.vertexes.push(f);while(j.length){var k=false;var e=m.exclude(f.getEdges(),q.edges);if(e.length){q.edges=q.edges.concat(e);var p=f.getNeighborOnEdge(e[0]);var c=p.getData(h)-1;p.setData(h,c);if(c<=1){f=p;m.remove(j,f);q.vertexes.push(f);k=true}}if(!k){if(b.length){var f=b.pop();m.remove(j,f);q.vertexes.push(f)}else{break}}}}return q},removeEndChains:function(e){var d=Kekule.GraphAlgorithmUtils.findEndChains(e);for(var c=0,b=d.vertexes.length;c<b;++c){e.removeVertex(d.vertexes[c])}return d},findBridgeChains:function(f){var h=f.getVertexes();var g=f.getEdges();var e=Kekule.GraphAlgorithmUtils.findCycleBlocks(f);for(var d=0,c=e.length;d<c;++d){h=a.exclude(h,e[d].vertexes);g=a.exclude(g,e[d].edges)}var b={vertexes:h,edges:g};return b},removeBridgeChains:function(e){var d=Kekule.GraphAlgorithmUtils.findBridgeChains(e);for(var c=0,b=d.vertexes.length;c<b;++c){e.removeVertex(chainElems.vertexes[c])}return d},findAllRings:function(w){var f=Kekule.GraphAlgorithmUtils;var g="__$path_detail__";var r="__$vertextPartDegree__";var n=[];var h;if(w instanceof Kekule.Graph){h=f.findCycleBlocks(w)}else{h=[w]}var s=function(i){return i.vertexes.length===i.edges.length};var o=function(i,k){var x=i.vertexes;var j=x.length;return j&&((x[0]===k)||(x[j-1]===k))};var b=function(k,j,i){var y=a.clone(k.vertexes);var x=a.clone(j.vertexes);y.shift();y.pop();x.shift();x.pop();var l=a.intersect(y,x);return(l.length>=1)};var c=function(k,j,i){var x=a.clone(k.vertexes);var l=a.clone(j.vertexes);var A=a.clone(k.edges);var z=a.clone(j.edges);if(x[0]===i){x.reverse();A.reverse()}if(l[l.length-1]===i){l.reverse();z.reverse()}x.pop();var B=x.concat(l);var y=A.concat(z);return{vertexCount:k.vertexCount+j.vertexCount-1,vertexes:B,edges:y}};var d=function(y){var C=[];var H=a.clone(y.vertexes);var x=y.edges;for(var L=0,I=H.length;L<I;++L){var D=H[L];var N=a.intersect(D.getEdges(),x);D.setData(r,N.length)}H.sort(function(j,i){return(j.getData(r)-i.getData(r))});var M=[];for(var L=0,I=y.edges.length;L<I;++L){var z=y.edges[L];var J=z.getVertexes();M.push({vertexCount:J.length,vertexes:[J[0],J[1]],edges:[z]})}while(H.length){var F=H.shift();var E=null;var k=-1;for(var L=M.length-1;L>=0;--L){var G=M[L];if(o(G,F)){E=G;for(var K=L-1;K>=0;--K){var G=M[K];if(o(G,F)){if(!b(E,G,F)){var B=c(E,G,F);var A=B.vertexes;if(A[0]===A[A.length-1]){A.pop();C.push(B)}else{M.push(B)}}}}M.splice(L,1)}}}return C};for(var v=0,q=h.length;v<q;++v){var p=h[v];if(s(p)){n.push({vertexes:a.clone(p.vertexes),edges:a.clone(p.edges)})}else{var e=d(p);for(var u=0,t=e.length;u<t;++u){var m=e[u];n.push({vertexes:a.clone(m.vertexes),edges:a.clone(m.edges)})}}}return n},findSSSR:function(g,k){var e=Kekule.GraphAlgorithmUtils;var n=[];var m;if(g instanceof Kekule.Graph){m=e.findCycleBlocks(g);k=null}else{m=[g]}var b=1||function(w){var v=[];var p=cycleBlock.edges.length-cycleBlock.vertexes.length+1;if(p<=0){return[]}var u=e.findAllRings(cycleBlock);var x=new Kekule.MapEx(true);for(var D=0,A=u.length;D<A;++D){var o=u[D].edges.length;var t=x.get(o);if(!t){t=[];x.set(o,t)}t.push(u[D])}var z=x.getKeys();z.sort(function(l,i){return l-i});var s;var q=a.clone(cycleBlock.edges);var y=function(l,i){return a.intersect(l,i.edges).length};var r=function(i){v.push(i);q=a.exclude(q,i.edges)};for(var C=0,B=z.length;C<B;++C){var G=z[C];var F=x.get(G);if(F.length<=1){if(v.length===0){s=F.shift();r(s)}else{s=F.shift();if(!!y(q,s)){r(s)}}}else{while(F.length&&(v.length<p)&&q.length){if(v.length===0){s=F.shift();r(s)}else{for(var D=F.length-1;D>=0;--D){s=F[D];var E=y(q,s);if(E<=0){F.splice(D,1)}else{s.__uncheckedEdgeCount__=E}}F.sort(function(l,i){return l.__uncheckedEdgeCount__-i.__uncheckedEdgeCount__});s=F.shift();r(s)}}}if((v.length>=p)||(q.length<=0)){break}}return v};var h=function(u,s){var v=[];var p=u.edges.length-u.vertexes.length+1;if(p<=0){return[]}var r=s?a.clone(s):e.findAllRings(u);r.sort(function(x,w){return x.vertexes.length-w.vertexes.length});var i=function(w){v.push(w)};var t;var l=[];var q=Kekule.RingVectorUtils;q.prepareConvertRingToVector(u);var o=r.shift();i(o);t=q.convertRingToVector(o,u);l.push(t);while((v.length<p)&&r.length){o=r.shift();t=q.convertRingToVector(o,u);if(!q.isLinearDependant(t,l)){l.push(t);i(o)}}return v};for(var f=0,d=m.length;f<d;++f){var c=m[f];var j=h(c,k);n=n.concat(j)}return n},analysisRings:function(f){var c=Kekule.GraphAlgorithmUtils;var k=[];var j;if(f instanceof Kekule.Graph){j=c.findCycleBlocks(f)}else{j=[f]}for(var e=0,d=j.length;e<d;++e){var b=j[e];var g=c.findAllRings(b);var h=c.findSSSR(b,g);k.push({vertexes:b.vertexes,edges:b.edges,allRings:g,sssrRings:h})}return k}};Kekule.RingVectorUtils={MAX_INT_BITNUM:23,EDGE_INDEX_FIELD:"__$index__",prepareConvertRingToVector:function(e){var c=e.edges;for(var d=0,b=c.length;d<b;++d){c[d][Kekule.RingVectorUtils.EDGE_INDEX_FIELD]=d}},convertRingToVector:function(e,h){var k;var b=h.edges.length;var j=e.edges;if(b<Kekule.RingVectorUtils.MAX_INT_BITNUM){k=0;for(var f=0,d=j.length;f<d;++f){var c=j[f];var g=c[Kekule.RingVectorUtils.EDGE_INDEX_FIELD];k+=1<<g}}else{k=[];for(var f=0,d=j.length;f<d;++f){var c=j[f];var g=c[Kekule.RingVectorUtils.EDGE_INDEX_FIELD];k[g]=true}}return k},vectorNotNull:function(b){if(DataType.isSimpleValue(b)){return !!b}else{for(var c=0;c<b.length;++c){if(b[c]){return true}}return false}},getVectorLength:function(b){if(DataType.isSimpleValue(b)){return b.toString(2).length}else{return b.length}},ringVectorAnd:function(f,e){if(DataType.isSimpleValue(f)){return f&e}else{var b=[];var c=Math.min(f.length,e.length);for(var d=0;d<c;++d){b[d]=f[d]&&e[d]}return b}},ringVectorAndAll:function(f){if(f.length<2){return f[0]}var d=Kekule.RingVectorUtils;var b=d.ringVectorAnd(f[0],f[1]);for(var e=2,c=f.length;e<c;++e){b=d.ringVectorAnd(b,f[e])}return b},ringVectorOr:function(f,e){if(DataType.isSimpleValue(f)){return f|e}else{var b=[];var c=Math.max(f.length,e.length);for(var d=0;d<c;++d){b[d]=f[d]||e[d]}return b}},ringVectorOrAll:function(f){if(f.length<2){return f[0]}var d=Kekule.RingVectorUtils;var b=d.ringVectorOr(f[0],f[1]);for(var e=2,c=f.length;e<c;++e){b=d.ringVectorOr(b,f[e])}return b},ringVectorXor:function(f,e){if(DataType.isSimpleValue(f)){return f^e}else{var b=[];var c=Math.max(f.length,e.length);for(var d=0;d<c;++d){b[d]=!!(f[d]^e[d])}return b}},ringVectorXorAll:function(f){if(f.length<2){return f[0]}var d=Kekule.RingVectorUtils;var b=d.ringVectorXor(f[0],f[1]);for(var e=2,c=f.length;e<c;++e){b=d.ringVectorXor(b,f[e])}return b},ringVectorNot:function(d){if(DataType.isSimpleValue(d)){return ~d}else{var b=[];for(var e=0,c=d.length;e<c;++e){b[e]=!d[e]}return b}},isLinearDependant:function(c,b){var q=Kekule.RingVectorUtils;var g=q.ringVectorOrAll(b);var p=q.ringVectorAnd(c,q.ringVectorNot(g));if(q.vectorNotNull(p)){return false}else{var r=b.length;var j=function(v){var l=[];for(var u=0;u<v;++u){l[u]=v-u-1}return l};var n=function(v,z,x){var u=v[z];var y=++u;if(y>=x-z){if(z>=v.length-1){return false}else{return n(v,z+1,x)}}else{v[z]=y;var l=y;for(var w=z-1;w>=0;--w){++l;v[w]=l}return true}};var o=function(i,l){return n(i,0,l)};var k=0;var t=false;for(var h=2;h<=r;++h){var d=j(h);while(true){++k;var s=[];for(var f=0,e=d.length;f<e;++f){s.push(b[d[f]])}var m=q.ringVectorXorAll(s);if(!q.vectorNotNull(q.ringVectorXor(m,c))){t=true;break}if(!o(d,r)){t=false;break}}if(t){break}}return t}},isLinearDependant_wrong:null&&function(d,g){var c=Kekule.RingVectorUtils;var k=c.ringVectorOrAll(g);var x=c.ringVectorAnd(d,c.ringVectorNot(k));if(c.vectorNotNull(x)){return false}else{var o=c.getVectorLength(d);var e=g.length;var f=[];try{var n=DataType.isSimpleValue(d);if(n){for(var v=0;v<o;++v){var r=1<<v;if(r&d){var p=[];f.push(p);for(var u=0;u<e;++u){if(g[u]&r){p.push(g[u])}}}}}else{for(var v=0;v<o;++v){if(d[v]){var p=[];f.push(p);for(var u=0;u<e;++u){if(g[u][v]){p.push(g[u])}}}}}var w=[];var h=[];for(var v=0,t=f.length;v<t;++v){w[v]=f[v].length;h[v]=0}var z=function(i,j,l){if(i[l]<j[l]-1){++i[l];return true}else{if(l>=j.length-1){return false}i[l]=0;return z(i,j,l+1)}};var b=function(i,j){return z(i,j,0)};var m=0;var q;while(true){++m;var y=[];for(var v=0,t=h.length;v<t;++v){a.pushUnique(y,f[v][h[v]])}if((f.length===4)){console.log("new vector edge count",f.length,"selVector count",y.length);console.log(y)}var s=c.ringVectorXorAll(y);if(!c.vectorNotNull(c.ringVectorXor(s,d))){q=true;break}if(!b(h,w)){q=false;break}}console.log("tried ",m,q);return q}finally{}}}}})();(function(){Kekule.ChemStructObjContainer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ChemStructObjContainer",initialize:function($super){$super();this.setPropStoreFieldValue("nodes",[]);this.setPropStoreFieldValue("connectors",[])},initProperties:function(){this.defineProp("nodes",{dataType:DataType.ARRAY,serializable:false,setter:null});this.defineProp("connectors",{dataType:DataType.ARRAY,serializable:false,setter:null})},clear:function(){this.getNodes().length=0;this.getConnectors().length=0;return this},add:function(c){var b=null;if(c instanceof Kekule.ChemStructureConnector){b=this.getConnectors()}else{if(c instanceof Kekule.ChemStructureNode){b=this.getNodes()}}if(!b){Kekule.error(Kekule.$L("ErrorMsg.CANNOT_ADD_NON_NODE_NOR_CONNECTOR_TO_STRUCT_CONTAINER"))}else{Kekule.ArrayUtils.pushUnique(b,c)}return this},remove:function(c){var b=null;if(c instanceof Kekule.ChemStructureConnector){b=this.getConnectors()}else{b=this.getNodes()}Kekule.ArrayUtils.remove(b,c);return this}})})();(function(){var b=Kekule;var a=Kekule.ArrayUtils;var c=Kekule.BondType;Kekule.CanonicalizationIndexer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.CanonicalizationIndexer",initialize:function($super){$super()},execute:function(e){var d=(e instanceof Kekule.StructureFragment)?e.getCtab():e;if(d){return this.doExecute(d)}else{return null}},doExecute:function(d){}});Kekule.CanonicalizationNodeSorter=Class.create(ObjectEx,{CLASS_NAME:"Kekule.CanonicalizationNodeSorter",execute:function(e){var d=(e instanceof Kekule.StructureFragment)?e.getCtab():e;if(d){return this.doExecute(d,d.getNodes())}else{return null}},doExecute:function(d){}});Kekule.CanonicalizationConnectorSorter=Class.create(ObjectEx,{CLASS_NAME:"Kekule.CanonicalizationConnectorSorter",execute:function(e){var d=(e instanceof Kekule.StructureFragment)?e.getCtab():e;if(d){return this.doExecute(d,d.getConnectors())}else{return null}},doExecute:function(d){}});Kekule.CanonicalizationConnectorConnectedObjsSorter=Class.create(ObjectEx,{CLASS_NAME:"Kekule.CanonicalizationConnectorConnectedObjsSorter",execute:function(e){var d=(e instanceof Kekule.StructureFragment)?e.getCtab():e;if(d){return this.doExecute(d,d.getConnectors())}else{return null}},doExecute:function(d){}});Kekule.CanonicalizationCustomExecutor=Class.create(ObjectEx,{CLASS_NAME:"Kekule.CanonicalizationCustomExecutor",execute:function(e){var d=this.doExecute(e);if(d){this.doCanonicalizeConnectedObjs(d)}return d},doExecute:function(d){return d},doCanonicalizeConnectedObjs:function(d){if(!d){return}var e=new Kekule.CanonicalizationGeneralConnectorConnectedObjsSorter();e.execute(d)}});Kekule.CanonicalizationGeneralConnectorSorter=Class.create(Kekule.CanonicalizationConnectorSorter,{CLASS_NAME:"Kekule.CanonicalizationGeneralConnectorSorter",doExecute:function(n){var d=new Kekule.MapEx();try{for(var q=0,g=n.getConnectorCount();q<g;++q){var f=n.getConnectorAt(q);var m=f.getConnectedObjs();var r=[];for(var o=0,h=m.length;o<h;++o){var p=m[o];var e;if(p instanceof Kekule.ChemStructureNode){e=n.indexOfNode(p);r.push(e)}else{}}r.sort(function(j,i){return j-i});d.set(f,r)}n.sortConnectors(function(l,j){var s=d.get(l);var k=d.get(j);var i=a.compare(s,k);if(i===0){i=-(l.getConnectedObjCount()-j.getConnectedObjCount())}return i})}finally{d.finalize()}}});Kekule.CanonicalizationGeneralConnectorConnectedObjsSorter=Class.create(Kekule.CanonicalizationConnectorConnectedObjsSorter,{CLASS_NAME:"Kekule.CanonicalizationGeneralConnectorConnectedObjsSorter",doExecute:function(k){var d=new Kekule.MapEx();try{for(var n=0,h=k.getConnectorCount();n<h;++n){var g=k.getConnectorAt(n);if(g.getConnectedObjCount()===2){var f=g.getConnectedObjAt(0);var e=g.getConnectedObjAt(1);var m=k.indexOfChild(f);var j=k.indexOfChild(e);if(m<0||j<0){m=(f.getCanonicalizationIndex?-f.getCanonicalizationIndex():0)||0;j=(e.getCanonicalizationIndex?-e.getCanonicalizationIndex():0)||0}if(m>j){g.reverseConnectedObjOrder()}}else{g.sortConnectedObjs(function(q,p){var o=k.indexOfChild(q);var l=k.indexOfChild(p);if(o<0||l<0){o=(q.getCanonicalizationIndex?-q.getCanonicalizationIndex():0)||0;l=(p.getCanonicalizationIndex?-p.getCanonicalizationIndex():0)||0;i=(o||0)-(l||0)}var i=k.indexOfChild(q)-k.indexOfChild(p);return i})}}}finally{d.finalize()}}});Kekule.CanonicalizationMorganIndexer=Class.create(Kekule.CanonicalizationIndexer,{CLASS_NAME:"Kekule.CanonicalizationMorganIndexer",doExecute:function(e){var g=Kekule.GraphAdaptUtils.ctabToGraph(e,null,{expandSubStructures:true,ignoreBondedHydrogen:true});if(!g){return null}var h=this._calcGraphFinalECs(g);var d=h.ecMapping;var f=this._sortNodeByEcMapping(g,d);this._setCanonicalizationIndexToNodeGroups(f)},_sortNodeByEcMapping:function(n,m){var f=[];var k=this._groupVertexesByEcValue(n,m);for(var j=0,g=k.length;j<g;++j){var h=k[j];var d=this._vertexesToNodes(h.vertexes);if(d.length===1){a.pushUnique(f,d[0])}else{var e=this._groupNodesWithSameEcValue(d,f);f=f.concat(e)}}return f},_setCanonicalizationIndexToNodeGroups:function(n){for(var h=0,d=n.length;h<d;++h){var g=h+1;var m=n[h];if(a.isArray(m)){for(var f=0,e=m.length;f<e;++f){m[f].setCanonicalizationIndex(g)}}else{m.setCanonicalizationIndex(g)}}},_vertexesToNodes:function(h){var d=[];for(var f=0,e=h.length;f<e;++f){var g=h[f].getData("object");d.push(g)}return d},_processECs:function(s,e,p,n){var r=[];var d=s.getVertexes();for(var m=0,f=d.length;m<f;++m){var o=d[m];var q=0;if(!n){var t=o.getNeighbors();for(var h=0,g=t.length;h<g;++h){q+=p.get(t[h])||0}}else{q=o.getEdgeCount()}e.set(o,q);a.pushUnique(r,q)}return r.length},_calcGraphFinalECs:function(i){var g=[new Kekule.MapEx(),new Kekule.MapEx()];try{var f=0;var j=g[0];var d=g[0];var h=this._processECs(i,j,d,true);var e=0;while(h>e){e=h;++f;d=j;j=g[f%2];h=this._processECs(i,j,d)}}finally{j.finalize()}return{ecMapping:d,ecCount:e}},_groupVertexesByEcValue:function(n,h){var e=[];var j=[];var d=n.getVertexes();for(var g=0,f=d.length;g<f;++g){var m=d[g];var k=h.get(m);a.pushUnique(j,k);if(!e[k]){e[k]=[]}e[k].push(m)}j.sort(function(l,i){return l-i});var p=[];for(var g=0,f=j.length;g<f;++g){var o=e[j[g]];p.push({ecValue:j[g],vertexes:o,vertexesCount:o.length})}return p},_groupNodesWithSameEcValue:function(e,g){var d=function(p,m){var h=p.getLinkedObjs();var u=a.intersect(h,m);var k=[];var s=[];for(var t=0,r=u.length;t<r;++t){var j=u[t];k.push(m.indexOf(j))}k.sort(function(l,i){return l-i});for(var t=0,r=k.length;t<r;++t){var j=m[k[t]];var o=p.getConnectorTo(j);var q=o.getBondOrder?o.getBondOrder()||0:0;s.push(q)}return{nodeOrders:k,connectorOrders:s}};var f=a.group(e,function(l,j){var h=l.compareStructure(j);if(h===0){var k=d(l,g);var i=d(j,g);h=a.compare(k.nodeOrders,i.nodeOrders);if(h===0){h=a.compare(k.connectorOrders,i.connectorOrders)}}return h});return f}});Kekule.CanonicalizationMorganNodeSorter=Class.create(Kekule.CanonicalizationNodeSorter,{CLASS_NAME:"Kekule.CanonicalizationMorganNodeSorter",doExecute:function(e){var f=this._getNodeSortedArray(e);var g=f.length;var d=this;e.sortNodes(function(j,i){var l=f.indexOf(j);var k=f.indexOf(i);if(l<0){l=g}if(k<0){k=g}var h=l-k;if(h===0&&l===g){h=d._getNeighborNodesMinIndex(j,f)-d._getNeighborNodesMinIndex(i,f)}return h})},_getNeighborNodesMinIndex:function(j,k){var h=j.getLinkedChemNodes();var d=k.length;for(var g=0,e=h.length;g<e;++g){var f=k.indexOf(h[g]);if(f>0&&f<d){d=f}}return d},_getNodeSortedArray:function(k){var v=[];var q=function(j,z,y){var A;var x=z.getCanonicalizationIndex();var w=y.getCanonicalizationIndex();A=(x||-1)-(w||-1);if(A===0){if(j){var i=j.getConnectorTo(z);var B=j.getConnectorTo(y);A=i.compareStructure(B)}if(A===0){if(z.hasCoord3D(true)&&y.hasCoord3D(true)){var l=Kekule.CoordUtils.substract(z.getAbsCoord3D(true),y.getAbsCoord3D(true));A=l.z||l.y||l.x}}}return A};try{var u=a.clone(k.getNodes());var n,r;for(var m=0,f=u.length;m<f;++m){var e=u[m];if(!n){n=e;r=m}else{if(q(null,e,n)>0){n=e;r=m}}}u.splice(r,1);var d=[];var h=[];d.push(n);for(var m=0;m<d.length;++m){var n=d[m];if(m!==0){var p=u.indexOf(n);if(p>=0){d.push(n);u.splice(p,1)}}var t=n.getLinkedObjs();t=a.intersect(t,u);if(t.length){t.sort(function(l,j){var i=n;return q(i,l,j)});for(var g=t.length-1;g>=0;--g){var s=t[g];p=u.indexOf(s);if(p>=0){var o=s.getCanonicalizationIndex();if(Kekule.ObjUtils.isUnset(o)){h.push(s)}else{d.push(s)}u.splice(p,1)}}}}d=d.concat(h);return d}finally{}}});Kekule.Canonicalizer=Class.create({CLASS_NAME:"Kekule.Canonicalizer",initialize:function(){this._executorClasses={};this._executorInstances={};this._defExecutorId=null},registerExecutor:function(f,d,e){if(a.isArray(d)){this._executorClasses[f]={indexer:d[0],nodeSorter:d[1],connectorSorter:d[2]||Kekule.CanonicalizationGeneralConnectorSorter,connectorConnectedObjsSorter:d[3]||Kekule.CanonicalizationGeneralConnectorConnectedObjsSorter}}else{this._executorClasses[f]={customExecutor:d}}if(e){this._defExecutorId=f}},getExecutor:function(f){if(!f){return null}var d=this._executorInstances[f];if(!d){var e=this._executorClasses[f];if(e){if(e.customExecutor){d={customExecutor:new (e.customExecutor)()}}else{d={indexer:new (e.indexer)(),nodeSorter:new (e.nodeSorter)(),connectorSorter:new (e.connectorSorter)(),connectorConnectedObjsSorter:new (e.connectorConnectedObjsSorter)()}}this._executorInstances[f]=d}}return d},canonicalize:function(e,d){e.beginUpdate();try{var k=d||this._defExecutorId;var j=this.getExecutor(k);if(!j){Kekule.error(Kekule.$L("ErrorMsg.REGISTERED_CANONICALIZATION_EXECUTOR_NOT_FOUND"))}else{var i=(e instanceof Kekule.StructureFragment)?e:null;var h=i.getCanonicalizationInfo();if(h&&h.id===k){return e}var f=e.getCtab?e.getCtab():e;if(!f){return}var g=f.getParent();if(j.customExecutor){j.customExecutor.execute(f)}else{this._doDefaultCanonicalize(j,f,g)}i.setCanonicalizationInfo({id:k})}}finally{e.endUpdate()}return e},_doDefaultCanonicalize:function(g,e,f){var d=f.getFlattenedShadowFragment();var e=d.getCtab();e.beginUpdate();try{g.indexer.execute(e);g.nodeSorter.execute(e);g.connectorSorter.execute(e);g.connectorConnectedObjsSorter.execute(e)}finally{e.endUpdate()}if(!f.getFlattenedShadowOnSelf()){f.beginUpdate();try{this._sortSrcStructBaseOnShadow(f,d);g.connectorConnectedObjsSorter.execute(f.getCtab())}finally{f.endUpdate()}}},_sortSrcStructBaseOnShadow:function(l,r){var q="__$flattern_index$__";var o=function(i){return i[q]};var m=function(s,i){s[q]=i};var d=function(i,u,s,x){m(u,s);var t=u.getParent();if(t.isChildOf(l)){var v=o(t);var w=s+x;if(Kekule.ObjUtils.isUnset(v)||v>w){d(i,t,w,x)}}};var e=function(v){v.beginUpdate();try{v.sortNodes(function(w,i){return o(w)-o(i)});v.sortConnectors(function(w,i){return o(w)-o(i)});for(var t=0,s=v.getNodeCount();t<s;++t){var u=v.getNodeAt(t);if(u instanceof Kekule.StructureFragment){e(u)}}}finally{v.endUpdate()}};l.cascadeOnChildren(function(i){if(i){m(i,null)}});var n=r.getChildCount();l.beginUpdate();try{for(var h=0;h<n;++h){var p=r.getChildAt(h);if(p instanceof Kekule.ChemStructureNode){var g=p;var k=l.getFlatternedShadowSourceObj(g);if(k){d(l,k,h,n);k.setCanonicalizationIndex(g.getCanonicalizationIndex())}}else{if(p instanceof Kekule.ChemStructureConnector){var f=p;var j=l.getFlatternedShadowSourceObj(f);m(j,h)}}}e(l)}finally{l.endUpdate()}}});Kekule.ClassUtils.makeSingleton(Kekule.Canonicalizer);Kekule.canonicalizer=Kekule.Canonicalizer.getInstance();ClassEx.extend(Kekule.ChemObject,{canonicalize:function(e){var d=Kekule.ChemStructureUtils.getAllStructFragments(this,true);for(var g=0,f=d.length;g<f;++g){d[g].canonicalize(e)}return this}});ClassEx.extend(Kekule.StructureConnectionTable,{canonicalize:function(d){Kekule.canonicalizer.canonicalize(this);return this}});ClassEx.extend(Kekule.StructureFragment,{canonicalize:function(d){Kekule.canonicalizer.canonicalize(this);return this}});ClassEx.defineProp(Kekule.ChemStructureObject,"canonicalizationIndex",{dataType:DataType.INT,serializable:false});Kekule.canonicalizer.registerExecutor("morgan",[Kekule.CanonicalizationMorganIndexer,Kekule.CanonicalizationMorganNodeSorter],true)})();(function(){var a=Kekule.ArrayUtils;var b=Kekule.GraphAlgorithmUtils;var d=Kekule.ChemStructureUtils;var c=Kekule.BondType;Kekule.globalOptions.add("algorithm.ringSearch",{bondTypes:[c.COVALENT]});ClassEx.extend(Kekule.StructureConnectionTable,{getGraph:function(e){var f=Class.create(e);f.connectorClasses=[Kekule.Bond];return Kekule.GraphAdaptUtils.ctabToGraph(this,null,f)},extractStructObjs:function(j){var h=j.edges;var n=j.vertexes;var g=[],f=[];for(var k=0,e=n.length;k<e;++k){var m=n[k].getData("object");if(m instanceof Kekule.BaseStructureNode){g.push(m)}}for(var k=0,e=h.length;k<e;++k){var m=h[k].getData("object");if(m instanceof Kekule.BaseStructureConnector){f.push(m)}}return{nodes:g,connectors:f}},findCycleBlocks:function(){var e=this.getRingInfo();return e?e.cycleBlocks:[]},findAllRings:function(){var k=this.getRingInfo();var f=[];if(k){for(var h=0,g=k.cycleBlocks.length;h<g;++h){var e=k.cycleBlocks[h];var j=e.allRings;f=f.concat(j)}}return f},findSSSR:function(){var k=this.getRingInfo();var f=[];if(k){for(var h=0,g=k.cycleBlocks.length;h<g;++h){var e=k.cycleBlocks[h];var j=e.sssrRings;f=f.concat(j)}}return f},analysisRings:function(y){var h=Object.extend(Object.extend({},Kekule.globalOptions.algorithm.ringSearch),y);var s=this.getGraph(h);if(s){var w=[];var e=b.analysisRings(s);for(var q=0,n=e.length;q<n;++q){var v=e[q];var r=this.extractStructObjs(v);w.push(r);r.allRings=[];var m=v.allRings;for(var p=0,o=m.length;p<o;++p){var u=m[p];var f=this.extractStructObjs(u);r.allRings.push(f)}r.sssrRings=[];var x=v.sssrRings;for(var p=0,o=x.length;p<o;++p){var u=x[p];var t=m.indexOf(u);if(t>=0){r.sssrRings.push(r.allRings[t])}else{var f=this.extractStructObjs(u);r.sssrRings.push(f)}}}return{cycleBlocks:w}}else{return null}}});ClassEx.defineProps(Kekule.StructureConnectionTable,[{name:"ringInfo",dataType:DataType.HASH,serializable:false,getter:function(f){var e=this.getPropStoreFieldValue("ringInfo");if(!e&&!f){e=this.analysisRings();this.setPropStoreFieldValue("ringInfo",e)}return e},setter:null}]);ClassEx.extendMethod(Kekule.StructureConnectionTable,"objectChange",function(f,e){this.setPropStoreFieldValue("ringInfo",null);return f(e)});ClassEx.extend(Kekule.StructureFragment,{findCycleBlocks:function(){return this.hasCtab()?this.getCtab().findCycleBlocks():null},findAllRings:function(){return this.hasCtab()?this.getCtab().findAllRings():null},findSSSR:function(){return this.hasCtab()?this.getCtab().findSSSR():null},analysisRings:function(e){return this.hasCtab()?this.getCtab().analysisRings(e):null}});ClassEx.defineProps(Kekule.StructureFragment,[{name:"ringInfo",dataType:DataType.HASH,serializable:false,getter:function(e){return this.hasCtab()?this.getCtab().getRingInfo(e):null},setter:null}]);ClassEx.extendMethod(Kekule.StructureFragment,"_copyAdditionalFragmentInfo",function(o,y,s,w){var x=function(A){var j={nodes:[],connectors:[]};for(var z=0,k=A.nodes.length;z<k;++z){var B=s.get(A.nodes[z]);if(B){j.nodes.push(B)}}for(var z=0,k=A.connectors.length;z<k;++z){var B=s.get(A.connectors[z]);if(B){j.connectors.push(B)}}return j};o(y,s,w);var q=this;var g=q.getRingInfo(true);if(g){var r={cycleBlocks:[]};for(var p=0,h=g.cycleBlocks.length;p<h;++p){var v=g.cycleBlocks[p];var u={allRings:[],sssrRings:[]};var e=v.allRings;for(var n=0,m=e.length;n<m;++n){var t=e[n];u.allRings.push(x(t))}var f=v.sssrRings;for(var n=0,m=f.length;n<m;++n){var t=f[n];u.sssrRings.push(x(t))}r.cycleBlocks.push(u)}y.setPropStoreFieldValue("ringInfo",r);console.log("set ringInfo",g,r)}});ClassEx.extend(Kekule.ChemStructureObject,{getBelongedSssrRings:function(){var e=[];var j=this.getParent();if(j&&j.findSSSR){var k=j.findSSSR();for(var h=0,f=k.length;h<f;++h){var g=k[h];if(this instanceof Kekule.BaseStructureConnector){if(g.connectors.indexOf(this)>=0){e.push(g)}}else{if(g.nodes.indexOf(this)>=0){e.push(g)}}}}return e},getBelongedRingMinSize:function(){var e=null;var k=this.getBelongedSssrRings();if(k&&k.length){for(var j=0,f=k.length;j<f;++j){var h=k[j];var g=h.nodes.length;if(!e){e=g}else{e=Math.min(e,g)}}}return e}});ClassEx.extend(Kekule.ChemObject,{findCycleBlocks:function(){var h=d.getAllStructFragments(this);var e=[];for(var g=0,f=h.length;g<f;++g){var j=h[g].findCycleBlocks();if(j){e=e.concat(j)}}return e.length?e:null},findAllRings:function(){var h=d.getAllStructFragments(this);var e=[];for(var g=0,f=h.length;g<f;++g){var j=h[g].findAllRings();if(j){e=e.concat(j)}}return e.length?e:null},findSSSR:function(){var h=d.getAllStructFragments(this);var e=[];for(var g=0,f=h.length;g<f;++g){var j=h[g].findSSSR();if(j){e=e.concat(j)}}return e.length?e:null},analysisRings:function(g){var j=d.getAllStructFragments(this);var e=[];for(var h=0,f=j.length;h<f;++h){var k=j[h].analysisRings(g);if(k){e=e.concat(k)}}return e.length?e:null}})})();(function(){var b=Kekule.ArrayUtils;var c=Kekule.BondType;var e=Kekule.BondOrder;var d=Kekule.ChemStructureUtils;var a={SATURATED_CARBON:-1,ESTER_CARBON:-16,SULFONE_OR_SULFOXIDE_SULPHUR:-32};Kekule.AromaticTypes={NONAROMATIC:0,EXPLICIT_AROMATIC:1,ANTIAROMATIC:-1,UNCERTAIN:64};ClassEx.extend(Kekule.Atom,{isSulfoneOrSulfoxideSulphur:function(){if(this.getSymbol()==="S"){var g=this.getLinkedMultipleBonds();if(g.length>=1){for(var n=0,f=g;n<f;++n){var p=this.getLinkedObjsOnConnector(g[n]);for(var m=0,h=p.length;m<h;++m){var o=p[m];if((o instanceof Kekule.Atom)&&(o.getSymbol()==="O")){return true}}}}}return false},isEsterCarbon:function(){if(this.getSymbol()==="C"){var m=this.getLinkedBonds(c.COVALENT);var j,k;for(var h=0,g=m.length;h<g;++h){var f=m[h];if(f.isBondBetween("C","O")){if(!k&&(f.getBondOrder()===e.SINGLE)){k=true}else{if(!j&&(f.getBondOrder()===e.DOUBLE)){j=true}}if(k&&j){return true}}}}return false}});Kekule.globalOptions.add("algorithm.aromaticRingsPerception",{allowUncertainRings:false});ClassEx.extend(Kekule.StructureConnectionTable,{_getPossibleRingNodePiElectronCounts:function(j,g,p){var m=function(x,G,B,z){var I=x;var s=Kekule.IsotopeFactory.getIsotope(I);var F=G.getCharge();var E=G.isSaturated&&G.isSaturated();if(!E){var t=G.getLinkedMultipleBonds();if(G.isSulfoneOrSulfoxideSulphur&&G.isSulfoneOrSulfoxideSulphur()){return a.SULFONE_OR_SULFOXIDE_SULPHUR}else{if(G.isEsterCarbon&&G.isEsterCarbon()){return a.ESTER_CARBON}}var C=b.intersect(t,z);var A=C.length;if(A){if((A===2)&&(C[0].getBondOrder()===Kekule.BondOrder.EXPLICIT_AROMATIC)){if(s.isHetero&&s.isHetero()){return[1,2]}else{return 1}}else{if((A===1)&&(C[0].getBondOrder()===Kekule.BondOrder.DOUBLE)){return 1}else{return 0}}}else{if(I==="C"){var u=false;for(var J=0,H=t.length;J<H;++J){var y=t[J];var v=G.getLinkedObjsOnConnector(y);if(v.length===1){var D=v[0];var w=D.getPrimaryIsotope();if(w.isHetero()){u=true;break}}}if(u){return 0}else{return 1}}else{return 1}}}else{if(G.getRadical&&(G.getRadical()===Kekule.RadicalOrder.DOUBLET)){return 1}else{if(s.isHetero()){return 2}else{if(I==="C"){if(F>0){return 0}else{if(F<0){return 2}else{return a.SATURATED_CARBON}}}}}}return 0};if(j instanceof Kekule.VariableAtom){var f=j.getAllowedIsotopeIds();if(f&&f.length){var r=[];for(var o=0,n=f.length;o<n;++o){var h=f[o];var k=Kekule.IsotopeFactory.getIsotopeById(h).getSymbol();b.pushUnique(r,m(k,j,g,p))}return r}else{return[0,1,2]}}var q=j.getPrimaryIsotope();if(!q){return[0,1,2]}else{var k=q.getSymbol();return m(k,j,g,p)}},_checkRingAromaticType:function(h,f){if(f){var q=h.nodes;var v=[];var o=[];var t=q.length;for(var s=0;s<t;++s){var p=q[s];var u=f.get(p);if(b.isArray(u)){v.push(u)}else{v.push([u])}o[s]=0}var y=function(B,n){var i=n[B];var A=++i;if(A>=v[B].length){if(B>=n.length-1){return false}else{n[B]=0;return y(B+1,n)}}else{n[B]=A;return true}};var x=function(i){return y(0,i)};var j;var r=null;var m=0;do{++m;var l=0;var g=null;for(var s=0;s<t;++s){var w=v[s][o[s]];if(w>=0){l+=w}else{g=Kekule.AromaticTypes.NONAROMATIC;break}}if(g===null){var k=parseInt(l/4);var z=l%4;if((k<=5)&&(k!==2)){if(z===2){g=Kekule.AromaticTypes.EXPLICIT_AROMATIC}else{if(!z){g=Kekule.AromaticTypes.ANTIAROMATIC}}}}if(r!==null){if(r!==g){if((r===Kekule.AromaticTypes.EXPLICIT_AROMATIC)||(g===Kekule.AromaticTypes.EXPLICIT_AROMATIC)){return Kekule.AromaticTypes.UNCERTAIN;break}}}else{r=g}}while(x(o));return r}},_calcPossibleRingNodesPElectronCounts:function(f,q,h){var g=[];var m=[];var p=[];if(!h){for(var n=0,k=q.length;n<k;++n){b.pushUnique(g,q[n].nodes);b.pushUnique(m,q[n].connectors)}p=g}else{for(var n=0,k=h.length;n<k;++n){b.pushUnique(g,h[n].nodes);b.pushUnique(m,h[n].connectors)}for(var n=0,k=q.length;n<k;++n){b.pushUnique(p,q[n].nodes)}}for(var n=0,k=p.length;n<k;++n){var j=p[n];var o=this._getPossibleRingNodePiElectronCounts(j,g,m);f.set(j,o)}},perceiveAromaticRings:function(k,o){if(Kekule.ObjUtils.isUnset(k)){k=Kekule.globalOptions.algorithm.aromaticRingsPerception.allowUncertainRings}var m=o||this.findSSSR();var p=[];var f=new Kekule.MapEx();try{this._calcPossibleRingNodesPElectronCounts(f,m,null);for(var j=0,g=m.length;j<g;++j){var h=m[j];var n=this._checkRingAromaticType(h,f);if((n===Kekule.AromaticTypes.EXPLICIT_AROMATIC)||(k&&(n===Kekule.AromaticTypes.UNCERTAIN))){p.push(h)}}return p}finally{f.finalize()}},findAromaticRings:function(f,g){return this.perceiveAromaticRings(f,g)},getRingAromaticType:function(h,g){if(!g){g=this.findSSSR()}var f;var i=new Kekule.MapEx();try{this._calcPossibleRingNodesPElectronCounts(i,[h],g);f=this._checkRingAromaticType(h,i)}finally{i.finalize()}return f}});ClassEx.extend(Kekule.StructureFragment,{perceiveAromaticRings:function(g,h){var f=this.hasCtab()?this.getCtab().perceiveAromaticRings(g,h):[];this.setAromaticRings(f||[]);return f},findAromaticRings:function(f,g){return this.perceiveAromaticRings(f,g)},getRingAromaticType:function(g,f){return this.hasCtab()?this.getCtab().getRingAromaticType(g,f):null}});ClassEx.extend(Kekule.ChemObject,{perceiveAromaticRings:function(h,n){var k=d.getAllStructFragments(this);var f=[];for(var j=0,g=k.length;j<g;++j){var m=k[j].perceiveAromaticRings(h,n);if(m){f=f.concat(m)}}return f.length?f:null},findAromaticRings:function(f,g){return this.perceiveAromaticRings(f,g)}})})();(function(){Kekule.globalOptions.add("algorithm.molStandardization",{unmarshalSubFragments:true,doCanonicalization:true,doAromaticPerception:true,doStereoPerception:true});Kekule.MolStandardizer={standardize:function(d,a){var c=Object.extend({},Kekule.globalOptions.algorithm.molStandardization);var b=d;var e=Object.extend(c,a);if(e.unmarshalSubFragments){b.unmarshalAllSubFragments(true)}if(e.doCanonicalization){Kekule.canonicalizer.canonicalize(b,e.canonicalizerExecutorId||null)}if(e.doAromaticPerception){b.perceiveAromaticRings()}if(e.doStereoPerception){b.perceiveStereos(null,true)}return b}};Object.extend(Kekule.ChemStructureUtils,{compareStructFragment:function(b,f,a){var d=b.clone(false);var c=f.clone(false);d=Kekule.MolStandardizer.standardize(d);c=Kekule.MolStandardizer.standardize(c);var e=Object.create(a||{});e.doStandardize=false;return d.compareStructure(c,e)},isSameStructure:function(b,c,a){return Kekule.ChemStructureUtils.compareStructFragment(b,c,a)===0}});ClassEx.extend(Kekule.ChemObject,{standardize:function(c){var a=Kekule.ChemStructureUtils.getAllStructFragments(this,true);for(var d=0,b=a.length;d<b;++d){a[d].standardize(c)}return this}});ClassEx.extend(Kekule.StructureFragment,{standardize:function(a){return Kekule.MolStandardizer.standardize(this,a)},isSameStructureWith:function(b,a){return Kekule.ChemStructureUtils.isSameStructure(this,b,a)}});ClassEx.extendMethod(Kekule.StructureFragment,"compare",function(c,b,a){if(a.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&(a.doStandardize!==false)&&(b instanceof Kekule.StructureFragment)){return Kekule.ChemStructureUtils.compareStructFragment(this,b,a)}else{return c(b,a)}})})();(function(){var b=Kekule.ArrayUtils;Kekule.globalOptions.add("algorithm.structureSearch",{doStandardize:true});Kekule.ChemStructureSearcher={findSubStructure:function(f,j,d){var k=Object.extend(Object.extend({},Kekule.globalOptions.algorithm.structureSearch),d);if(k.exactMatch){var l=j.isSameStructureWith(f,k);if(l){return[].concat(j.getNodes()).concat(j.getConnectors())}else{return false}}k=Object.extend({level:Kekule.StructureComparationLevel.CONSTITUTION,compareLinkedConnectorCount:false,compareHydrogenCount:false,compareConnectedObjCount:false},k);k=Kekule.ObjComparer.getStructureComparisonDetailOptions(k);var g=k;if(k.doStandardize){var q={unmarshalSubFragments:!true,doCanonicalization:true,doAromaticPerception:true};if(!k.compareStereo){q.doCanonicalization=false}f.standardize(q);j.standardize(q)}var s=j.getFlattenedShadowFragment(true);var c=f.getFlattenedShadowFragment(true);var m=c.getNonHydrogenNodes()[0];var p=s.getNonHydrogenNodes();var o=p.length;var e=0;var r=[];var t=[];var i=false;while(!i&&(e<o)){i=a._compareNode(m,p[e],r,t,g);++e}if(!i){return false}else{var h=b.toUnique(i);var n=j.getFlatternedShadowSourceObjs(h);return n}},_addToComparedObjs:function(d,e,c){e.push(d)},_removeFromComparedObjs:function(e,f,c){var d=f.indexOf(e);f.length=d},_isSameMappedObj:function(h,g,c,f){var e=f.indexOf(g);var d=c.indexOf(h);return(e>=0)&&(e===d)},_compareComparedNeighbors:function(d,c,j,k){if(d.length>c.length){return false}var g=[];for(var h=0,e=d.length;h<e;++h){g.push(j.indexOf(d[h]))}var f=[];for(var h=0,e=c.length;h<e;++h){f.push(k.indexOf(c[h]))}for(var h=0,e=g.length;h<e;++h){if(f.indexOf(g[h])<0){return false}}return true},_compareNode:function(f,n,q,j,u){if(f.compareStructure(n,u)!==0){return false}else{var l=f.getLinkedNonHydrogenConnectors();var d=n.getLinkedNonHydrogenConnectors();var p=l.length;var i=d.length;if(p>i){return false}var e=b.clone(q);var g=b.clone(j);a._addToComparedObjs(f,e,"target");a._addToComparedObjs(n,g,"src");var r=b.intersect(l,e);var s=b.intersect(d,g);var m=true;if(!a._compareComparedNeighbors(r,s,e,g)){m=false}else{l=b.exclude(l,r);d=b.exclude(d,s);if(l.length>d.length){m=false}}var o=[];while(m&&l.length){var k=false;var t=l.shift();var h=0;var c;while(d.length&&!k&&(h<d.length)){c=d[h];k=a._compareConnector(t,c,e,g,u);if(k){o=o.concat(k)}++h}if(!k){m=false;break}else{b.remove(d,c)}}if(m){m=[n].concat(o)}return m}},_compareConnector:function(s,d,q,k,t){if(s.compareStructure(d,t)!==0){return false}else{var i=s.getConnectedObjCount();var e=d.getConnectedObjCount();if(i>e){return false}var f=b.clone(q);var h=b.clone(k);a._addToComparedObjs(s,f,"target");a._addToComparedObjs(d,h,"src");var r=b.clone(s.getConnectedObjs());var u=b.clone(d.getConnectedObjs());var n=b.intersect(r,f);var g=b.intersect(u,h);var o=true;if(!a._compareComparedNeighbors(n,g,f,h)){o=false}else{r=b.exclude(r,n);u=b.exclude(u,g);if(r.length>u.length){o=false}}var p=[];while(o&&r.length){var l=false;var m=r.shift();var j=0;var c;while(u.length&&!l&&(j<u.length)){c=u[j];if(c.getClass()!==m.getClass()){l=false}else{if(c instanceof Kekule.ChemStructureNode){l=a._compareNode(m,c,f,h,t)}else{if(c instanceof Kekule.ChemStructureConnector){l=a._compareConnector(m,c,f,h,t)}else{l=false}}}if(l){p=p.concat(l)}++j}if(!l){o=false;break}else{b.remove(u,c)}}if(o){o=[d].concat(p)}return o}}};var a=Kekule.ChemStructureSearcher;ClassEx.extend(Kekule.StructureFragment,{search:function(d,c){return a.findSubStructure(d,this,c)}})})();(function(){var a=Kekule.ArrayUtils;var b=Kekule.CoordUtils;Kekule.RotationDir={CLOCKWISE:1,ANTICLOCKWISE:-1,UNKNOWN:0};var c=Kekule.RotationDir;Kekule.globalOptions.add("algorithm.stereoPerception",{useFlatternedShadow:true,perceiveStereoConnectors:true,perceiveChiralNodes:true,calcParity:true});Kekule.MolStereoUtils={FISCHER_PROJECTION_BOND_ALLOWED_ERROR:0.08,getDihedralAngleOfNodes:function(o,n,m,l,h,e){if(Kekule.ObjUtils.isUnset(e)){e=true}if(Kekule.ObjUtils.isUnset(h)){if(n.hasCoord3D()){h=Kekule.CoordMode.COORD3D}else{h=Kekule.CoordMode.COORD2D}}var p=function(t,s,x,w,u,A){if(w!==Kekule.CoordMode.COORD2D){return t.getAbsCoordOfMode(w,true)}else{var E=t.getAbsCoordOfMode(w,true);if(s&&x){var v=t.getConnectorTo(s);if(v.getStereo){var C=v.getStereo();var y=Kekule.BondStereo;var D=[y.UP,y.UP_INVERTED,y.DOWN,y.DOWN_INVERTED];if(D.indexOf(C)>=0){var B=v.indexOfConnectedObj(t)-v.indexOfConnectedObj(s);if(B<0){C=y.getInvertedDirection(C)}var z=[1,-1,-1,1];var r=b.getDistance(E,x);E.z=r*z[D.indexOf(C)];console.log(t.getId(),E)}else{if([y.UP_OR_DOWN,y.UP_OR_DOWN_INVERTED].indexOf(C)>=0){return null}}}}E.z=E.z||0;return E}};var d=n.getConnectorTo(m);var k=d&&d.isDoubleBond&&d.isDoubleBond();var i=p(n,null,null,h,e);var g=p(m,null,null,h,e);var j=p(o,n,i,h,e,k);var f=p(l,m,g,h,e,k);if(j&&i&&g&&f){var q=Kekule.GeometryUtils.getDihedralAngleOfPoints(j,i,g,f);return q}else{return -1}},getParityOfNodeSeq:function(j,i,h,g,f,d){var k=Kekule.StereoParity;var e=Kekule.MolStereoUtils.getDihedralAngleOfNodes(j,i,h,g,f,d);var l=(e<0)?k.UNKNOWN:(e<Math.PI*2/5||e>Math.PI*8/5)?k.ODD:(e>Math.PI*3/5&&e<Math.PI*7/5)?k.EVEN:k.UNKNOWN;return l},isStereoBond:function(f){var l=Kekule.ObjUtils.isUnset;if(f.getBelongedRingMinSize){var k=f.getBelongedRingMinSize()||0;if(k>0&&k<=10){return false}}var n=false;var j=f.isDoubleBond&&f.isDoubleBond();if(j&&(f.getConnectedObjCount()===2)){var m=f.getConnectedChemNodes();if(m.length===2){var n=true;for(var h=0;h<2;++h){var e=m[h];var g=e.getHydrogenCount();var d=a.exclude(e.getLinkedChemNodes(),m);if((g>=2)||(!d.length)){n=false;break}if(d.length===1){}else{if(d.length===2){if(l(d[0].getCanonicalizationIndex())&&l(d[1].getCanonicalizationIndex())||(d[0].getCanonicalizationIndex()===d[1].getCanonicalizationIndex())){n=false;break}}}}}}else{n=false}return n},doFindStereoBonds:function(f,j){var d=[];if(!j){Kekule.canonicalizer.canonicalize(f,"morganEx")}for(var g=0,e=f.getConnectorCount();g<e;++g){var h=f.getConnectorAt(g);if(Kekule.MolStereoUtils.isStereoBond(h)){d.push(h)}}return d},getStereoBondKeyNodes:function(f){var n=null;if(f.getConnectedObjCount()===2){var m=f.getConnectedChemNodes();if(m.length===2){var h=[];for(var j=0;j<2;++j){var e=m[j];var g=e.getHydrogenCount();var d=a.exclude(e.getLinkedChemNodes(),m);if(d.length===1){h.push(d[0])}else{if(d.length===2){var l=d[0].getCanonicalizationIndex();var k=d[1].getCanonicalizationIndex();h.push((k>l)?d[1]:d[0])}}}n=[h[0],m[0],m[1],h[1]]}}return n},calcStereoBondParity:function(e,h,g){var i=Kekule.StereoParity;if(!g&&!Kekule.MolStereoUtils.isStereoBond(e)){return i.NONE}if(e.getStereo&&[Kekule.BondStereo.E_OR_Z,Kekule.BondStereo.CIS_OR_TRANS].indexOf(e.getStereo())>=0){return i.NONE}var d=i.UNKNOWN;var f=Kekule.MolStereoUtils.getStereoBondKeyNodes(e);if(f&&f.length){d=Kekule.MolStereoUtils.getParityOfNodeSeq(f[0],f[1],f[2],f[3],h)}return d},doPerceiveStereoConnectors:function(f,h,k){var d=Kekule.MolStereoUtils.doFindStereoBonds(f,k);f.beginUpdate();try{if(d&&d.length){for(var g=0,e=d.length;g<e;++g){var m=d[g];var j=Kekule.MolStereoUtils.calcStereoBondParity(m,h,true);if(m.setParity){m.setParity(j)}}}}finally{f.endUpdate()}return d},isChiralNode:function(g){var v=false;if(g.mayContainElement){var d;var q;var r=null;var e=false;if(g.mayContainElement("C")||g.mayContainElement("Si")){d=4;q=0;r=[0];e=true}else{if(g.mayContainElement("N")){d=4;q=0;e=true}else{if(g.mayContainElement("S")||g.mayContainElement("P")){d=3;q=0;e=true}else{if(g.mayContainElement("B")){d=3;q=0;r=[-1];e=true}}}}if(e){var u=g.getLinkedChemNodes();var t=g.getLinkedMultipleBonds();var j=g.getHydrogenCount?g.getHydrogenCount():0;var p=g.getHydrogenCount?g.getHydrogenCount(true):0;var s=g.getCharge()||0;if(t.length>q||p>=2||u.length+j<d||(r&&r.indexOf(s)<0)){v=false}else{v=true;var m=[];for(var k=0,h=u.length;k<h;++k){var f=u[k];var o=f.getCanonicalizationIndex()||0;if(!m[o]){m[o]=1}else{v=false;break}}}}}return v},doFindChiralNodes:function(f,j){var d=[];if(!j){Kekule.canonicalizer.canonicalize(f,"morganEx")}for(var g=0,e=f.getNodeCount();g<e;++g){var h=f.getNodeAt(g);if(Kekule.MolStereoUtils.isChiralNode(h)){d.push(h)}}return d},calcRotationDirection:function(g,t,n,m,l,k){var s=k?b.substract(g,t):b.substract(t,g);var q,h;var e=null;if(!(s.x===0&&s.y===0)){q=Kekule.GeometryUtils.getVectorCrossProduct(s,{x:0,y:0,z:1});h=Kekule.GeometryUtils.getVectorIncludedAngle(s,{x:0,y:0,z:1});if(s.z<0){h=Math.PI-h}}else{if(s.z<0){q={x:1,y:0,z:0};h=Math.PI}}if(q&&h){e=b.calcRotate3DMatrix({rotateAngle:h,rotateAxisVector:q,center:{x:0,y:0,z:0}})}var r=b.substract(n,g);var p=b.substract(m,g);var o=b.substract(l,g);if(e){r=b.transform3DByMatrix(r,e);p=b.transform3DByMatrix(p,e);o=b.transform3DByMatrix(o,e)}var h=-Math.atan2(r.y,r.x);var e=b.calcTransform2DMatrix({rotateAngle:h,center:{x:0,y:0,z:0}});var f=b.transform2DByMatrix(p,e);var d=b.transform2DByMatrix(o,e);if(f.x===0||d.x===0){return c.UNKNOWN}var j=Math.atan2(f.y,f.x);var i=Math.atan2(d.y,d.x);if(i<0){i=Math.PI*2+i}if(j<0){j=Math.PI*2+j}return(j<i)?c.ANTICLOCKWISE:(j>i)?c.CLOCKWISE:c.UNKNOWN},_getFischerProjectionInfo:function(x,q,k){var f=Object.create(k||null);if(q.length<3||q.length>4){return null}if(q.length===3&&!f.allowExplicitHydrogen){return null}var A=Kekule.CoordMode.COORD2D;var v=f.allowedError||Kekule.MolStereoUtils.FISCHER_PROJECTION_BOND_ALLOWED_ERROR;if(!f.ignoreStructure){var p=(x instanceof Kekule.Atom)&&(x.getAtomicNumber()===6);if(p&&x.getRenderOption){p=x.getRenderOption("nodeDisplayMode")!==Kekule.Render.NodeLabelDisplayMode.SHOWN}if(!p){return null}}var j=x.getAbsCoordOfMode(A,true);var w=[];var h=0;var g=function(i,l,D){if(i[l]){return false}else{i[l]=D;return true}};for(var z=0,y=q.length;z<y;++z){var B=q[z];if(!f.ignoreStructure){var o=B.getConnectorTo(x);var m=o.getStereo()||Kekule.BondStereo.NONE;var u=(o instanceof Kekule.Bond)&&(m===Kekule.BondStereo.NONE);if(!u){return null}}var n=B.getAbsCoordOfMode(A,true);var C=b.substract(n,j);var e=Math.abs(C.x);var d=Math.abs(C.y);if(Kekule.NumUtils.isFloatEqual(e,0)&&Kekule.NumUtils.isFloatEqual(d,0)){return null}var r;var t;if(e>d){t=d/e;r=(C.x>0)?1:3}else{t=e/d;r=(C.y>0)?0:2;++h}if(t>v){return null}else{if(!g(w,r,B)){return null}}}if(h!==2){return null}var s={horizontalSiblings:[w[3],w[1]],verticalSiblings:[w[0],w[2]]};if(!f.reversedDirection){s.towardSiblings=s.horizontalSiblings;s.awaySiblings=s.verticalSiblings}else{s.towardSiblings=s.verticalSiblings;s.awaySiblings=s.horizontalSiblings}return s},calcTetrahedronChiralCenterRotationDirectionEx:function(h,d,k,j){var g=Object.extend({implicitFischerProjection:true,allowExplicitHydrogenInFischer:true},j);var A=g.coordMode;var e=!!g.withImplicitSibling;var w=!!g.refSiblingBehind;var r=!!g.implicitFischerProjection;if(!A){var s=h||d||k[0];if(!s){return c.UNKNOWN}if(s.hasCoord3D()){A=Kekule.CoordMode.COORD3D}else{A=Kekule.CoordMode.COORD2D}}var B=A===Kekule.CoordMode.COORD2D;var p=k.length;var m=p;if(d){++m}if(e){++m}if(m<4){return c.UNKNOWN}var n=function(I,l,M,K,L){if(K!==Kekule.CoordMode.COORD2D){return I.getAbsCoordOfMode(K,true)}else{var S=I.getAbsCoordOfMode(K,true);if(l&&M){var J=I.getConnectorTo(l);if(J.getStereo){var O=J.indexOfConnectedObj(I)-J.indexOfConnectedObj(l);var N=Kekule.BondStereo;var Q=J.getStereo()||N.NONE;if(Q===N.NONE&&L){if(L.towardSiblings.indexOf(I)>=0){Q=(O<0)?N.UP_INVERTED:N.UP}else{if(L.awaySiblings.indexOf(I)>=0){Q=(O<0)?N.DOWN_INVERTED:N.DOWN}}}var R=[N.UP,N.UP_INVERTED,N.DOWN,N.DOWN_INVERTED];if(R.indexOf(Q)>=0){if(O<0){Q=N.getInvertedDirection(Q)}var P=[1,-1,-1,1];var i=b.getDistance(S,M);S.z=i*P[R.indexOf(Q)]}else{if([N.UP_OR_DOWN,N.UP_OR_DOWN_INVERTED].indexOf(Q)>=0){return null}}}}if(!S.z&&I.getZIndex2D){S.z=I.getZIndex2D()}S.z=S.z||0;return S}};var v=h?n(h,null,null,A):null;var o={allowedError:g.fischerAllowedError,reversedDirection:g.reversedFischer,allowExplicitHydrogen:g.allowExplicitHydrogenInFischer};var z=[].concat(k);if(d){Kekule.ArrayUtils.pushUnique(z,d)}var H=(h&&g.implicitFischerProjection)?Kekule.MolStereoUtils._getFischerProjectionInfo(h,z,o):null;var y=[];for(var x=0;x<p;++x){var u=n(k[x],h,v,A,H);y.push(u)}var F=a.clone(y);var C=d?n(d,h,v,A,H):null;if(C){F.push(C)}if(F.indexOf(null)>=0){return c.UNKNOWN}if(!v){var f={};for(var x=0,t=F.length;x<t;++x){f=b.add(F[x],f)}v=b.divide(f,F.length)}var G=0;for(var x=0,t=F.length;x<t;++x){var q=F[x];var E=b.substract(q,v);q.x=E.x;q.y=E.y;q.z=E.z;if(B&&!!E.z){++G}}if(B&&G<=0){return c.UNKNOWN}v={x:0,y:0,z:0};if(e){var f={};for(var x=0,t=F.length;x<t;++x){f=b.add(F[x],f)}var D=b.substract({x:0,y:0,z:0},f);if(!d){C=D}else{y.push(D)}}if(y.length===3&&y.indexOf(null)<0){return Kekule.MolStereoUtils.calcRotationDirection(v,C,y[0],y[1],y[2],w)}else{return c.UNKNOWN}},calcTetrahedronChiralCenterRotationDirection:function(f,e,d,i,g,h){return Kekule.MolStereoUtils.calcTetrahedronChiralCenterRotationDirectionEx(e,d,i,{coordMode:f,withImplicitSibling:g,refSiblingBehind:h})},calcTetrahedronChiralNodeParity:function(e,g,m){var d=Object.create(m||null);if(!g){if(e.hasCoord3D()){g=Kekule.CoordMode.COORD3D}else{g=Kekule.CoordMode.COORD2D}}d.coordMode=g;d.refSiblingBehind=true;var f=Kekule.StereoParity;var j=d.ignoreChiralCheck;if(!j&&!Kekule.MolStereoUtils.isChiralNode(e)){return f.NONE}var k=e.getLinkedChemNodes();var h=e.getHydrogenCount();d.withImplicitSibling=!!h||(k.length<4);k.sort(function(o,n){return -((o.getCanonicalizationIndex()||0)-(n.getCanonicalizationIndex()||0))});var l=d.withImplicitSibling?null:k[3];k=k.slice(0,3);var i=Kekule.MolStereoUtils.calcTetrahedronChiralCenterRotationDirectionEx(e,l,k,d);return(i===c.CLOCKWISE)?f.ODD:(i===c.ANTICLOCKWISE)?f.EVEN:f.UNKNOWN},doPerceiveChiralNodes:function(o,h,d,p){var e=Object.create(p||null);var k=Object.create(e);k.ignoreChiralCheck=true;var q=Kekule.MolStereoUtils.doFindChiralNodes(o,d);o.beginUpdate();try{if(q&&q.length){for(var m=0,g=q.length;m<g;++m){var f=q[m];var j=Kekule.MolStereoUtils.calcTetrahedronChiralNodeParity(f,h,k);if(f.setParity){f.setParity(j)}}}}finally{o.endUpdate()}return q},perceiveStereos:function(q,h,d,r){var e=Object.extend(Object.extend({},Kekule.globalOptions.algorithm.stereoPerception),r);var s;var n=(q instanceof Kekule.StructureConnectionTable)?q.getParent():q;var m;if(e.useFlatternedShadow){m=n.getFlattenedShadowFragment(true)}else{m=n}if(!d){Kekule.canonicalizer.canonicalize(m,"morganEx")}m.beginUpdate();try{var o,k;if(e.perceiveStereoConnectors){if(e.calcParity){o=Kekule.MolStereoUtils.doPerceiveStereoConnectors(m,h,true)}else{o=Kekule.MolStereoUtils.doFindStereoBonds(m,true)}}if(e.perceiveChiralNodes){if(e.calcParity){k=Kekule.MolStereoUtils.doPerceiveChiralNodes(m,h,true,e)}else{k=Kekule.MolStereoUtils.doFindChiralNodes(m,true)}}var g=(k||[]).concat(o||[]);if(e.useFlatternedShadow&&!n.getFlattenedShadowOnSelf()){s=[];n.beginUpdate();try{for(var j=0,f=g.length;j<f;++j){var p=n.getFlatternedShadowSourceObj(g[j]);if(p){if(e.calcParity){p.setParity(g[j].getParity())}s.push(p)}}}finally{n.endUpdate()}}else{s=g}}finally{m.endUpdate()}return s},findStereoConnectors:function(d,e){return Kekule.MolStereoUtils.perceiveStereos(d,null,e,{perceiveStereoConnectors:true,perceiveChiralNodes:false,calcParity:false})},perceiveStereoConnectors:function(d,e,f){return Kekule.MolStereoUtils.perceiveStereos(d,e,f,{perceiveStereoConnectors:true,perceiveChiralNodes:false,calcParity:true})},findChiralNodes:function(d,e){return Kekule.MolStereoUtils.perceiveStereos(d,null,e,{perceiveStereoConnectors:false,perceiveChiralNodes:true,calcParity:false})},perceiveChiralNodes:function(e,g,h,d){var f=Object.create(d||null);f=Object.extend(f,{perceiveStereoConnectors:false,perceiveChiralNodes:true,calcParity:true});return Kekule.MolStereoUtils.perceiveStereos(e,g,h,f)}};Kekule.CanonicalizationMorganExIndexer=Class.create(Kekule.CanonicalizationMorganIndexer,{CLASS_NAME:"Kekule.CanonicalizationMorganExIndexer",doExecute:function($super,g){$super(g);var e=g.getNonHydrogenNodes();var h=this._groupNodesByCanoIndex(e);var f=null;var d=0;f=Kekule.MolStereoUtils.perceiveStereos(g,null,true)||[];while(d<f.length){h=this._regroupSortedNodes(h);this._setCanonicalizationIndexToNodeGroups(h);d=f.length;f=Kekule.MolStereoUtils.perceiveStereos(g,null,true)||[]}},_groupNodesByCanoIndex:function(d){return a.group(d,function(f,e){return(f.getCanonicalizationIndex()||-1)-(e.getCanonicalizationIndex()||-1)})},_regroupSortedNodes:function(h){var d=[];for(var g=0,e=h.length;g<e;++g){var j=h[g];if(!a.isArray(j)){d.push(j)}else{var f=a.group(j,function(l,k){var i=l.compareStructure(k);if(i===0){var n=l.getLinkedConnectors();var m=k.getLinkedConnectors();i=Kekule.ObjComparer.compareStructure(n,m)}return i});d=d.concat(f)}}return d}});Kekule.canonicalizer.registerExecutor("morganEx",[Kekule.CanonicalizationMorganExIndexer,Kekule.CanonicalizationMorganNodeSorter],true);ClassEx.extend(Kekule.StructureFragment,{perceiveChiralNodes:function(e,f,d){return Kekule.MolStereoUtils.perceiveChiralNodes(this,e,f,d)},perceiveStereoConnectors:function(d,e){return Kekule.MolStereoUtils.perceiveStereoConnectors(this,d,e)},perceiveStereos:function(e,f,d){return Kekule.MolStereoUtils.perceiveStereos(this,e,f,d)}})})();