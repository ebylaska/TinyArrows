Kekule.LOCAL_RES=true;Kekule.Localization.setCurrModule("extra.openbabel");Kekule.Localization.addResource("en","ErrorMsg",{OpenBabel:{CHEM_NODE_TYPE_NOT_SUITABLE:"Unsuitable node type",CHEM_CONNECTOR_TYPE_NOT_SUITABLE:"Unsuitable connector type",ONLY_STR_INPUT_DATA_ALLOWED:"Input data must be text",ONLY_STR_OUTPUT_DATA_ALLOWED:"Output data must be text",FAIL_TO_GENERATE_3D_STRUCTURE:"Fail to generate 3D structure coordinates"}});(function(){var c=Kekule.EmscriptenUtils;var b={usingModulaize:true,moduleName:"OpenBabelModule"};Kekule.OpenBabel={_autoEnabled:true,_module:null,SCRIPT_FILE:"openbabel.js",_enableFuncs:[],BondOrder:{SINGLE:1,DOUBLE:2,TRIPLE:3,EXPLICIT_AROMATIC:5},getObInitOptions:function(){return b},getModule:function(){if(!a._module){a._module=c.getRootModule(b.moduleName)}return a._module},getClassCtor:function(d){return c.getClassCtor(d,a.getModule())},isScriptLoaded:function(){return c.isSupported(b.moduleName)},enable:function(d){if(!a.isScriptLoaded()){a.loadObScript(document,function(){a._enableAllFunctions();if(d){d()}})}else{a._enableAllFunctions();if(d){d()}}},_enableAllFunctions:function(){if(a.isScriptLoaded()){var e=a._enableFuncs;for(var f=0,d=e.length;f<d;++f){var g=e[f];if(g){g()}}}}};Kekule._registerAfterLoadProc(function(){if(a._autoEnabled){a._enableAllFunctions()}});Kekule.OpenBabel.getObPath=function(){var e=Kekule.scriptSrcInfo.useMinFile;var d=e?"extra/":"_extras/OpenBabel/";d=Kekule.scriptSrcInfo.path+d;return d};Kekule.OpenBabel.getObScriptUrl=function(){var d=Kekule.OpenBabel.getObPath()+Kekule.OpenBabel.SCRIPT_FILE;var e=Kekule.scriptSrcInfo.useMinFile;if(!e){d+=".dev"}return d};Kekule.OpenBabel.loadObScript=function(e,f){if(!e){e=document}if(!a._obScriptLoadedBySelf&&!a.isScriptLoaded()){var d=Kekule.OpenBabel.getObScriptUrl();c.loadScript(d,f,e);a._obScriptLoadedBySelf=true}else{a._obScriptLoadedBySelf=true;if(f){f()}}};var a=Kekule.OpenBabel;Kekule.OpenBabel.AdaptUtils={DEF_ATOM_ID_PREFIX:"A",DEF_BOND_ID_PREFIX:"B",DEF_MOL_ID_PREFIX:"M",wrapCFuncs:function(){if(!Kekule.OpenBabel._funcInited){var d={};Object.extend(Kekule.OpenBabel,d);Kekule.OpenBabel._funcInited=true}},isAvailable:function(){return typeof(a.getClassCtor("ObBaseHelper"))!=="undefined"},obObjToKekule:function(e){var d=Kekule.OpenBabel.AdaptUtils;var f=Kekule.ObjUtils.getPrototypeOf(e).constructor.name;var g=(f==="OBReaction")?d.obReactionToKekule:(f==="OBMol")?d.obMolToKekule:(f==="OBAtom")?d.obAtomToKekule:(f==="OBBond")?d.obBondToKekule:d.obBaseToKekule;return g(e)},kObjToOB:function(f){var d=Kekule.OpenBabel.AdaptUtils;var e=(f instanceof Kekule.Reaction)?d.kReactionToOB:(f instanceof Kekule.StructureFragment)?d.kMolToOB:(f instanceof Kekule.ChemStructureNode)?d.kChemNodeToOB:(f instanceof Kekule.ChemStructureConnector)?d.kBondToOB:null;if(e){return e(f)}else{return null}},kIdToOB:function(e){var d=parseInt(e,10);if(d){return d}else{return null}},obBondOrderToKekule:function(d){if(d<=3){return d}else{if(d===Kekule.OpenBabel.BondOrder.EXPLICIT_AROMATIC){return Kekule.BondOrder.EXPLICIT_AROMATIC}else{return Kekule.BondOrder.OTHER}}},kBondOrderToOB:function(d){if(d<=3){return d}else{if(d===Kekule.BondOrder.EXPLICIT_AROMATIC){return Kekule.OpenBabel.BondOrder.EXPLICIT_AROMATIC}else{return 0}}},obBaseToKekule:function(n,e){var o=e||new Kekule.ChemObject();var g=new (a.getClassCtor("ObBaseHelper"))(n);var k=g.getTitle();if(k&&o.setName){o.setName(k)}var d=g.getDataSize();if(d){var f=o.getInfo(true);for(var j=0;j<d;++j){var h=g.getDataAt(j);if(h){var m=h.GetAttribute();var l=h.GetValue();if(m&&l){f[m]=l}}}}return o},kChemObjToOB:function(d,n){var o=n||new (a.getClassCtor("OBBase"))();if(d.getName&&o.SetTitle){o.SetTitle(d.getName())}var e=d.getInfo();if(e){var m=Kekule.ObjUtils.getOwnedFieldNames(e);for(var h=0,f=m.length;h<f;++h){var k=m[h];var j=e[k];if(k&&j){var g=new (a.getClassCtor("OBPairData"))();g.SetAttribute(""+k);g.SetValue(""+j);o.SetData(g)}}}},obAtomToKekule:function(i,h,g){var j=i.GetAtomicNum();var f=j?Kekule.Atom:Kekule.SubGroup;if(h&&(!(h instanceof f))){Kekule.Error(Kekule.$L("ErrorMsg.OpenBabel.CHEM_NODE_TYPE_NOT_SUITABLE"))}var d=h||new f();Kekule.OpenBabel.AdaptUtils.obBaseToKekule(i,d);var e;e=i.GetId();if(Kekule.ObjUtils.notUnset(e)){d.setId(Kekule.OpenBabel.AdaptUtils.DEF_ATOM_ID_PREFIX+e)}e=i.GetFormalCharge();if(e){d.setCharge(e)}e=i.GetSpinMultiplicity();if(e){d.setRadical(e)}e={x:i.GetX(),y:i.GetY()};if(g===Kekule.CoordMode.COORD3D){e.z=i.GetZ()}if(d.setAbsCoordOfMode){d.setAbsCoordOfMode(e,g)}else{d.setCoordOfMode(e,g)}if(d instanceof Kekule.Atom){if(j){d.setAtomicNumber(j)}e=i.GetIsotope();if(e){d.setMassNumber(e)}e=i.GetHyb();if(e){d.setHybridizationType(e)}}return d},kChemNodeToOB:function(k,l,h){var d=l||new (a.getClassCtor("OBAtom"))();var e;e=k.getId();e=Kekule.OpenBabel.AdaptUtils.kIdToOB(e);if(Kekule.ObjUtils.notUnset(e)){d.SetId(e)}e=k.getCharge();if(e){if(parseInt(e,10)===parseFloat(e)){d.SetFormalCharge(e)}else{var g=parseInt(e,10);var j=e-g;d.SetFormalCharge(g);d.SetPartialCharge(j)}}e=k.getRadical();if(e){d.SetSpinMultiplicity(e)}e=k.getAbsCoordOfMode?k.getAbsCoordOfMode(h):k.getCoordOfMode(h);d.SetVector(e.x||0,e.y||0,e.z||0);if(k instanceof Kekule.Atom){d.SetAtomicNum(k.getAtomicNumber());e=k.getMassNumber();if(e){d.SetIsotope(e)}e=k.getHybridizationType();if(e){d.SetHyb(e)}}else{d.SetAtomicNum(0)}return d},obBondToKekule:function(k,n,e){var o=n||new Kekule.Bond();Kekule.OpenBabel.AdaptUtils.obBaseToKekule(k,o);var m;m=k.GetId();if(Kekule.ObjUtils.notUnset(m)){o.setId(Kekule.OpenBabel.AdaptUtils.DEF_BOND_ID_PREFIX+m)}m=k.GetBondOrder();o.setBondOrder(Kekule.OpenBabel.AdaptUtils.obBondOrderToKekule(m));var f=Kekule.BondStereo;m=k.IsWedge()?f.UP:k.IsHash()?f.DOWN:k.IsWedgeOrHash()?f.UP_OR_DOWN:k.IsCisOrTrans()?f.CIS_OR_TRANS:k.IsDoubleBondGeometry()?f.E_Z_BY_COORDINATES:f.NONE;o.setStereo(m);if(e){m=null;var h=[k.GetBeginAtom(),k.GetEndAtom()];for(var g=0,d=h.length;g<d;++g){var j=h[g];if(j){m=e.get(j.GetIdx());if(m){o.appendConnectedObj(m)}}}}return o},kBondToOB:function(n,k,f,d){var p=k||new (a.getClassCtor("OBBond"))();Kekule.OpenBabel.AdaptUtils.kChemObjToOB(n,p);var m;m=Kekule.OpenBabel.AdaptUtils.kIdToOB(n.getId());if(Kekule.ObjUtils.notUnset(m)){p.SetId(m)}m=n.getBondOrder();if(m){p.SetBondOrder(Kekule.OpenBabel.AdaptUtils.kBondOrderToOB(m));if(m===Kekule.BondOrder.EXPLICIT_AROMATIC){p.SetAromatic()}}p.UnsetHash();p.UnsetWedge();p.UnsetUp();p.UnsetDown();p.UnsetAromatic();var j=Kekule.BondStereo;m=n.getStereo();if(m===j.UP){p.SetWedge()}else{if(m===j.DOWN){p.SetHash()}else{if(m===j.UP_OR_DOWN){p.SetWedgeOrHash()}}}if(f){var o=0;for(var h=0,e=n.getConnectedObjCount();h<e;++h){var g=n.getConnectedObjAt(h);if(g&&(g instanceof Kekule.ChemStructureNode)){var m=f.get(g);if(m){if(o===0){p.SetBegin(m)}else{if(o===1){p.SetEnd(m)}}++o}if(o>1){break}}}}return p},obMolToKekule:function(d,k){var o=k||new Kekule.Molecule();Kekule.OpenBabel.AdaptUtils.obBaseToKekule(d,o);var f=d.Has3D()?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D;o.clearNodes();o.clearConnectors();var g=new Kekule.MapEx(true);var l=d.NumAtoms();for(var j=0;j<l;++j){var h=d.GetAtom(j+1);if(h){var e=Kekule.OpenBabel.AdaptUtils.obAtomToKekule(h,null,f);if(e){o.appendNode(e);g.set(h.GetIdx(),e)}}}var l=d.NumBonds();for(var j=0;j<l;++j){var m=d.GetBond(j);if(m){var n=Kekule.OpenBabel.AdaptUtils.obBondToKekule(m,null,g);if(n){o.appendConnector(n)}}}g.finalize();g=null;return o},kMolToOB:function(m,d){var g=m.nodesHasCoord3D()?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D;var p=d||new (a.getClassCtor("OBMol"))();if(d){p.Clear()}var h=new Kekule.MapEx(false);for(var k=0,f=m.getNodeCount();k<f;++k){var e=m.getNodeAt(k);if(e){var j=Kekule.OpenBabel.AdaptUtils.kChemNodeToOB(e,p.NewAtom(),g);if(j){h.set(e,j)}}}for(var k=0,f=m.getConnectorCount();k<f;++k){var o=m.getConnectorAt(k);if(o&&(o instanceof Kekule.Bond)){var n=Kekule.OpenBabel.AdaptUtils.kBondToOB(o,p.NewBond(),h,p)}}h.finalize();h=null;return p},obReactionToKekule:function(k,h){var d=h||new Kekule.Reaction();d.clearAll();Kekule.OpenBabel.AdaptUtils.obBaseToKekule(k,d);d.setDirection(k.IsReversible()?Kekule.ReactionDirection.BIDIRECTION:Kekule.ReactionDirection.FORWARD);for(var j=0,g=k.NumReactants();j<g;++j){var f=k.GetReactant(j);var e=Kekule.OpenBabel.AdaptUtils.obMolToKekule(f);d.appendReactant(e)}for(var j=0,g=k.NumProducts();j<g;++j){var f=k.GetProduct(j);var e=Kekule.OpenBabel.AdaptUtils.obMolToKekule(f);d.appendProduct(e)}return d},kReactionToOB:function(k,f){var n=f||new (a.getClassCtor("OBReaction"))();n.Clear();Kekule.OpenBabel.AdaptUtils.kChemObjToOB(k,n);var d=false;var m=k.getDirection();if(m===Kekule.ReactionDirection.BIDIRECTION){n.SetReversible(true)}else{if(m===Kekule.ReactionDirection.BACKWARD){d=true}}for(var h=0,g=k.getReactantCount();h<g;++h){var j=k.getReactantAt(h);if(j){var e=Kekule.OpenBabel.AdaptUtils.kMolToOB(j);if(d){n.AddProduct(e)}else{n.AddReactant(e)}}}for(var h=0,g=k.getProductCount();h<g;++h){var j=k.getProductAt(h);if(j){var e=Kekule.OpenBabel.AdaptUtils.kMolToOB(j);if(d){n.AddReactant(e)}else{n.AddProduct(e)}}}}}})();(function(){var c=Kekule.EmscriptenUtils;var b=Kekule.OpenBabel;var a=Kekule.OpenBabel.AdaptUtils;Kekule.IO.OpenBabelReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.OpenBabelReader",initialize:function($super,d){$super()},finalize:function($super){$super()},getFormatTargetObClassName:function(d){var f=d.getTypeName();var e=(f.toLowerCase().indexOf("reaction")>=0);return e?"OBReaction":"OBMol"},doReadData:function(k,n,o){this._obConv=new (b.getClassCtor("ObConversionWrapper"))();try{var m=Kekule.IO.DataFormatsManager.getFormatInfo(o);var d=m.mimeType;var r=m.fileExts[0];var f=this._obConv.setInFormat(d,r);var h=this.getFormatTargetObClassName(f);try{var l=[];this._obConv.setInStr(k);var g=new (b.getClassCtor(h))();var p=this._obConv.readFromInput(g);while(p){if(g.NumAtoms&&(g.NumAtoms()>0)){kObj=a.obObjToKekule(g);l.push(kObj)}p=this._obConv.readFromInput(g)}var e=l.length;if(e<=0){return null}else{if(e===1){return l[0]}else{var q=new Kekule.ChemObjList();for(var j=0;j<e;++j){q.append(l[j])}return q}}}finally{if(g){g["delete"]();g=null}}}finally{if(this._obConv){this._obConv["delete"]();this._obConv=null}}}});Kekule.IO.OpenBabelWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.OpenBabelWriter",initialize:function($super,d){$super(d)},finalize:function($super){$super()},doWriteData:function(g,n,o){this._obConv=new (b.getClassCtor("ObConversionWrapper"))();try{var m=Kekule.IO.DataFormatsManager.getFormatInfo(o);var d=m.mimeType;var r=m.fileExts[0];this._obConv.setOutFormat(d,r);var j=Kekule.ChemStructureUtils.getChildStructureObjs(g,true);for(var h=0,f=j.length;h<f;++h){var k=j[h];if(k){var e=a.kObjToOB(k);if(e){try{var p=this._obConv.writeToOutput(e);if(!p){break}}finally{e["delete"]();e=null}}}}var q=this._obConv.getOutStr();return q}finally{if(this._obConv){this._obConv["delete"]()}}},isAllowedObj:function(d){var e=Kekule.IO.OpenBabelWriter.ALLOWED_CLASSES;return Kekule.ObjUtils.isInstanceOf(d,e)}});Kekule.IO.OpenBabelWriter.ALLOWED_CLASSES=[Kekule.StructureFragment,Kekule.Reaction,Kekule.ChemObjList,Kekule.ChemStructureObjectGroup,Kekule.ChemSpaceElement,Kekule.ChemSpace];Kekule.OpenBabel.IORegHelper=Class.create({listFormatInfo:function(n,j){var r=[];var d="\n";var g="--";var k;if(n==="in"){k=j.getSupportedInputFormatsStr(d)}else{k=j.getSupportedOutputFormatsStr(d)}var o=k.split(d);for(var m=0,h=o.length;m<h;++m){var q=o[m];var p=q.indexOf(g);if(p>0){var e=q.substring(0,p).trim();var f=j.getFormatInfoById(e);r.push(f)}}return r},registerByInfos:function(q,p){var o=Kekule.IO.DataFormatsManager;var m=[];for(var n=0,j=q.length;n<j;++n){var h=q[n];var e=h.id;var d=h.mimeType;var f=o.findFormatId(d);if(f){f=o.findFormatId(null,e)}if(!f){var g=o.register(e,d,e,Kekule.IO.ChemDataType.UNKNOWN,h.description,h.description,{specificationUrl:h.specificationURL});var f=g.id}var k=(p==="in")?Kekule.IO.ChemDataReaderManager.getReaderInfoByFormat(f):Kekule.IO.ChemDataWriterManager.getWriterInfoByFormat(f);if(!k){Kekule.ArrayUtils.pushUnique(m,f)}}if(m.length){if(p==="in"){Kekule.IO.ChemDataReaderManager.register("openbabel",Kekule.IO.OpenBabelReader,m)}else{Kekule.IO.ChemDataWriterManager.register("openbabel",Kekule.IO.OpenBabelWriter,Kekule.IO.OpenBabelWriter.ALLOWED_CLASSES,m)}}},registerAll:function(){var d=new (b.getClassCtor("ObConversionWrapper"))();try{var e=this.listFormatInfo("in",d);this.registerByInfos(e,"in");var e=this.listFormatInfo("out",d);this.registerByInfos(e,"out")}finally{d["delete"]()}}});Kekule.IO.registerAllOpenBabelFormats=function(){if(Kekule.OpenBabel.AdaptUtils.isAvailable()){try{var d=new Kekule.OpenBabel.IORegHelper();d.registerAll()}finally{d=null}}};Kekule.OpenBabel._enableFuncs.push(Kekule.IO.registerAllOpenBabelFormats);Kekule.IO.enableOpenBabelFormats=function(){if(!Kekule.OpenBabel.AdaptUtils.isAvailable()){Kekule.OpenBabel.loadObScript(document,function(){Kekule.IO.registerAllOpenBabelFormats()})}else{Kekule.IO.registerAllOpenBabelFormats()}};(function(){})()})();(function(){var c=Kekule.EmscriptenUtils;var b=Kekule.OpenBabel;var a=Kekule.OpenBabel.AdaptUtils;Kekule.OpenBabel.StructUtils={generate3DStructure:function(g,f){var h=new (b.getClassCtor("OB3DGenWrapper"))();try{var e=Kekule.IO.saveMimeData(g,"chemical/x-mdl-molfile");try{var d=h.generate3DStructureFromMolData(e,f||"");if(!d){Kekule.raise(Kekule.$L("ErrorMsg.OpenBabel.FAIL_TO_GENERATE_3D_STRUCTURE"))}else{var i=a.obObjToKekule(d)}d["delete"]()}finally{}}finally{h["delete"]()}return i}};if(Kekule.Calculator){Kekule.Calculator.ObStructure3DGenerator=Class.create(Kekule.Calculator.AbstractStructure3DGenerator,{CLASS_NAME:"Kekule.Calculator.ObStructure3DGenerator",getObInitOptions:function(){return Kekule.OpenBabel.getObInitOptions()},getForceField:function(){return this.getOptions().forceField},createWorker:function($super){var d=$super();if(d){var e=Kekule.OpenBabel.getObScriptUrl();this.importWorkerScriptFile(e);var f=this.getObInitOptions();this.postWorkerMessage({type:"obInit",usingModulaize:f.usingModulaize,moduleName:f.moduleName})}return d},getWorkerScriptFile:function(){var d=Kekule.OpenBabel.getObPath()+"workers/kekule.worker.obStructure3DGenerator.js";return d},doReactWorkerMessage:function(f,h){if(f.type==="output3D"){var g=f.molData;if(g){var d=Kekule.IO.loadMimeData(g,"chemical/x-mdl-molfile");this.setGeneratedMol(d);this.done()}}},workerStartCalc:function(f){var e=this.getSourceMol();var d=Kekule.IO.saveMimeData(e,"chemical/x-mdl-molfile");this.postWorkerMessage({type:"gen3D",molData:d,forceField:this.getForceField()})},executeSync:function(e){if(Kekule.OpenBabel&&document){var d=this;Kekule.OpenBabel.loadObScript(document,function(){var f;try{var g=Kekule.OpenBabel.StructUtils.generate3DStructure(d.getSourceMol(),d.getForceField());d.setGeneratedMol(g)}catch(h){f=h}if(e){e(f)}})}else{Kekule.error(Kekule.$L("ErrorMsg.MODULE_NOT_LOADED").format("OpenBabel"))}return false}});Kekule.Calculator.ServiceManager.register(Kekule.Calculator.Services.GEN3D,Kekule.Calculator.ObStructure3DGenerator)}})();