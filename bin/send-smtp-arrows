#!/usr/bin/python -tt

from email.mime.text import MIMEText
from datetime import date
import smtplib,time

#SMTP_SERVER = "emailgw.pnl.gov"
#SMTP_SERVER = "mailhost.emsl.pnl.gov"
#SMTP_PORT = 25

#EMAIL_TO = ["eric.bylaska@pnnl.gov", "ebylaska@charter.net", "bylaska@gmail.com"]
#EMAIL_FROM = "eric.bylaska@pnnl.gov"
#EMAIL_SUBJECT = "Demo Email2 : "

DATE_FORMAT = "%d/%m/%Y"
EMAIL_SPACE = ", "

#DATA='This is the content of the email.'

def send_email(SMTP_SERVER,EMAIL_FROM,EMAIL_TO,EMAIL_CC,EMAIL_SUBJECT,DATA,is_html):
    if (is_html):
       msg = MIMEText(DATA,'html')
    else:
       msg = MIMEText(DATA,'plain')
   
    msg['Subject'] = EMAIL_SUBJECT + " - %s" % (time.strftime('%Y-%m-%d %H:%M'))
    msg['To'] = EMAIL_SPACE.join(EMAIL_TO)
    if (len(EMAIL_CC)>0):
       msg['cc'] = EMAIL_SPACE.join(EMAIL_CC)
    msg['From'] = EMAIL_FROM
    #mail = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
    mail = smtplib.SMTP(SMTP_SERVER)
    mail.sendmail(EMAIL_FROM, EMAIL_TO+EMAIL_CC, msg.as_string())
    mail.quit()

def main():
   import sys
   import getopt

   usage = \
   """
   This program uses smtp server to send an ascii datafile thru the email.

   Usage: send-smtp -n number -m emaillist -c ccemaillist -j subject -s smtp_server -t  datafile

  -n queue number
  -m string containing list of email addresses
  -c string containing list of cc email addresses
  -j subject for email
  -s smtp_server
  -t assume datafile is html
  -h prints this message


   where emailto is a string of email addresses and datafile

   """

   print 'Send an email using emsl smtp server'
   tt      = time.localtime()
   dd = "-%d-%d-%d-%d:%d" % (tt[0],tt[1],tt[2],tt[3],tt[4])

   EMAIL_TO = ["eric.bylaska@pnnl.gov", "bylaska@gmail.com"]
   #EMAIL_FROM = "eric.bylaska@pnnl.gov"
   EMAIL_FROM = "arrows@emsl.pnnl.gov"
   EMAIL_SUBJECT = "NWCHEM RESULT EMAIL: -1"
   SMTP_SERVER = "mailhost.emsl.pnl.gov:25"
   EMAIL_CC = []

   is_html = False
   filesubject = True
   opts, args = getopt.getopt(sys.argv[1:], "n:m:c:s:j:th")
   for o, a in opts:
      if '-n' in o:
         qnum = eval(a)
         EMAIL_SUBJECT = "NWCHEM RESULT EMAIL: %d" % qnum
      if '-m' in o:
         EMAIL_TO = a.split()
      if '-c' in o:
         EMAIL_CC = a.split()
      if '-s' in o:
         SMTP_SERVER = a
      if '-j' in o:
         EMAIL_SUBJECT = a
         filesubject = False
      if '-t' in o:
         is_html = True
      if o in ("-h","--help"):
         print usage
         exit()
   if len(args) < 1:
     print usage
     return

   filename = args[0]
   if is_html:
      ofile = open(filename,'rb')
   else:
      ofile = open(filename,'r')
   DATA = ofile.read()
   ofile.close()
   if (filesubject):
      EMAIL_SUBJECT += " : " + filename

   print
   print "From: "+EMAIL_FROM
   tostr = ''
   for e in EMAIL_TO:
      tostr += e + ' '
   print "To: " + tostr
   ccstr = ''
   for e in EMAIL_CC:
      ccstr += e + ' '
   print "cc: " + ccstr
   print "Subject: " + EMAIL_SUBJECT
   if is_html:
      print "HTML  Datafile: " + filename
   else:
      print "ASCII Datafile: " + filename
   print

   #send_email(DATA)
   send_email(SMTP_SERVER,EMAIL_FROM,EMAIL_TO,EMAIL_CC,EMAIL_SUBJECT,DATA,is_html)

if __name__=='__main__':
   
    main()
